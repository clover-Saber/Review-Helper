<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文献查询 - 文献综述生成工具</title>
    <link rel="stylesheet" href="search.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>文献查询</h1>
            <p>根据研究主题搜索相关文献</p>
        </header>
        
        <main>
            <section class="project-section">
                <h3>项目管理</h3>
                <div class="project-controls">
                    <div class="input-group">
                        <div id="current-project-display">当前项目：<span id="current-project-name">未选择</span></div>
                        <button id="save-project-btn">保存到项目</button>
                    </div>
                </div>
            </section>
            
            <section class="search-controls">
                <div class="api-key-section">
                    <label for="api-key">DeepSeek API Key:</label>
                    <input type="password" id="api-key" placeholder="请输入您的DeepSeek API Key">
                </div>
                <div class="api-key-section">
                    <label>搜索偏好：</label>
                    <div class="input-group">
                        <input type="number" id="pref-keyword-count" placeholder="关键词数量(默认6)" min="1" style="max-width: 200px;">
                        <input type="number" id="pref-max-per-keyword" placeholder="每关键词文献数(默认10)" min="1" max="19" style="max-width: 200px;">
                        <input type="number" id="pref-start-year" placeholder="起始年份(可选)" min="1900" style="max-width: 200px;">
                        <input type="number" id="pref-min-citations" placeholder="最低引用数(可选)" min="0" style="max-width: 200px;">
                    </div>
                </div>

                <div class="step-section">
                    <h3>综述主题输入</h3>
                    <div class="input-group">
                        <textarea id="topic-display" placeholder="例如：写一个和共享自动驾驶汽车以及mass系统相关的综述"></textarea>
                        <button id="extract-keywords-btn">分析关键词</button>
                    </div>
                </div>

                <div class="keywords-section" id="keywords-section" style="display: none;">
                    <h3>关键词列表（可编辑）</h3>
                    <div class="keywords-container" id="keywords-container"></div>
                    <button id="search-literature-btn">确认关键词并开始搜索</button>
                </div>

                <div class="search-progress" id="search-progress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="search-progress-fill"></div>
                    </div>
                    <p id="search-progress-text">准备开始搜索...</p>
                </div>
            </section>
            
            <!-- 移除按关键词分页结果，仅展示合并后的最终结果 -->
            
            <section class="final-results-section" id="final-results-section" style="display: none;">
                <h2>最终文献列表</h2>
                <div class="final-results-info">
                    <p>共找到 <span id="final-count">0</span> 篇不重复文献</p>
                </div>
                <div class="final-results-container" id="final-results-container">
                    <div class="empty-state">
                        <p>暂无文献</p>
                    </div>
                </div>
                <div class="results-actions" style="margin-top:10px;">
                    <button id="export-excel-btn">导出Excel</button>
                </div>
            </section>
        </main>
        
        <footer>
            <div class="footer-controls">
                <button id="back-btn">返回主页面</button>
                <button id="confirm-btn" disabled>确认完成</button>
            </div>
        </footer>
        
        <!-- Toast通知 -->
        <div id="toast" class="toast" style="display: none;">
            <div class="toast-content">
                <span class="toast-message" id="toast-message"></span>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM元素
            const currentProjectNameSpan = document.getElementById('current-project-name');
            const saveProjectBtn = document.getElementById('save-project-btn');
            const apiKeyInput = document.getElementById('api-key');
            const prefKeywordCountInput = document.getElementById('pref-keyword-count');
            const prefMaxPerKeywordInput = document.getElementById('pref-max-per-keyword');
            const prefStartYearInput = document.getElementById('pref-start-year');
            const prefMinCitationsInput = document.getElementById('pref-min-citations');
            const topicDisplay = document.getElementById('topic-display');
            const extractKeywordsBtn = document.getElementById('extract-keywords-btn');
            const keywordsSection = document.getElementById('keywords-section');
            const keywordsContainer = document.getElementById('keywords-container');
            const searchLiteratureBtn = document.getElementById('search-literature-btn');
            const searchProgress = document.getElementById('search-progress');
            const searchProgressFill = document.getElementById('search-progress-fill');
            const searchProgressText = document.getElementById('search-progress-text');
            // 已移除分关键词结果展示
            const finalResultsSection = document.getElementById('final-results-section');
            const finalResultsContainer = document.getElementById('final-results-container');
            const finalCount = document.getElementById('final-count');
            const confirmBtn = document.getElementById('confirm-btn');
            const backBtn = document.getElementById('back-btn');
            // 分页与选择控件已移除
            
            // 数据存储
            let currentProject = null;
            let keywords = [];
            let searchResults = {}; // 每个关键词的搜索结果
            let allLiterature = []; // 去重后的所有文献
            
            // 初始化当前项目信息并加载数据
            initCurrentProject();
            async function initCurrentProject() {
                if (!window.electronAPI) return;
                try {
                    const { success, currentProject: cp } = await window.electronAPI.getCurrentProject();
                    if (success && cp) {
                        currentProject = cp;
                        currentProjectNameSpan.textContent = cp;
                        // 加载项目数据
                        const result = await window.electronAPI.loadProjectData(cp);
                        if (result.success && result.data) {
                            loadProjectData(result.data);
                            // 加载项目简介到输入框（如果存在）
                            const projectDescription = result.data.projectDescription || result.data.reviewDescription || result.data.userNeeds || result.data.researchTopic || '';
                            if (topicDisplay && projectDescription) {
                                topicDisplay.value = projectDescription;
                            }
                        }
                    } else {
                        showToast('未选择项目，请在主页面先新建或打开项目', 'error');
                    }
                } catch (e) {
                    console.error('获取当前项目失败:', e);
                }
            }
            
            // 显示Toast通知
            function showToast(message, type = 'success') {
                const toast = document.getElementById('toast');
                const toastMessage = document.getElementById('toast-message');
                
                if (!toast || !toastMessage) return;
                
                // 设置消息
                toastMessage.textContent = message;
                
                // 根据类型设置样式
                if (type === 'success') {
                    toast.style.background = 'linear-gradient(135deg, var(--success-color) 0%, #059669 100%)';
                } else if (type === 'error') {
                    toast.style.background = 'linear-gradient(135deg, var(--error-color) 0%, #dc2626 100%)';
                }
                
                // 显示toast
                toast.style.display = 'block';
                toast.style.opacity = '0';
                
                // 触发动画
                setTimeout(() => {
                    toast.style.opacity = '1';
                }, 10);
                
                // 3秒后自动隐藏
                setTimeout(() => {
                    toast.style.opacity = '0';
                    setTimeout(() => {
                        toast.style.display = 'none';
                    }, 300);
                }, 3000);
            }
            
            // 保存项目（合并保存，避免覆盖旧字段）
            saveProjectBtn.addEventListener('click', async function() {
                const projectName = currentProject;
                if (!projectName) {
                    showToast('未绑定项目，请返回主页面选择项目', 'error');
                    return;
                }
                
                const projectData = getModule1Patch();
                if (window.electronAPI) {
                    try {
                        await mergeAndSave(projectName, projectData);
                        showToast(`项目 "${projectName}" 保存成功`);
                    } catch (error) {
                        console.error('保存项目失败:', error);
                        showToast('保存项目失败: ' + error.message, 'error');
                    }
                }
            });
            
            // 获取项目数据
            function getModule1Patch() {
                // 从输入框获取综述主题
                const projectDescription = (topicDisplay && topicDisplay.value) ? topicDisplay.value.trim() : '';
                
                return {
                    projectDescription: projectDescription,
                    config: {
                        apiKey: apiKeyInput.value,
                        searchPreferences: {
                            keywordCount: Number(prefKeywordCountInput.value) || 6,
                            maxPerKeyword: Number(prefMaxPerKeywordInput.value) || 10,
                            startYear: prefStartYearInput.value || '',
                            minCitations: prefMinCitationsInput.value ? Number(prefMinCitationsInput.value) : ''
                        }
                    },
                    keywords: keywords,
                    search: {
                        results: searchResults
                    },
                    finalResults: allLiterature,
                    timestamp: new Date().toISOString()
                };
            }

            // 深合并保存，避免覆盖旧字段
            async function mergeAndSave(projectName, patch) {
                const existing = await window.electronAPI.loadProjectData(projectName);
                const base = (existing && existing.success && existing.data) ? existing.data : {};
                const merged = deepMerge(base, patch || {});
                return await window.electronAPI.saveProjectData(projectName, merged);
            }

            function deepMerge(target, source) {
                if (!source || typeof source !== 'object') return target;
                const out = Array.isArray(target) ? [...target] : { ...target };
                Object.keys(source).forEach(key => {
                    const srcVal = source[key];
                    const tgtVal = out[key];
                    if (srcVal && typeof srcVal === 'object' && !Array.isArray(srcVal)) {
                        out[key] = deepMerge(tgtVal && typeof tgtVal === 'object' ? tgtVal : {}, srcVal);
                    } else {
                        out[key] = srcVal;
                    }
                });
                return out;
            }
            
            // 加载项目数据
            function loadProjectData(data) {
                // 加载项目简介到输入框
                const projectDescription = data.projectDescription || data.reviewDescription || data.userNeeds || data.researchTopic || '';
                if (topicDisplay && projectDescription) {
                    topicDisplay.value = projectDescription;
                }
                
                apiKeyInput.value = (data.config && data.config.apiKey) || data.apiKey || '';
                const prefs = (data.config && data.config.searchPreferences) || {};
                prefKeywordCountInput.value = prefs.keywordCount || '';
                prefMaxPerKeywordInput.value = prefs.maxPerKeyword || '';
                prefStartYearInput.value = prefs.startYear || '';
                prefMinCitationsInput.value = prefs.minCitations || '';
                keywords = data.keywords || [];
                searchResults = (data.search && data.search.results) || data.searchResults || {};
                allLiterature = data.finalResults || data.allLiterature || [];
                
                if (keywords.length > 0) {
                    displayKeywords();
                    keywordsSection.style.display = 'block';
                }
                
                // 已移除分关键词结果展示
                
                if (allLiterature.length > 0) {
                    finalResultsSection.style.display = 'block';
                    finalCount.textContent = allLiterature.length;
                    displayFinalResults();
                }
                
                updateConfirmButton();
            }
            
            // 不再从主进程获取研究主题，改为从项目数据中读取
            
            // 提取关键词
            extractKeywordsBtn.addEventListener('click', async function() {
                // 从输入框获取综述主题
                const topic = (topicDisplay && topicDisplay.value) ? topicDisplay.value.trim() : '';
                const apiKey = apiKeyInput.value.trim();
                
                if (!apiKey) {
                    showToast('请输入DeepSeek API Key', 'error');
                    return;
                }
                
                if (!topic) {
                    showToast('请输入综述主题', 'error');
                    return;
                }
                
                try {
                    // 调用DeepSeek API提取关键词
                    const extractedKeywords = await extractKeywords(topic, apiKey);
                    const desiredCount = Number(prefKeywordCountInput.value) || 6;
                    keywords = extractedKeywords.slice(0, desiredCount);
                    displayKeywords();
                    keywordsSection.style.display = 'block';
                    // 参数生效：自动保存到项目
                    await autoSaveConfig();
                } catch (error) {
                    console.error('提取关键词失败:', error);
                    showToast('提取关键词失败: ' + error.message, 'error');
                }
            });
            
            // 显示关键词
            function displayKeywords() {
                keywordsContainer.innerHTML = '';
                keywords.forEach((keyword, index) => {
                    const keywordElement = document.createElement('div');
                    keywordElement.className = 'keyword-item';
                    keywordElement.innerHTML = `
                        <input type="text" class="keyword-input" value="${keyword}" data-index="${index}">
                        <button class="remove-keyword-btn" data-index="${index}">删除</button>
                    `;
                    keywordsContainer.appendChild(keywordElement);
                });
                
                // 添加新的关键词输入框
                const addKeywordElement = document.createElement('div');
                addKeywordElement.className = 'keyword-item';
                addKeywordElement.innerHTML = `
                    <input type="text" class="keyword-input new-keyword" placeholder="添加新关键词">
                    <button class="add-keyword-btn">添加</button>
                `;
                keywordsContainer.appendChild(addKeywordElement);
                
                // 绑定事件
                document.querySelectorAll('.keyword-input').forEach(input => {
                    input.addEventListener('blur', updateKeyword);
                });
                
                document.querySelectorAll('.remove-keyword-btn').forEach(btn => {
                    btn.addEventListener('click', removeKeyword);
                });
                
                document.querySelector('.add-keyword-btn').addEventListener('click', addKeyword);
            }
            
            // 更新关键词
            function updateKeyword(event) {
                const index = event.target.getAttribute('data-index');
                if (index !== null) {
                    keywords[parseInt(index)] = event.target.value;
                }
                // 保存关键词更改
                autoSaveConfig();
            }
            
            // 删除关键词
            function removeKeyword(event) {
                const index = parseInt(event.target.getAttribute('data-index'));
                keywords.splice(index, 1);
                displayKeywords();
                // 保存关键词更改
                autoSaveConfig();
            }
            
            // 添加关键词
            function addKeyword() {
                const newKeywordInput = document.querySelector('.new-keyword');
                const newKeyword = newKeywordInput.value.trim();
                if (newKeyword) {
                    keywords.push(newKeyword);
                    displayKeywords();
                    newKeywordInput.value = '';
                    // 保存关键词更改
                    autoSaveConfig();
                }
            }
            
            // 开始搜索文献
            searchLiteratureBtn.addEventListener('click', async function() {
                const apiKey = apiKeyInput.value.trim();
                
                if (!apiKey) {
                    showToast('请输入DeepSeek API Key', 'error');
                    return;
                }
                
                if (keywords.length === 0) {
                    showToast('请先提取或添加关键词', 'error');
                    return;
                }
                
                // 先打开登录/验证窗口
                try {
                    if (window.electronAPI && window.electronAPI.openScholarLogin) {
                        await window.electronAPI.openScholarLogin();
                        console.log('登录/验证完成，开始搜索');
                    }
                } catch (loginError) {
                    console.error('登录/验证失败:', loginError);
                    showToast('登录/验证失败: ' + loginError.message + '，搜索已取消', 'error');
                    return;
                }
                
                // 显示进度条
                searchProgress.style.display = 'block';
                // 不展示分关键词结果
                
                try {
                    // 循环搜索每个关键词
                    let totalFound = 0; // 累计找到的结果数
                    for (let i = 0; i < keywords.length; i++) {
                        const keyword = keywords[i];
                        const currentProgress = ((i) / keywords.length) * 100;
                        updateProgress(currentProgress, `正在搜索: ${keyword} (${i + 1}/${keywords.length})`);
                        
                        // 搜索文献
                        const perCount = Number(prefMaxPerKeywordInput.value) || 10;
                        const minYear = Number(prefStartYearInput.value) || null;
                        const minCitations = prefMinCitationsInput.value ? Number(prefMinCitationsInput.value) : null;
                        let results = await searchGoogleScholar(keyword, perCount);
                        console.log(`关键词 "${keyword}" 搜索返回 ${results ? results.length : 0} 条结果`);
                        
                        // 过滤年份与引用数
                        const beforeFilter = results.length;
                        results = results.filter(item => {
                            if (!item) return false;
                            const y = Number(item.year);
                            const c = Number(item.cited || 0);
                            const passYear = minYear ? (y >= minYear) : true;
                            const passCite = (minCitations !== null) ? (c >= minCitations) : true;
                            return passYear && passCite;
                        });
                        console.log(`关键词 "${keyword}" 过滤后剩余 ${results.length} 条结果 (过滤前: ${beforeFilter})`);
                        
                        searchResults[keyword] = results || [];
                        totalFound += results.length;
                        console.log(`已保存关键词 "${keyword}" 的结果到 searchResults`);
                        
                        // 更新进度：显示已完成的关键词和找到的结果数
                        const completedProgress = ((i + 1) / keywords.length) * 100;
                        const completedCount = i + 1;
                        const resultCount = results.length;
                        updateProgress(
                            completedProgress, 
                            `已完成: ${keyword} ✓ (找到${resultCount}条) | 进度: ${completedCount}/${keywords.length} | 累计: ${totalFound}条`
                        );
                        
                        // 等待一小段时间避免请求过于频繁，同时让用户看到进度提示
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    }
                    
                    // 搜索完成
                    updateProgress(100, `搜索完成！共完成 ${keywords.length} 个关键词，累计找到 ${totalFound} 条结果`);
                    setTimeout(() => {
                        searchProgress.style.display = 'none';
                    }, 10000);
                    
                    // 合并去重并展示
                    console.log('搜索完成，开始合并结果...');
                    console.log('searchResults 对象:', searchResults);
                    console.log('searchResults 的键:', Object.keys(searchResults));
                    console.log('每个关键词的结果数量:');
                    Object.keys(searchResults).forEach(key => {
                        console.log(`  "${key}": ${Array.isArray(searchResults[key]) ? searchResults[key].length : '不是数组'}`);
                    });
                    
                    consolidateAllResults();
                    console.log('合并后的 allLiterature:', allLiterature);
                    console.log('allLiterature 长度:', allLiterature.length);
                    
                    // 强制显示结果区域
                    if (finalResultsSection) {
                        finalResultsSection.style.display = 'block';
                        console.log('finalResultsSection 已显示');
                    } else {
                        console.error('finalResultsSection 不存在！');
                    }
                    
                    updateConfirmButton();
                    
                    // 如果结果为空，给用户提示
                    if (allLiterature.length === 0) {
                        console.warn('警告：合并后没有找到任何文献！');
                        showToast('搜索完成，但没有找到符合条件的文献', 'error');
                    } else {
                        console.log(`成功找到 ${allLiterature.length} 篇文献`);
                    }
                    
                    // 更新状态为 module1
                    await setStatus('module1');
                    // 持久化搜索结果与总表
                    await autoSaveConfig();
                    
                } catch (error) {
                    console.error('搜索文献失败:', error);
                    searchProgress.style.display = 'none';
                    showToast('搜索文献失败: ' + error.message, 'error');
                }
            });
            
            // 已移除分关键词结果与选择逻辑
            
            // 更新进度条
            function updateProgress(percent, text) {
                searchProgressFill.style.width = `${percent}%`;
                searchProgressText.textContent = text;
            }

            // 参数变更自动保存
            [apiKeyInput, prefKeywordCountInput, prefMaxPerKeywordInput, prefStartYearInput, prefMinCitationsInput].forEach(el => {
                el.addEventListener('change', autoSaveConfig);
                el.addEventListener('blur', autoSaveConfig);
            });

            async function autoSaveConfig() {
                if (!currentProject) return;
                const data = getModule1Patch();
                try {
                    await mergeAndSave(currentProject, data);
                } catch (e) {
                    console.error('自动保存失败', e);
                }
            }

            // 搜索开始前重置步骤状态（允许回滚）
            async function setStatus(status) {
                if (!currentProject) return;
                try {
                    const data = getModule1Patch();
                    data.status = status;
                    await mergeAndSave(currentProject, data);
                } catch(e) {
                    console.error('更新步骤失败', e);
                }
            }
            
            // 使用DeepSeek API提取关键词
            async function extractKeywords(topic, apiKey) {
                const response = await fetch('https://api.deepseek.com/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [
                            {
                                "role": "system",
                                "content": "你是一个学术研究助手。请根据用户提供的研究主题，提取5-8个最相关的英文关键词，用于学术文献搜索。只需要输出关键词，每个关键词一行，不要有其他内容。"
                            },
                            {
                                "role": "user",
                                "content": `请为以下研究主题提取关键词: ${topic}`
                            }
                        ],
                        stream: false
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API请求失败: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                const keywordsText = data.choices[0].message.content;
                return keywordsText.split('\n').filter(keyword => keyword.trim() !== '');
            }
            
            // 搜索Google Scholar（真实实现，通过IPC调用主进程）
            async function searchGoogleScholar(keyword, limit = 3) {
                if (!window.electronAPI || !window.electronAPI.searchGoogleScholar) {
                    throw new Error('Google Scholar搜索功能不可用');
                }
                
                try {
                    const result = await window.electronAPI.searchGoogleScholar(keyword, limit);
                    if (result.success && result.results) {
                        return result.results;
                    } else {
                        throw new Error(result.error || '搜索失败');
                    }
                } catch (error) {
                    console.error('Google Scholar搜索错误:', error);
                    throw error;
                }
            }
            
            // 确认完成：整合并保存，返回主页面，推进步骤
            confirmBtn.addEventListener('click', async function() {
                // 直接以合并去重后的总表为准
                consolidateAllResults();
                finalResultsSection.style.display = 'block';
                try {
                    const projectName = currentProject;
                    if (!projectName) {
                        showToast('未绑定项目，无法保存', 'error');
                        return;
                    }
                    const data = getModule1Patch();
                    data.status = 'module2';
                    await mergeAndSave(projectName, data);
                    showToast(`文献查询完成，共 ${allLiterature.length} 篇不重复文献，已保存至项目`);
                    // 延迟跳转，让用户看到Toast通知
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1500);
                } catch (e) {
                    console.error('保存项目失败:', e);
                    showToast('保存项目失败: ' + e.message, 'error');
                }
            });
            
            // 合并所有关键词结果并去重（总表）
            function consolidateAllResults() {
                const all = [];
                console.log('开始合并，searchResults keys:', Object.keys(searchResults));
                
                Object.values(searchResults).forEach((results, index) => {
                    console.log(`关键词 ${index} 的结果数量:`, results ? results.length : 0);
                    if (Array.isArray(results)) {
                        results.forEach(item => {
                            if (item && item.title) {
                                all.push(item);
                            }
                        });
                    }
                });
                
                console.log('合并前总数:', all.length);
                
                const unique = [];
                const titles = new Set();
                all.forEach(item => {
                    if (item && item.title) {
                        const titleKey = item.title.toLowerCase().trim();
                        if (titleKey && !titles.has(titleKey)) {
                            titles.add(titleKey);
                            unique.push(item);
                        }
                    }
                });
                
                allLiterature = unique;
                console.log('去重后总数:', allLiterature.length);
                finalCount.textContent = allLiterature.length;
                displayFinalResults();
            }
            
            // 显示最终结果
            function displayFinalResults() {
                console.log('displayFinalResults 被调用，allLiterature.length:', allLiterature.length);
                
                if (!finalResultsContainer) {
                    console.error('finalResultsContainer 不存在');
                    return;
                }
                
                if (allLiterature.length === 0) {
                    console.log('结果为空，显示空状态');
                    finalResultsContainer.innerHTML = `
                        <div class="empty-state">
                            <p>未找到任何文献</p>
                        </div>
                    `;
                    return;
                }
                
                console.log('开始渲染结果列表...');
                finalResultsContainer.innerHTML = '';
                
                allLiterature.forEach((item, index) => {
                    if (!item || !item.title) {
                        console.warn(`跳过无效结果项 ${index}:`, item);
                        return;
                    }
                    
                    const resultItem = document.createElement('div');
                    resultItem.className = 'result-item';
                    
                    // 转义HTML特殊字符
                    const escapeHtml = (text) => {
                        if (!text) return '';
                        const div = document.createElement('div');
                        div.textContent = text;
                        return div.innerHTML;
                    };
                    
                    resultItem.innerHTML = `
                        <div class="result-header">
                            <h3>${escapeHtml(item.title)}</h3>
                        </div>
                        <div class="result-meta">
                            <span class="authors">${escapeHtml(item.authors || '')}</span> | 
                            <span class="year">${escapeHtml(item.year || '')}</span> | 
                            <span class="source">${escapeHtml(item.source || '')}</span> | 
                            ${item.cited ? `<span class="cited">被引 ${item.cited}</span>` : ''}
                        </div>
                        <div class="result-abstract">
                            <p>${escapeHtml(item.abstract || '')}</p>
                        </div>
                        ${item.url ? `<div class="result-url">
                            <a href="${escapeHtml(item.url)}" target="_blank">查看原文</a>
                        </div>` : ''}
                    `;
                    finalResultsContainer.appendChild(resultItem);
                });
                
                console.log(`已渲染 ${finalResultsContainer.children.length} 个结果项`);
                
                // 启用确认按钮
                updateConfirmButton();
            }

            // 导出Excel(CSV)
            const exportBtn = document.getElementById('export-excel-btn');
            exportBtn.addEventListener('click', function() {
                if (!allLiterature || allLiterature.length === 0) {
                    showToast('没有可导出的数据', 'error');
                    return;
                }
                const headers = ['Title','Authors','Year','Source','Cited','URL','Abstract'];
                const rows = allLiterature.map(it => [
                    safeCsv(it.title),
                    safeCsv(it.authors),
                    safeCsv(it.year),
                    safeCsv(it.source),
                    safeCsv(it.cited),
                    safeCsv(it.url),
                    safeCsv(it.abstract)
                ].join(','));
                const csv = [headers.join(',')].concat(rows).join('\n');
                downloadText(csv, `literature_${Date.now()}.csv`, 'text/csv;charset=utf-8;');
            });

            function safeCsv(v) {
                const s = (v === undefined || v === null) ? '' : String(v);
                if (/[",\n]/.test(s)) {
                    return '"' + s.replace(/"/g, '""') + '"';
                }
                return s;
            }

            function downloadText(text, filename, mime) {
                const blob = new Blob([text], { type: mime });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            
            // 更新确认按钮状态（基于总表是否有数据）
            function updateConfirmButton() {
                confirmBtn.disabled = !(allLiterature && allLiterature.length > 0);
            }
            
            // 返回主页面（页面跳转）
            backBtn.addEventListener('click', function() {
                if (confirm('确定要返回主页面吗？未保存的更改将会丢失。')) {
                    window.location.href = 'index.html';
                }
            });
        });
        
        // Electron IPC API
            window.electronAPI = {
            saveProjectData: (projectName, data) => {
                if (window.require) {
                    const { ipcRenderer } = window.require('electron');
                    return ipcRenderer.invoke('save-project-data', projectName, data);
                }
            },
            loadProjectData: (projectName) => {
                if (window.require) {
                    const { ipcRenderer } = window.require('electron');
                    return ipcRenderer.invoke('load-project-data', projectName);
                }
            },
            listProjects: () => {
                if (window.require) {
                    const { ipcRenderer } = window.require('electron');
                    return ipcRenderer.invoke('list-projects');
                }
            },
            getResearchTopic: () => {
                if (window.require) {
                    const { ipcRenderer } = window.require('electron');
                    return ipcRenderer.invoke('get-research-topic');
                }
            },
            getCurrentProject: () => {
                if (window.require) {
                    const { ipcRenderer } = window.require('electron');
                    return ipcRenderer.invoke('get-current-project');
                }
            },
            searchGoogleScholar: (keyword, limit) => {
                if (window.require) {
                    const { ipcRenderer } = window.require('electron');
                    return ipcRenderer.invoke('search-google-scholar', keyword, limit);
                }
            },
            openScholarLogin: () => {
                if (window.require) {
                    const { ipcRenderer } = window.require('electron');
                    return ipcRenderer.invoke('open-scholar-login');
                }
            }
        };
    </script>
</body>
</html>