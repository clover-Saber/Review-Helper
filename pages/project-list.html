<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review Helper - 项目列表</title>
    <link rel="stylesheet" href="index.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Review Helper - AI驱动的文献综述智能助手</h1>
            <p>Review Helper 现已开源，欢迎大家使用！GitHub地址：<a href="https://github.com/clover-Saber/Review-Helper.git" target="_blank">Review Helper</a></p>
        </header>
        
        <main>
            <section class="project-section" id="project-list-section">
                <h2>项目管理</h2>
                <div class="project-controls">
                    <div class="input-group">
                        <button id="new-project-btn">新建项目</button>
                    </div>
                    <div class="current-project" id="current-project" style="display: none;">
                        <p>当前项目: <span id="current-project-name"></span></p>
                    </div>
                </div>
                <!-- 项目列表区域 -->
                <div class="projects-list-section" id="projects-list-section">
                    <h3>项目列表</h3>
                    <div class="projects-grid" id="projects-grid">
                        <div class="loading-projects">正在加载项目列表...</div>
                    </div>
                </div>
            </section>
        </main>
        
        <footer>
            <p>© 2025 Review Helper - 助力科研工作者高效完成文献综述</p>
        </footer>
        
        <!-- Toast通知 -->
        <div id="toast" class="toast" style="display: none;">
            <div class="toast-content">
                <span class="toast-message" id="toast-message"></span>
            </div>
        </div>
        
        <!-- 统一模块加载 -->
        <script src="modules/electron-api.js"></script>
        <script src="modules/ui-utils.js"></script>
        <script src="modules/data-manager.js"></script>
        <script src="modules/subproject-manager.js"></script>
        
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                
                // DOM元素
                const newProjectBtn = document.getElementById('new-project-btn');
                const currentProject = document.getElementById('current-project');
                const currentProjectName = document.getElementById('current-project-name');
                
                // 检查按钮是否存在
                if (!newProjectBtn) {
                    console.error('新建项目按钮未找到！');
                    console.log('当前页面HTML:', document.body.innerHTML.substring(0, 500));
                    return;
                }
                
                console.log('新建项目按钮已找到:', newProjectBtn);
                console.log('electronAPI 是否存在:', !!window.electronAPI);
                console.log('electronAPI.createProject 是否存在:', !!(window.electronAPI && window.electronAPI.createProject));
                
                // 当前项目数据
                let currentProjectData = null;
                
                // 页面加载时自动恢复当前项目和加载项目列表
                // 注意：initCurrentProject 可能会自动切换页面，所以先加载项目列表
                loadProjectsList();
                
                // 延迟执行 initCurrentProject，确保用户能看到页面
                setTimeout(() => {
                    initCurrentProject();
                }, 100);
                
                async function initCurrentProject() {
                    if (!window.electronAPI) {
                        console.warn('electronAPI 未初始化，跳过自动切换');
                        return;
                    }
                    try {
                        const { success, currentProject: cp } = await window.electronAPI.getCurrentProject();
                        if (success && cp) {
                            // 检查是否有当前子项目ID（从sessionStorage）
                            const currentSubprojectId = sessionStorage.getItem('currentSubprojectId');
                            if (currentSubprojectId) {
                                // 有当前项目和子项目，自动切换到工作流界面
                                console.log('检测到当前项目和子项目，准备切换到工作流界面');
                                if (window.electronAPI.switchToWorkflow) {
                                    await window.electronAPI.switchToWorkflow();
                                }
                            } else {
                                // 如果没有子项目ID，但有当前项目，切换到项目详情页面
                                console.log('检测到当前项目但无子项目，准备切换到项目详情页面');
                                if (window.electronAPI.switchToProjectDetail) {
                                    await window.electronAPI.switchToProjectDetail();
                                }
                            }
                        } else {
                            console.log('没有当前项目，停留在项目列表页面');
                        }
                    } catch (e) {
                        console.error('初始化当前项目失败:', e);
                    }
                }
                

                async function askNewProjectName() {
                    const name = prompt('请输入项目名称:');
                    if (!name || !name.trim()) {
                        return null;
                    }
                    return name.trim();
                }
                
                // 新建项目
                newProjectBtn.addEventListener('click', async function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    if (!window.electronAPI || !window.electronAPI.createProject) {
                        showToast('系统初始化失败，请刷新页面重试', 'error');
                        return;
                    }
                    
                    const projectName = await askNewProjectName();
                    if (!projectName) {
                        return;
                    }
                    
                    try {
                        // 检查项目是否已存在
                        const result = await window.electronAPI.loadProjectData(projectName);
                        if (result.success && result.data) {
                            const confirmed = confirm(`项目"${projectName}"已存在，是否要打开它？`);
                            if (confirmed) {
                                await window.electronAPI.setCurrentProject(projectName);
                                if (window.electronAPI.switchToProjectDetail) {
                                    await window.electronAPI.switchToProjectDetail();
                                }
                            }
                            return;
                        }
                        
                        // 创建新项目
                        const createResult = await window.electronAPI.createProject(projectName);
                        
                        if (createResult && createResult.success) {
                            showToast(`项目"${projectName}"创建成功`);
                            await loadProjectsList();
                            
                            // 询问是否要打开项目
                            const shouldOpen = confirm(`项目"${projectName}"已创建，是否要打开它？`);
                            if (shouldOpen) {
                                await window.electronAPI.setCurrentProject(projectName);
                                if (window.electronAPI.switchToProjectDetail) {
                                    await window.electronAPI.switchToProjectDetail();
                                }
                            }
                        } else {
                            const errorMsg = createResult?.error || '未知错误';
                            showToast('创建项目失败: ' + errorMsg, 'error');
                        }
                    } catch (error) {
                        console.error('创建项目异常:', error);
                        showToast('创建项目失败: ' + (error.message || '未知错误'), 'error');
                    }
                });
                
                // 加载项目列表
                async function loadProjectsList() {
                    if (!window.electronAPI) return;
                    try {
                        const result = await window.electronAPI.listProjects();
                        if (result.success && result.projects) {
                            displayProjectsList(result.projects);
                        } else {
                            document.getElementById('projects-grid').innerHTML = '<div class="no-projects">暂无项目</div>';
                        }
                    } catch (error) {
                        console.error('加载项目列表失败:', error);
                        document.getElementById('projects-grid').innerHTML = '<div class="error-projects">加载项目列表失败</div>';
                    }
                }
                
                // 显示项目列表
                function displayProjectsList(projects) {
                    if (!projects || projects.length === 0) {
                        document.getElementById('projects-grid').innerHTML = '<div class="no-projects">暂无项目，点击"新建项目"创建第一个项目</div>';
                        return;
                    }
                    
                    const projectsGrid = document.getElementById('projects-grid');
                    projectsGrid.innerHTML = projects.map(project => {
                        // 加载项目数据以获取状态
                        return loadProjectDataForDisplay(project.name);
                    }).join('');
                    
                    // 等待所有项目数据加载完成
                    Promise.all(projects.map(async project => {
                        const data = await window.electronAPI.loadProjectData(project.name);
                        return { name: project.name, data: data.success ? data.data : null };
                    })).then(projectsWithData => {
                        projectsGrid.innerHTML = projectsWithData.map(({ name, data }) => {
                            return createProjectCard(name, data);
                        }).join('');
                        
                        // 绑定项目卡片点击事件（进入项目主页）
                        document.querySelectorAll('.project-card').forEach(card => {
                            card.style.cursor = 'pointer';
                            card.addEventListener('click', async function(e) {
                                // 如果点击的是按钮，不触发卡片点击
                                if (e.target.classList.contains('project-delete-btn')) {
                                    return;
                                }
                                const projectName = this.getAttribute('data-project-name');
                                await openProjectDetail(projectName);
                            });
                        });
                        
                        // 绑定删除项目事件
                        document.querySelectorAll('.project-delete-btn').forEach(btn => {
                            btn.addEventListener('click', async function(e) {
                                e.stopPropagation();
                                const projectName = this.getAttribute('data-project-name');
                                await deleteProject(projectName);
                            });
                        });
                    });
                }
                
                // 加载项目数据用于显示
                async function loadProjectDataForDisplay(projectName) {
                    return '<div class="loading-project">加载中...</div>';
                }
                
                // 创建项目卡片
                function createProjectCard(projectName, data) {
                    if (!data) {
                        return `
                            <div class="project-card" data-project-name="${projectName}">
                                <div class="project-card-header">
                                    <h4 class="project-name">${escapeHtml(projectName)}</h4>
                                </div>
                                <div class="project-card-body">
                                    <p class="project-topic">项目数据加载失败</p>
                                </div>
                                <div class="project-card-footer">
                                    <button class="project-delete-btn" data-project-name="${projectName}" title="删除项目">×</button>
                                </div>
                            </div>
                        `;
                    }
                    
                    const status = data.status || 'initial';
                    const statusText = {
                        'initial': '未开始',
                        'module1': '进行中',
                        'module2': '进行中',
                        'module3': '进行中',
                        'completed': '已完成'
                    }[status] || '未知';
                    
                    const statusClass = {
                        'initial': 'status-pending',
                        'module1': 'status-progress',
                        'module2': 'status-progress',
                        'module3': 'status-progress',
                        'completed': 'status-completed'
                    }[status] || 'status-pending';
                    
                    // 优先从 requirementData.requirement 读取，兼容旧格式
                    const topic = (data.requirementData && data.requirementData.requirement) || 
                                  data.projectDescription || 
                                  data.reviewDescription || 
                                  data.userNeeds || 
                                  data.researchTopic || 
                                  '未设置项目需求';
                    const createdAt = data.createdAt ? new Date(data.createdAt).toLocaleDateString('zh-CN') : '未知';
                    const updatedAt = data.updatedAt ? new Date(data.updatedAt).toLocaleDateString('zh-CN') : '未知';
                    
                    return `
                        <div class="project-card" data-project-name="${projectName}">
                            <div class="project-card-header">
                                <h4 class="project-name">${escapeHtml(projectName)}</h4>
                                <span class="project-status ${statusClass}" style="${status === 'initial' ? 'visibility: hidden;' : ''}">${statusText}</span>
                            </div>
                            <div class="project-card-body">
                                <p class="project-topic">${escapeHtml(topic.substring(0, 100))}${topic.length > 100 ? '...' : ''}</p>
                                <div class="project-meta">
                                    <span class="project-date">创建: ${createdAt}</span>
                                    <span class="project-date">更新: ${updatedAt}</span>
                                </div>
                            </div>
                            <div class="project-card-footer">
                                <button class="project-delete-btn" data-project-name="${projectName}" title="删除项目">×</button>
                            </div>
                        </div>
                    `;
                }
                
                // HTML转义
                function escapeHtml(text) {
                    if (!text) return '';
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                }
                
                // 打开项目详情页面
                async function openProjectDetail(projectName) {
                    if (!window.electronAPI) return;
                    try {
                        await window.electronAPI.setCurrentProject(projectName);
                        if (window.electronAPI.switchToProjectDetail) {
                            await window.electronAPI.switchToProjectDetail();
                        }
                    } catch (e) {
                        console.error('打开项目详情失败:', e);
                        alert('打开项目详情失败: ' + e.message);
                    }
                }
                
                // 删除项目
                async function deleteProject(projectName) {
                    // 确认删除
                    const confirmed = confirm(`确定要删除项目"${projectName}"吗？\n\n此操作不可恢复，将删除项目文件夹及其所有数据。`);
                    
                    if (!confirmed) {
                        return;
                    }
                    
                    try {
                        // 清除当前项目设置（如果删除的是当前项目）
                        const currentProjectResult = await window.electronAPI.getCurrentProject();
                        if (currentProjectResult.success && currentProjectResult.currentProject === projectName) {
                            await window.electronAPI.setCurrentProject(null);
                        }
                        
                        // 调用主进程删除项目
                        const result = await window.electronAPI.deleteProject(projectName);
                        
                        if (result.success) {
                            showToast(`项目"${projectName}"已删除`);
                            // 重新加载项目列表
                            await loadProjectsList();
                        } else {
                            showToast('删除项目失败: ' + (result.error || '未知错误'), 'error');
                        }
                    } catch (error) {
                        console.error('删除项目失败:', error);
                        showToast('删除项目失败: ' + error.message, 'error');
                    }
                }
                
                // 使用 UIUtils.showToast（已在模块中加载）
                function showToast(message, type = 'success') {
                    if (window.UIUtils && window.UIUtils.showToast) {
                        window.UIUtils.showToast(message, type);
                    } else {
                        // 降级方案
                        alert(message);
                    }
                }
            });
        </script>
    </div>
</body>
</html>

