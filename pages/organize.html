<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡çŒ®æ•´ç† - æ–‡çŒ®ç»¼è¿°ç”Ÿæˆå·¥å…·</title>
    <link rel="stylesheet" href="organize.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>æ–‡çŒ®æ•´ç†</h1>
            <p>åŸºäºAIç­›é€‰æ–‡çŒ®ï¼Œç¡®å®šæœ€ç»ˆé€‰ç”¨çš„æ–‡çŒ®åˆ—è¡¨</p>
        </header>
        
        <main>
            <section class="project-section">
                <h3>é¡¹ç›®ç®¡ç†</h3>
                <div class="project-controls">
                    <div class="input-group">
                        <div id="current-project-display">å½“å‰é¡¹ç›®ï¼š<span id="current-project-name">æœªé€‰æ‹©</span></div>
                        <button id="save-project-btn">ä¿å­˜åˆ°é¡¹ç›®</button>
                    </div>
                </div>
            </section>
            
            <section class="api-section">
                <div class="api-key-section">
                    <label for="api-key">DeepSeek API Key:</label>
                    <input type="password" id="api-key" placeholder="è¯·è¾“å…¥æ‚¨çš„DeepSeek API Key">
                </div>
            </section>

            <section class="import-section">
                <h3>è¡¥å……æ–‡çŒ®ï¼ˆå¯é€‰ï¼‰</h3>
                
                <div class="import-by-name-section" style="margin-bottom: 20px;">
                    <label for="paper-title-input" style="display: block; margin-bottom: 8px; font-weight: 500;">é€šè¿‡è®ºæ–‡åç§°æœç´¢å¯¼å…¥ï¼š</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="paper-title-input" placeholder="è¯·è¾“å…¥è®ºæ–‡æ ‡é¢˜..." style="flex: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px;">
                        <button id="search-paper-btn">æœç´¢å¹¶å¯¼å…¥</button>
                    </div>
                    <div id="search-paper-progress" style="display: none; margin-top: 10px;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="search-paper-progress-fill"></div>
                        </div>
                        <p id="search-paper-progress-text">å‡†å¤‡æœç´¢...</p>
                    </div>
                </div>
                
                <div class="import-pdf-section">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">é€šè¿‡PDFæ–‡ä»¶å¯¼å…¥ï¼š</label>
                    <div class="import-controls">
                        <input type="file" id="pdf-file-input" accept=".pdf" multiple style="display: none;">
                        <button id="select-pdf-btn">é€‰æ‹©PDFæ–‡ä»¶</button>
                        <button id="import-pdf-btn" disabled>å¯¼å…¥PDF</button>
                        <div id="import-progress" style="display: none;">
                            <div class="progress-bar">
                                <div class="progress-fill" id="import-progress-fill"></div>
                            </div>
                            <p id="import-progress-text">å‡†å¤‡å¯¼å…¥...</p>
                        </div>
                    </div>
                    <div id="selected-files" style="margin-top: 10px; font-size: 14px; color: #4a5568;"></div>
                </div>
            </section>

            <section class="filter-section">
                <h3>AIç­›é€‰æ–‡çŒ®</h3>
                <div class="input-group">
                    <button id="start-filter-btn">å¼€å§‹AIç­›é€‰</button>
                    <div id="filter-progress" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="filter-progress-fill"></div>
                        </div>
                        <p id="filter-progress-text">å‡†å¤‡å¼€å§‹ç­›é€‰...</p>
                    </div>
                </div>
            </section>
            
            <section class="literature-section" id="literature-section" style="display: none;">
                <div class="section-header">
                    <h2>æ–‡çŒ®åˆ—è¡¨</h2>
                    <div class="literature-stats">
                        <span>æ€»è®¡: <strong id="total-count">0</strong> ç¯‡</span>
                        <span>å·²é€‰ç”¨: <strong id="selected-count">0</strong> ç¯‡</span>
                        <span>æœªé€‰ç”¨: <strong id="unselected-count">0</strong> ç¯‡</span>
                    </div>
                </div>
                <div class="literature-controls">
                    <button id="select-all-btn">å…¨é€‰</button>
                    <button id="deselect-all-btn">å…¨ä¸é€‰</button>
                    <button id="select-ai-recommended-btn">ä»…é€‰AIæ¨è</button>
                    <button id="export-excel-btn">å¯¼å‡ºExcel</button>
                </div>
                <div class="literature-container" id="literature-container">
                    <div class="empty-state">
                        <p>æš‚æ— æ–‡çŒ®æ•°æ®</p>
                    </div>
                </div>
            </section>
        </main>
        
        <!-- ç¼–è¾‘æ–‡çŒ®æ¨¡æ€æ¡† -->
        <div id="edit-literature-modal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
                <div class="modal-header">
                    <h2>ç¼–è¾‘æ–‡çŒ®ä¿¡æ¯</h2>
                    <button class="modal-close" id="edit-modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="edit-title">æ ‡é¢˜ï¼š</label>
                        <input type="text" id="edit-title" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-authors">ä½œè€…ï¼š</label>
                        <input type="text" id="edit-authors" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="edit-year">å¹´ä»½ï¼š</label>
                        <input type="text" id="edit-year" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="edit-source">æ¥æºï¼š</label>
                        <input type="text" id="edit-source" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="edit-cited">è¢«å¼•æ¬¡æ•°ï¼š</label>
                        <input type="number" id="edit-cited" class="form-input" min="0">
                    </div>
                    <div class="form-group">
                        <label for="edit-url">URLï¼š</label>
                        <input type="url" id="edit-url" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="edit-abstract">æ‘˜è¦ï¼š</label>
                        <textarea id="edit-abstract" class="form-input" rows="6"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="edit-ai-reason">AIåˆ¤æ–­ç†ç”±ï¼š</label>
                        <textarea id="edit-ai-reason" class="form-input" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="edit-ai-recommended"> AIæ¨è
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="edit-save-btn" class="btn-primary">ä¿å­˜</button>
                    <button id="edit-cancel-btn" class="btn-secondary">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
        
        <footer>
            <div class="footer-controls">
                <button id="back-btn">è¿”å›ä¸»é¡µé¢</button>
                <button id="confirm-btn" disabled>ç¡®è®¤å®Œæˆ</button>
            </div>
        </footer>
        
        <!-- Toasté€šçŸ¥ -->
        <div id="toast" class="toast" style="display: none;">
            <div class="toast-content">
                <span class="toast-message" id="toast-message"></span>
            </div>
        </div>
    </div>
    
    <script>
        // Electron IPC APIï¼ˆæå‰å®šä¹‰ï¼Œç¡®ä¿åœ¨DOMContentLoadedä¹‹å‰å¯ç”¨ï¼‰
        window.electronAPI = {
            saveProjectData: (projectName, data) => {
                if (window.require) {
                    const { ipcRenderer } = window.require('electron');
                    return ipcRenderer.invoke('save-project-data', projectName, data);
                }
            },
            loadProjectData: (projectName) => {
                if (window.require) {
                    const { ipcRenderer } = window.require('electron');
                    return ipcRenderer.invoke('load-project-data', projectName);
                }
            },
            getCurrentProject: () => {
                if (window.require) {
                    const { ipcRenderer } = window.require('electron');
                    return ipcRenderer.invoke('get-current-project');
                }
            },
            parsePdf: (buffer, filename) => {
                if (window.require) {
                    const { ipcRenderer } = window.require('electron');
                    return ipcRenderer.invoke('parse-pdf', buffer, filename);
                }
            },
            searchGoogleScholar: (keyword, limit) => {
                if (window.require) {
                    const { ipcRenderer } = window.require('electron');
                    return ipcRenderer.invoke('search-google-scholar', keyword, limit);
                }
            },
            openScholarLogin: () => {
                if (window.require) {
                    const { ipcRenderer } = window.require('electron');
                    return ipcRenderer.invoke('open-scholar-login');
                }
            }
        };
        
        document.addEventListener('DOMContentLoaded', function() {
            
            // DOMå…ƒç´ 
            const currentProjectNameSpan = document.getElementById('current-project-name');
            const saveProjectBtn = document.getElementById('save-project-btn');
            const apiKeyInput = document.getElementById('api-key');
            const startFilterBtn = document.getElementById('start-filter-btn');
            const filterProgress = document.getElementById('filter-progress');
            const filterProgressFill = document.getElementById('filter-progress-fill');
            const filterProgressText = document.getElementById('filter-progress-text');
            const literatureSection = document.getElementById('literature-section');
            const literatureContainer = document.getElementById('literature-container');
            const totalCount = document.getElementById('total-count');
            const selectedCount = document.getElementById('selected-count');
            const unselectedCount = document.getElementById('unselected-count');
            const selectAllBtn = document.getElementById('select-all-btn');
            const deselectAllBtn = document.getElementById('deselect-all-btn');
            const selectAiRecommendedBtn = document.getElementById('select-ai-recommended-btn');
            const exportExcelBtn = document.getElementById('export-excel-btn');
            const confirmBtn = document.getElementById('confirm-btn');
            const backBtn = document.getElementById('back-btn');
            const pdfFileInput = document.getElementById('pdf-file-input');
            const selectPdfBtn = document.getElementById('select-pdf-btn');
            const importPdfBtn = document.getElementById('import-pdf-btn');
            const importProgress = document.getElementById('import-progress');
            const importProgressFill = document.getElementById('import-progress-fill');
            const importProgressText = document.getElementById('import-progress-text');
            const selectedFilesDiv = document.getElementById('selected-files');
            const paperTitleInput = document.getElementById('paper-title-input');
            const searchPaperBtn = document.getElementById('search-paper-btn');
            const searchPaperProgress = document.getElementById('search-paper-progress');
            const searchPaperProgressFill = document.getElementById('search-paper-progress-fill');
            const searchPaperProgressText = document.getElementById('search-paper-progress-text');
            
            // æ•°æ®å­˜å‚¨
            let currentProject = null;
            let literatureList = []; // æ–‡çŒ®åˆ—è¡¨ï¼Œæ¯ç¯‡åŒ…å« { ...literature, selected: boolean, aiRecommended: boolean, aiReason: string }
            let selectedPdfFiles = []; // é€‰ä¸­çš„PDFæ–‡ä»¶åˆ—è¡¨
            
            // æ˜¾ç¤ºToasté€šçŸ¥
            function showToast(message, type = 'success') {
                const toast = document.getElementById('toast');
                const toastMessage = document.getElementById('toast-message');
                
                if (!toast || !toastMessage) return;
                
                // è®¾ç½®æ¶ˆæ¯
                toastMessage.textContent = message;
                
                // æ ¹æ®ç±»å‹è®¾ç½®æ ·å¼
                if (type === 'success') {
                    toast.style.background = 'linear-gradient(135deg, var(--success-color) 0%, #059669 100%)';
                } else if (type === 'error') {
                    toast.style.background = 'linear-gradient(135deg, var(--error-color) 0%, #dc2626 100%)';
                }
                
                // æ˜¾ç¤ºtoast
                toast.style.display = 'block';
                toast.style.opacity = '0';
                
                // è§¦å‘åŠ¨ç”»
                setTimeout(() => {
                    toast.style.opacity = '1';
                }, 10);
                
                // 3ç§’åè‡ªåŠ¨éšè—
                setTimeout(() => {
                    toast.style.opacity = '0';
                    setTimeout(() => {
                        toast.style.display = 'none';
                    }, 300);
                }, 3000);
            }
            
            // åˆå§‹åŒ–å½“å‰é¡¹ç›®ä¿¡æ¯å¹¶åŠ è½½æ•°æ®
            initCurrentProject();
            async function initCurrentProject() {
                if (!window.electronAPI) return;
                try {
                    const { success, currentProject: cp } = await window.electronAPI.getCurrentProject();
                    if (success && cp) {
                        currentProject = cp;
                        currentProjectNameSpan.textContent = cp;
                        // åŠ è½½é¡¹ç›®æ•°æ®
                        const result = await window.electronAPI.loadProjectData(cp);
                        if (result.success && result.data) {
                            loadProjectData(result.data);
                        }
                    } else {
                        showToast('æœªé€‰æ‹©é¡¹ç›®ï¼Œè¯·åœ¨ä¸»é¡µé¢å…ˆæ–°å»ºæˆ–æ‰“å¼€é¡¹ç›®', 'error');
                    }
                } catch (e) {
                    console.error('è·å–å½“å‰é¡¹ç›®å¤±è´¥:', e);
                }
            }
            
            // åŠ è½½é¡¹ç›®æ•°æ®
            function loadProjectData(data) {
                // åŠ è½½API Key
                apiKeyInput.value = (data.config && data.config.apiKey) || data.apiKey || '';
                
                // åŠ è½½æ–‡çŒ®åˆ—è¡¨ï¼ˆæ¨¡å—1çš„æœ€ç»ˆç»“æœï¼‰
                const finalResults = data.finalResults || data.allLiterature || [];
                if (finalResults.length > 0) {
                    // å¦‚æœå·²æœ‰ç­›é€‰ç»“æœï¼Œä½¿ç”¨ç­›é€‰ç»“æœï¼›å¦åˆ™ä½¿ç”¨æ¨¡å—1çš„åŸå§‹ç»“æœ
                    const filteredResults = data.module2 && data.module2.filteredResults ? data.module2.filteredResults : null;
                    
                    if (filteredResults && Array.isArray(filteredResults)) {
                        // å·²æœ‰ç­›é€‰ç»“æœï¼Œç›´æ¥åŠ è½½
                        literatureList = filteredResults;
                    } else {
                        // é¦–æ¬¡è¿›å…¥æ¨¡å—2ï¼Œåˆå§‹åŒ–æ–‡çŒ®åˆ—è¡¨ï¼ˆé»˜è®¤æœªé€‰ç”¨ï¼‰
                        literatureList = finalResults.map(item => ({
                            ...item,
                            selected: false,
                            aiRecommended: false,
                            aiReason: ''
                        }));
                    }
                    
                    displayLiteratureList();
                    literatureSection.style.display = 'block';
                    updateStatistics();
                    updateConfirmButton();
                }
            }
            
            // ä¿å­˜é¡¹ç›®ï¼ˆåˆå¹¶ä¿å­˜ï¼Œé¿å…è¦†ç›–æ—§å­—æ®µï¼‰
            saveProjectBtn.addEventListener('click', async function() {
                const projectName = currentProject;
                if (!projectName) {
                    showToast('æœªç»‘å®šé¡¹ç›®ï¼Œè¯·è¿”å›ä¸»é¡µé¢é€‰æ‹©é¡¹ç›®', 'error');
                    return;
                }
                
                const projectData = getModule2Patch();
                if (window.electronAPI) {
                    try {
                        await mergeAndSave(projectName, projectData);
                        showToast(`é¡¹ç›® "${projectName}" ä¿å­˜æˆåŠŸ`);
                    } catch (error) {
                        console.error('ä¿å­˜é¡¹ç›®å¤±è´¥:', error);
                        showToast('ä¿å­˜é¡¹ç›®å¤±è´¥: ' + error.message, 'error');
                    }
                }
            });
            
            // è·å–æ¨¡å—2æ•°æ®
            function getModule2Patch() {
                return {
                    module2: {
                        filteredResults: literatureList,
                        timestamp: new Date().toISOString()
                    },
                    timestamp: new Date().toISOString()
                };
            }

            // æ·±åˆå¹¶ä¿å­˜
            async function mergeAndSave(projectName, patch) {
                const existing = await window.electronAPI.loadProjectData(projectName);
                const base = (existing && existing.success && existing.data) ? existing.data : {};
                const merged = deepMerge(base, patch || {});
                return await window.electronAPI.saveProjectData(projectName, merged);
            }

            function deepMerge(target, source) {
                if (!source || typeof source !== 'object') return target;
                const out = Array.isArray(target) ? [...target] : { ...target };
                Object.keys(source).forEach(key => {
                    const srcVal = source[key];
                    const tgtVal = out[key];
                    if (srcVal && typeof srcVal === 'object' && !Array.isArray(srcVal)) {
                        out[key] = deepMerge(tgtVal && typeof tgtVal === 'object' ? tgtVal : {}, srcVal);
                    } else {
                        out[key] = srcVal;
                    }
                });
                return out;
            }
            
            // å¼€å§‹AIç­›é€‰
            startFilterBtn.addEventListener('click', async function() {
                const apiKey = apiKeyInput.value.trim();
                if (!apiKey) {
                    showToast('è¯·è¾“å…¥DeepSeek API Key', 'error');
                    return;
                }
                
                if (literatureList.length === 0) {
                    showToast('æ²¡æœ‰å¯ç­›é€‰çš„æ–‡çŒ®ï¼Œè¯·å…ˆå®Œæˆæ¨¡å—1çš„æ–‡çŒ®æœç´¢', 'error');
                    return;
                }
                
                // æ˜¾ç¤ºè¿›åº¦æ¡
                filterProgress.style.display = 'block';
                startFilterBtn.disabled = true;
                
                try {
                    // ç»Ÿè®¡éœ€è¦ç­›é€‰çš„æ–‡çŒ®æ•°é‡
                    const needFilterList = literatureList.filter(item => {
                        // æ£€æŸ¥æ˜¯å¦å·²ç»ç­›é€‰è¿‡ï¼ˆæœ‰aiReasonå­—æ®µä¸”ä¸ä¸ºç©ºï¼‰
                        return !item.aiReason || item.aiReason.trim() === '';
                    });
                    
                    const totalCount = literatureList.length;
                    const skipCount = totalCount - needFilterList.length;
                    
                    if (needFilterList.length === 0) {
                        showToast('æ‰€æœ‰æ–‡çŒ®å·²ç»ç­›é€‰å®Œæˆï¼Œæ— éœ€é‡æ–°ç­›é€‰');
                        filterProgress.style.display = 'none';
                        startFilterBtn.disabled = false;
                        return;
                    }
                    
                    let processedCount = 0;
                    let currentSkippedCount = skipCount;
                    
                    // æ‰¹é‡ç­›é€‰æ–‡çŒ®ï¼ˆåªç­›é€‰æœªç­›é€‰è¿‡çš„ï¼‰
                    for (let i = 0; i < literatureList.length; i++) {
                        const item = literatureList[i];
                        const progress = ((i + 1) / totalCount) * 100;
                        
                        // æ£€æŸ¥æ˜¯å¦å·²ç»ç­›é€‰è¿‡
                        if (item.aiReason && item.aiReason.trim() !== '') {
                            // å·²ç­›é€‰è¿‡ï¼Œè·³è¿‡
                            updateFilterProgress(progress, `è·³è¿‡å·²ç­›é€‰: ${item.title.substring(0, 30)}... (${i + 1}/${totalCount}, å·²è·³è¿‡ ${currentSkippedCount} ç¯‡)`);
                            // çŸ­æš‚å»¶è¿Ÿï¼Œè®©ç”¨æˆ·çœ‹åˆ°è¿›åº¦
                            await new Promise(resolve => setTimeout(resolve, 100));
                            continue;
                        }
                        
                        // æœªç­›é€‰è¿‡ï¼Œè¿›è¡Œç­›é€‰
                        processedCount++;
                        updateFilterProgress(progress, `æ­£åœ¨ç­›é€‰: ${item.title.substring(0, 30)}... (${processedCount}/${needFilterList.length} æ–°ç­›é€‰, å·²è·³è¿‡ ${currentSkippedCount} ç¯‡)`);
                        
                        // è°ƒç”¨AIç­›é€‰
                        const filterResult = await filterLiteratureWithAI(item, apiKey);
                        item.aiRecommended = filterResult.recommended;
                        item.aiReason = filterResult.reason;
                        
                        // å¦‚æœAIæ¨èï¼Œé»˜è®¤é€‰ä¸­
                        if (filterResult.recommended) {
                            item.selected = true;
                        }
                        
                        // é¿å…è¯·æ±‚è¿‡äºé¢‘ç¹
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                    
                    // ç­›é€‰å®Œæˆ
                    const finalSkippedCount = totalCount - processedCount;
                    updateFilterProgress(100, `ç­›é€‰å®Œæˆï¼æ–°ç­›é€‰ ${processedCount} ç¯‡ï¼Œè·³è¿‡ ${finalSkippedCount} ç¯‡å·²ç­›é€‰çš„æ–‡çŒ®`);
                    setTimeout(() => {
                        filterProgress.style.display = 'none';
                        startFilterBtn.disabled = false;
                    }, 2000);
                    
                    // æ›´æ–°æ˜¾ç¤º
                    displayLiteratureList();
                    updateStatistics();
                    updateConfirmButton();
                    
                    // è‡ªåŠ¨ä¿å­˜
                    await autoSaveConfig();
                    
                    // æ˜¾ç¤ºå®Œæˆæç¤º
                    if (finalSkippedCount > 0) {
                        showToast(`ç­›é€‰å®Œæˆï¼æ–°ç­›é€‰: ${processedCount} ç¯‡æ–‡çŒ®ï¼Œè·³è¿‡: ${finalSkippedCount} ç¯‡å·²ç­›é€‰çš„æ–‡çŒ®`);
                    } else {
                        showToast(`ç­›é€‰å®Œæˆï¼å…±ç­›é€‰ ${processedCount} ç¯‡æ–‡çŒ®`);
                    }
                    
                } catch (error) {
                    console.error('AIç­›é€‰å¤±è´¥:', error);
                    filterProgress.style.display = 'none';
                    startFilterBtn.disabled = false;
                    showToast('AIç­›é€‰å¤±è´¥: ' + error.message, 'error');
                }
            });
            
            // ä½¿ç”¨DeepSeek APIç­›é€‰æ–‡çŒ®
            async function filterLiteratureWithAI(literature, apiKey) {
                const prompt = `ä½ æ˜¯ä¸€ä¸ªå­¦æœ¯ç ”ç©¶åŠ©æ‰‹ã€‚è¯·æ ¹æ®æ–‡çŒ®ä¿¡æ¯ï¼Œåˆ¤æ–­ä»¥ä¸‹æ–‡çŒ®æ˜¯å¦åº”è¯¥è¢«é€‰ç”¨ç”¨äºæ–‡çŒ®ç»¼è¿°ã€‚

æ–‡çŒ®ä¿¡æ¯ï¼š
- æ ‡é¢˜ï¼š${literature.title || 'æ— '}
- ä½œè€…ï¼š${literature.authors || 'æ— '}
- å¹´ä»½ï¼š${literature.year || 'æ— '}
- æ¥æºï¼š${literature.source || 'æ— '}
- æ‘˜è¦ï¼š${literature.abstract || 'æ— '}
- è¢«å¼•æ¬¡æ•°ï¼š${literature.cited || 0}

è¯·åˆ¤æ–­è¿™ç¯‡æ–‡çŒ®æ˜¯å¦åº”è¯¥è¢«é€‰ç”¨ã€‚è¯·ç”¨JSONæ ¼å¼å›å¤ï¼ŒåŒ…å«ä¸¤ä¸ªå­—æ®µï¼š
1. "recommended": trueæˆ–falseï¼Œè¡¨ç¤ºæ˜¯å¦æ¨èé€‰ç”¨
2. "reason": æ¨èæˆ–ä¸æ¨èçš„ç†ç”±ï¼ˆç®€æ´è¯´æ˜ï¼Œä¸è¶…è¿‡50å­—ï¼‰

åªè¿”å›JSONï¼Œä¸è¦å…¶ä»–å†…å®¹ã€‚`;

                const response = await fetch('https://api.deepseek.com/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [
                            {
                                "role": "system",
                                "content": "ä½ æ˜¯ä¸€ä¸ªå­¦æœ¯ç ”ç©¶åŠ©æ‰‹ï¼Œä¸“é—¨å¸®åŠ©ç”¨æˆ·ç­›é€‰æ–‡çŒ®ã€‚è¯·æ ¹æ®ç ”ç©¶ä¸»é¢˜å’Œæ–‡çŒ®ä¿¡æ¯ï¼Œç»™å‡ºä¸“ä¸šçš„åˆ¤æ–­ã€‚"
                            },
                            {
                                "role": "user",
                                "content": prompt
                            }
                        ],
                        stream: false
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                const content = data.choices[0].message.content;
                
                // å°è¯•è§£æJSON
                try {
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        const result = JSON.parse(jsonMatch[0]);
                        return {
                            recommended: result.recommended === true || result.recommended === 'true',
                            reason: result.reason || (result.recommended ? 'æ¨èé€‰ç”¨' : 'ä¸æ¨èé€‰ç”¨')
                        };
                    }
                } catch (e) {
                    console.warn('è§£æAIå›å¤å¤±è´¥:', e, content);
                }
                
                // å¦‚æœè§£æå¤±è´¥ï¼Œå°è¯•ä»æ–‡æœ¬ä¸­æ¨æ–­
                const lowerContent = content.toLowerCase();
                const recommended = lowerContent.includes('æ¨è') || lowerContent.includes('é€‰ç”¨') || lowerContent.includes('true');
                return {
                    recommended: recommended,
                    reason: content.substring(0, 50) || (recommended ? 'AIæ¨èé€‰ç”¨' : 'AIä¸æ¨è')
                };
            }
            
            // æ›´æ–°ç­›é€‰è¿›åº¦
            function updateFilterProgress(percent, text) {
                filterProgressFill.style.width = `${percent}%`;
                filterProgressText.textContent = text;
            }
            
            // æ˜¾ç¤ºæ–‡çŒ®åˆ—è¡¨
            function displayLiteratureList() {
                if (literatureList.length === 0) {
                    literatureContainer.innerHTML = `
                        <div class="empty-state">
                            <p>æš‚æ— æ–‡çŒ®æ•°æ®</p>
                        </div>
                    `;
                    return;
                }
                
                literatureContainer.innerHTML = '';
                
                literatureList.forEach((item, index) => {
                    const literatureItem = document.createElement('div');
                    literatureItem.className = `literature-item ${item.selected ? 'selected' : ''} ${item.aiRecommended ? 'ai-recommended' : ''}`;
                    
                    // è½¬ä¹‰HTML
                    const escapeHtml = (text) => {
                        if (!text) return '';
                        const div = document.createElement('div');
                        div.textContent = text;
                        return div.innerHTML;
                    };
                    
                    literatureItem.innerHTML = `
                        <div class="literature-checkbox">
                            <input type="checkbox" id="lit-${index}" ${item.selected ? 'checked' : ''} data-index="${index}">
                            <label for="lit-${index}"></label>
                        </div>
                        <div class="literature-content">
                            <div class="literature-header">
                                <h3>${escapeHtml(item.title)}</h3>
                                <div class="literature-actions">
                                    ${item.aiRecommended ? '<span class="ai-badge">AIæ¨è</span>' : ''}
                                    <button class="btn-edit" data-index="${index}" title="ç¼–è¾‘">âœï¸</button>
                                    <button class="btn-delete" data-index="${index}" title="åˆ é™¤">ğŸ—‘ï¸</button>
                                </div>
                            </div>
                            <div class="literature-meta">
                                <span class="authors">${escapeHtml(item.authors || '')}</span> | 
                                <span class="year">${escapeHtml(item.year || '')}</span> | 
                                <span class="source">${escapeHtml(item.source || '')}</span> | 
                                ${item.cited ? `<span class="cited">è¢«å¼• ${item.cited}</span>` : ''}
                            </div>
                            <div class="literature-abstract">
                                <p>${escapeHtml(item.abstract || '')}</p>
                            </div>
                            ${item.aiReason ? `<div class="ai-reason">
                                <strong>AIåˆ¤æ–­ï¼š</strong>${escapeHtml(item.aiReason)}
                            </div>` : ''}
                            ${item.url ? `<div class="literature-url">
                                <a href="${escapeHtml(item.url)}" target="_blank">æŸ¥çœ‹åŸæ–‡</a>
                            </div>` : ''}
                        </div>
                    `;
                    
                    literatureContainer.appendChild(literatureItem);
                });
                
                // ç»‘å®šå¤é€‰æ¡†äº‹ä»¶
                document.querySelectorAll('input[type="checkbox"][data-index]').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        const index = parseInt(this.getAttribute('data-index'));
                        literatureList[index].selected = this.checked;
                        updateStatistics();
                        updateConfirmButton();
                        // æ›´æ–°æ ·å¼
                        const item = this.closest('.literature-item');
                        if (this.checked) {
                            item.classList.add('selected');
                        } else {
                            item.classList.remove('selected');
                        }
                        // è‡ªåŠ¨ä¿å­˜
                        autoSaveConfig();
                    });
                });
                
                // ç»‘å®šç¼–è¾‘æŒ‰é’®äº‹ä»¶
                document.querySelectorAll('.btn-edit').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const index = parseInt(this.getAttribute('data-index'));
                        openEditModal(index);
                    });
                });
                
                // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
                document.querySelectorAll('.btn-delete').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const index = parseInt(this.getAttribute('data-index'));
                        deleteLiterature(index);
                    });
                });
            }
            
            // å½“å‰æ­£åœ¨ç¼–è¾‘çš„æ–‡çŒ®ç´¢å¼•
            let editingIndex = -1;
            
            // æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
            function openEditModal(index) {
                if (index < 0 || index >= literatureList.length) return;
                
                editingIndex = index;
                const item = literatureList[index];
                
                // å¡«å……è¡¨å•
                document.getElementById('edit-title').value = item.title || '';
                document.getElementById('edit-authors').value = item.authors || '';
                document.getElementById('edit-year').value = item.year || '';
                document.getElementById('edit-source').value = item.source || '';
                document.getElementById('edit-cited').value = item.cited || 0;
                document.getElementById('edit-url').value = item.url || '';
                document.getElementById('edit-abstract').value = item.abstract || '';
                document.getElementById('edit-ai-reason').value = item.aiReason || '';
                document.getElementById('edit-ai-recommended').checked = item.aiRecommended || false;
                
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                document.getElementById('edit-literature-modal').style.display = 'flex';
            }
            
            // å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†
            function closeEditModal() {
                document.getElementById('edit-literature-modal').style.display = 'none';
                editingIndex = -1;
            }
            
            // ä¿å­˜ç¼–è¾‘
            function saveEdit() {
                if (editingIndex < 0 || editingIndex >= literatureList.length) return;
                
                const item = literatureList[editingIndex];
                
                // æ›´æ–°æ–‡çŒ®ä¿¡æ¯
                item.title = document.getElementById('edit-title').value.trim();
                item.authors = document.getElementById('edit-authors').value.trim();
                item.year = document.getElementById('edit-year').value.trim();
                item.source = document.getElementById('edit-source').value.trim();
                item.cited = parseInt(document.getElementById('edit-cited').value) || 0;
                item.url = document.getElementById('edit-url').value.trim();
                item.abstract = document.getElementById('edit-abstract').value.trim();
                item.aiReason = document.getElementById('edit-ai-reason').value.trim();
                item.aiRecommended = document.getElementById('edit-ai-recommended').checked;
                
                // éªŒè¯å¿…å¡«å­—æ®µ
                if (!item.title) {
                    showToast('æ ‡é¢˜ä¸èƒ½ä¸ºç©º', 'error');
                    return;
                }
                
                // æ›´æ–°æ˜¾ç¤º
                displayLiteratureList();
                updateStatistics();
                
                // è‡ªåŠ¨ä¿å­˜
                autoSaveConfig();
                
                // å…³é—­æ¨¡æ€æ¡†
                closeEditModal();
                
                showToast('æ–‡çŒ®ä¿¡æ¯å·²æ›´æ–°');
            }
            
            // åˆ é™¤æ–‡çŒ®
            function deleteLiterature(index) {
                if (index < 0 || index >= literatureList.length) return;
                
                const item = literatureList[index];
                if (confirm(`ç¡®å®šè¦åˆ é™¤æ–‡çŒ®ã€Š${item.title}ã€‹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
                    literatureList.splice(index, 1);
                    
                    // æ›´æ–°æ˜¾ç¤º
                    displayLiteratureList();
                    updateStatistics();
                    updateConfirmButton();
                    
                    // è‡ªåŠ¨ä¿å­˜
                    autoSaveConfig();
                    
                    showToast('æ–‡çŒ®å·²åˆ é™¤');
                }
            }
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            function updateStatistics() {
                const total = literatureList.length;
                const selected = literatureList.filter(item => item.selected).length;
                const unselected = total - selected;
                
                totalCount.textContent = total;
                selectedCount.textContent = selected;
                unselectedCount.textContent = unselected;
            }
            
            // å…¨é€‰
            selectAllBtn.addEventListener('click', function() {
                literatureList.forEach(item => item.selected = true);
                displayLiteratureList();
                updateStatistics();
                updateConfirmButton();
                autoSaveConfig();
            });
            
            // å…¨ä¸é€‰
            deselectAllBtn.addEventListener('click', function() {
                literatureList.forEach(item => item.selected = false);
                displayLiteratureList();
                updateStatistics();
                updateConfirmButton();
                autoSaveConfig();
            });
            
            // ä»…é€‰AIæ¨è
            selectAiRecommendedBtn.addEventListener('click', function() {
                literatureList.forEach(item => {
                    item.selected = item.aiRecommended === true;
                });
                displayLiteratureList();
                updateStatistics();
                updateConfirmButton();
                autoSaveConfig();
            });
            
            // æ›´æ–°ç¡®è®¤æŒ‰é’®çŠ¶æ€
            function updateConfirmButton() {
                const hasSelected = literatureList.some(item => item.selected);
                confirmBtn.disabled = !hasSelected;
            }
            
            // ç¡®è®¤å®Œæˆ
            confirmBtn.addEventListener('click', async function() {
                const selectedLiterature = literatureList.filter(item => item.selected);
                if (selectedLiterature.length === 0) {
                    showToast('è¯·è‡³å°‘é€‰æ‹©ä¸€ç¯‡æ–‡çŒ®', 'error');
                    return;
                }
                
                try {
                    const projectName = currentProject;
                    if (!projectName) {
                        showToast('æœªç»‘å®šé¡¹ç›®ï¼Œæ— æ³•ä¿å­˜', 'error');
                        return;
                    }
                    
                    const data = getModule2Patch();
                    data.status = 'module3';
                    await mergeAndSave(projectName, data);
                    showToast(`æ–‡çŒ®æ•´ç†å®Œæˆï¼Œå·²é€‰æ‹© ${selectedLiterature.length} ç¯‡æ–‡çŒ®ï¼Œå·²ä¿å­˜è‡³é¡¹ç›®`);
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1500);
                } catch (e) {
                    console.error('ä¿å­˜é¡¹ç›®å¤±è´¥:', e);
                    showToast('ä¿å­˜é¡¹ç›®å¤±è´¥: ' + e.message, 'error');
                }
            });
            
            // è¿”å›ä¸»é¡µé¢
            backBtn.addEventListener('click', function() {
                if (confirm('ç¡®å®šè¦è¿”å›ä¸»é¡µé¢å—ï¼Ÿæœªä¿å­˜çš„æ›´æ”¹å°†ä¼šä¸¢å¤±ã€‚')) {
                    window.location.href = 'index.html';
                }
            });
            
            // è‡ªåŠ¨ä¿å­˜é…ç½®
            async function autoSaveConfig() {
                if (!currentProject) return;
                const data = getModule2Patch();
                try {
                    await mergeAndSave(currentProject, data);
                } catch (e) {
                    console.error('è‡ªåŠ¨ä¿å­˜å¤±è´¥', e);
                }
            }
            
            // æœç´¢å¹¶å¯¼å…¥è®ºæ–‡çš„å‡½æ•°
            async function searchAndImportPaper() {
                const paperTitle = paperTitleInput.value.trim();
                if (!paperTitle) {
                    showToast('è¯·è¾“å…¥è®ºæ–‡æ ‡é¢˜', 'error');
                    return;
                }
                
                // æ£€æŸ¥APIæ˜¯å¦å¯ç”¨
                if (!window.electronAPI || !window.electronAPI.searchGoogleScholar) {
                    showToast('Google Scholaræœç´¢åŠŸèƒ½ä¸å¯ç”¨', 'error');
                    return;
                }
                
                // æ˜¾ç¤ºè¿›åº¦
                searchPaperProgress.style.display = 'block';
                searchPaperBtn.disabled = true;
                paperTitleInput.disabled = true;
                
                try {
                    updateSearchPaperProgress(10, `æ­£åœ¨æœç´¢: "${paperTitle}"...`);
                    
                    // ä½¿ç”¨ç²¾ç¡®æœç´¢ï¼ˆåªæœç´¢1ç¯‡ï¼Œè·å–æœ€åŒ¹é…çš„ç»“æœï¼‰
                    const searchResult = await window.electronAPI.searchGoogleScholar(paperTitle, 1);
                    
                    if (!searchResult || !searchResult.success || !searchResult.results || searchResult.results.length === 0) {
                        showToast('æœªæ‰¾åˆ°åŒ¹é…çš„è®ºæ–‡ï¼Œè¯·æ£€æŸ¥è®ºæ–‡æ ‡é¢˜æ˜¯å¦æ­£ç¡®', 'error');
                        searchPaperProgress.style.display = 'none';
                        searchPaperBtn.disabled = false;
                        paperTitleInput.disabled = false;
                        return;
                    }
                    
                    // å–ç¬¬ä¸€ç¯‡ç»“æœï¼ˆæœ€åŒ¹é…çš„ï¼‰
                    const literature = searchResult.results[0];
                    
                    updateSearchPaperProgress(70, 'æ­£åœ¨æ£€æŸ¥é‡å¤...');
                    
                    // æ£€æŸ¥æ˜¯å¦é‡å¤
                    const isDuplicate = checkDuplicate(literature);
                    
                    if (isDuplicate) {
                        showToast('è¯¥è®ºæ–‡å·²å­˜åœ¨äºåˆ—è¡¨ä¸­ï¼Œè·³è¿‡å¯¼å…¥', 'error');
                        searchPaperProgress.style.display = 'none';
                        searchPaperBtn.disabled = false;
                        paperTitleInput.disabled = false;
                        return;
                    }
                    
                    updateSearchPaperProgress(90, 'æ­£åœ¨æ·»åŠ åˆ°åˆ—è¡¨...');
                    
                    // æ·»åŠ åˆ°æ–‡çŒ®åˆ—è¡¨
                    const newLiterature = {
                        ...literature,
                        selected: false,
                        aiRecommended: false,
                        aiReason: '',
                        source: literature.source || 'Google Scholaræœç´¢å¯¼å…¥'
                    };
                    
                    literatureList.push(newLiterature);
                    
                    // æ›´æ–°æ˜¾ç¤º
                    displayLiteratureList();
                    updateStatistics();
                    updateConfirmButton();
                    literatureSection.style.display = 'block';
                    
                    // è‡ªåŠ¨ä¿å­˜
                    await autoSaveConfig();
                    
                    updateSearchPaperProgress(100, 'å¯¼å…¥å®Œæˆï¼');
                    
                    // æ¸…ç©ºè¾“å…¥æ¡†
                    paperTitleInput.value = '';
                    
                    setTimeout(() => {
                        searchPaperProgress.style.display = 'none';
                        searchPaperBtn.disabled = false;
                        paperTitleInput.disabled = false;
                    }, 1500);
                    
                    showToast(`æˆåŠŸå¯¼å…¥: ${literature.title}`);
                    
                } catch (error) {
                    console.error('æœç´¢è®ºæ–‡å¤±è´¥:', error);
                    searchPaperProgress.style.display = 'none';
                    searchPaperBtn.disabled = false;
                    paperTitleInput.disabled = false;
                    showToast('æœç´¢è®ºæ–‡å¤±è´¥: ' + error.message, 'error');
                }
            }
            
            // é€šè¿‡è®ºæ–‡åç§°æœç´¢å¹¶å¯¼å…¥
            searchPaperBtn.addEventListener('click', searchAndImportPaper);
            
            // æ”¯æŒæŒ‰Enteré”®æœç´¢
            paperTitleInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchAndImportPaper();
                }
            });
            
            // æ›´æ–°æœç´¢è®ºæ–‡è¿›åº¦
            function updateSearchPaperProgress(percent, text) {
                searchPaperProgressFill.style.width = `${percent}%`;
                searchPaperProgressText.textContent = text;
            }
            
            // PDFæ–‡ä»¶é€‰æ‹©
            selectPdfBtn.addEventListener('click', function() {
                pdfFileInput.click();
            });
            
            pdfFileInput.addEventListener('change', function(e) {
                const files = Array.from(e.target.files);
                selectedPdfFiles = files;
                
                if (files.length > 0) {
                    const fileNames = files.map(f => f.name).join(', ');
                    selectedFilesDiv.textContent = `å·²é€‰æ‹© ${files.length} ä¸ªæ–‡ä»¶: ${fileNames}`;
                    importPdfBtn.disabled = false;
                } else {
                    selectedFilesDiv.textContent = '';
                    importPdfBtn.disabled = true;
                }
            });
            
            // å¯¼å…¥PDF
            importPdfBtn.addEventListener('click', async function() {
                if (selectedPdfFiles.length === 0) {
                    showToast('è¯·å…ˆé€‰æ‹©PDFæ–‡ä»¶', 'error');
                    return;
                }
                
                const apiKey = apiKeyInput.value.trim();
                if (!apiKey) {
                    showToast('è¯·å…ˆè¾“å…¥DeepSeek API Key', 'error');
                    return;
                }
                
                importProgress.style.display = 'block';
                importPdfBtn.disabled = true;
                selectPdfBtn.disabled = true;
                
                try {
                    let successCount = 0;
                    let duplicateCount = 0;
                    let failCount = 0;
                    
                    // å¾ªç¯å¤„ç†æ¯ä¸ªPDFæ–‡ä»¶ï¼ˆä¸€æ¬¡åªå¤„ç†ä¸€ä¸ªï¼‰
                    for (let i = 0; i < selectedPdfFiles.length; i++) {
                        const file = selectedPdfFiles[i];
                        const progress = ((i + 1) / selectedPdfFiles.length) * 100;
                        updateImportProgress(progress, `æ­£åœ¨å¤„ç†: ${file.name} (${i + 1}/${selectedPdfFiles.length})`);
                        
                        try {
                            // ç›´æ¥ä½¿ç”¨å¤§æ¨¡å‹APIæå–æ–‡çŒ®ä¿¡æ¯
                            updateImportProgress(progress, `æ­£åœ¨ä½¿ç”¨AIå¤„ç†PDF: ${file.name} (${i + 1}/${selectedPdfFiles.length})`);
                            
                            // å°è¯•è¯»å–PDFæ–‡ä»¶å†…å®¹ï¼ˆç”¨äºæå–æ–‡æœ¬ï¼Œå¦‚æœå¯èƒ½ï¼‰
                            let pdfText = '';
                            try {
                                const arrayBuffer = await file.arrayBuffer();
                                
                                // å°è¯•ä½¿ç”¨åç«¯è§£æPDFè·å–æ–‡æœ¬ï¼ˆå¯é€‰ï¼Œå¤±è´¥ä¸å½±å“ï¼‰
                                if (window.electronAPI && window.electronAPI.parsePdf) {
                                    const buffer = Buffer.from(arrayBuffer);
                                    const parseResult = await window.electronAPI.parsePdf(buffer, file.name);
                                    if (parseResult.success && parseResult.text) {
                                        pdfText = parseResult.text;
                                    }
                                }
                            } catch (e) {
                                console.warn('PDFæ–‡æœ¬æå–å¤±è´¥ï¼Œå°†ä»…æ ¹æ®æ–‡ä»¶åæ¨æ–­:', e);
                            }
                            
                            // ä½¿ç”¨å¤§æ¨¡å‹APIæå–æ–‡çŒ®ä¿¡æ¯
                            const literature = await extractLiteratureFromPdfWithAI(
                                pdfText || null, // å¦‚æœæœ‰æ–‡æœ¬å†…å®¹å°±ä¼ é€’ï¼Œå¦åˆ™ä¸ºnull
                                file.name, 
                                apiKey
                            );
                            
                            if (literature) {
                                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨é‡å¤æ–‡çŒ®ï¼ˆåŸºäºæ ‡é¢˜å»é‡ï¼‰
                                const isDuplicate = checkDuplicate(literature);
                                
                                if (isDuplicate) {
                                    console.log(`è·³è¿‡é‡å¤æ–‡çŒ®: ${literature.title}`);
                                    duplicateCount++;
                                    updateImportProgress(progress, `è·³è¿‡é‡å¤æ–‡çŒ®: ${file.name} (${i + 1}/${selectedPdfFiles.length})`);
                                } else {
                                    // æ·»åŠ åˆ°æ–‡çŒ®åˆ—è¡¨
                                    const newLiterature = {
                                        ...literature,
                                        selected: false,
                                        aiRecommended: false,
                                        aiReason: '',
                                        source: literature.source || 'PDFå¯¼å…¥',
                                        url: '',
                                        pdfFileName: file.name
                                    };
                                    literatureList.push(newLiterature);
                                    successCount++;
                                }
                            } else {
                                failCount++;
                            }
                            
                            // é¿å…è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œæ¯ä¸ªæ–‡ä»¶å¤„ç†å®Œåç­‰å¾…
                            if (i < selectedPdfFiles.length - 1) {
                                await new Promise(resolve => setTimeout(resolve, 1000));
                            }
                            
                        } catch (error) {
                            console.error(`å¤„ç†PDFæ–‡ä»¶ ${file.name} å¤±è´¥:`, error);
                            failCount++;
                            // ç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªæ–‡ä»¶ï¼Œä¸ä¸­æ–­æ•´ä¸ªæµç¨‹
                        }
                    }
                    
                    // å¯¼å…¥å®Œæˆ
                    updateImportProgress(100, 'å¯¼å…¥å®Œæˆ');
                    
                    // æ›´æ–°æ˜¾ç¤º
                    displayLiteratureList();
                    updateStatistics();
                    updateConfirmButton();
                    literatureSection.style.display = 'block';
                    
                    // è‡ªåŠ¨ä¿å­˜
                    await autoSaveConfig();
                    
                    setTimeout(() => {
                        importProgress.style.display = 'none';
                        importPdfBtn.disabled = false;
                        selectPdfBtn.disabled = false;
                        pdfFileInput.value = '';
                        selectedPdfFiles = [];
                        selectedFilesDiv.textContent = '';
                        
                        let message = `å¯¼å…¥å®Œæˆï¼æˆåŠŸå¯¼å…¥: ${successCount} ä¸ªæ–‡ä»¶`;
                        if (duplicateCount > 0) {
                            message += `ï¼Œè·³è¿‡é‡å¤: ${duplicateCount} ä¸ªæ–‡ä»¶`;
                        }
                        if (failCount > 0) {
                            message += `ï¼Œå¤„ç†å¤±è´¥: ${failCount} ä¸ªæ–‡ä»¶`;
                        }
                        message += `ï¼Œå…±æ·»åŠ  ${successCount} ç¯‡æ–°æ–‡çŒ®åˆ°åˆ—è¡¨`;
                        showToast(message);
                    }, 1000);
                    
                } catch (error) {
                    console.error('å¯¼å…¥PDFå¤±è´¥:', error);
                    importProgress.style.display = 'none';
                    importPdfBtn.disabled = false;
                    selectPdfBtn.disabled = false;
                    showToast('å¯¼å…¥PDFå¤±è´¥: ' + error.message, 'error');
                }
            });
            
            // æ£€æŸ¥æ–‡çŒ®æ˜¯å¦é‡å¤ï¼ˆåŸºäºæ ‡é¢˜ç›¸ä¼¼åº¦ï¼‰
            function checkDuplicate(newLiterature) {
                if (!newLiterature || !newLiterature.title) {
                    return false;
                }
                
                const newTitle = newLiterature.title.toLowerCase().trim();
                
                // éå†ç°æœ‰æ–‡çŒ®åˆ—è¡¨ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ç›¸åŒæˆ–ç›¸ä¼¼çš„æ ‡é¢˜
                for (const existing of literatureList) {
                    if (!existing || !existing.title) continue;
                    
                    const existingTitle = existing.title.toLowerCase().trim();
                    
                    // å®Œå…¨åŒ¹é…
                    if (newTitle === existingTitle) {
                        return true;
                    }
                    
                    // ç›¸ä¼¼åº¦æ£€æŸ¥ï¼šå¦‚æœæ ‡é¢˜ç›¸ä¼¼åº¦å¾ˆé«˜ï¼ˆå»æ‰æ ‡ç‚¹ç¬¦å·åç›¸ä¼¼ï¼‰ï¼Œä¹Ÿè®¤ä¸ºæ˜¯é‡å¤
                    const normalizeTitle = (title) => {
                        return title.replace(/[^\w\s]/g, '').replace(/\s+/g, ' ').trim();
                    };
                    
                    const normalizedNew = normalizeTitle(newTitle);
                    const normalizedExisting = normalizeTitle(existingTitle);
                    
                    // å¦‚æœè§„èŒƒåŒ–åçš„æ ‡é¢˜ç›¸åŒ
                    if (normalizedNew === normalizedExisting && normalizedNew.length > 10) {
                        return true;
                    }
                    
                    // å¦‚æœä¸€ä¸ªæ˜¯å¦ä¸€ä¸ªçš„å­ä¸²ï¼ˆä¸”é•¿åº¦å·®å¼‚ä¸å¤§ï¼‰ï¼Œä¹Ÿè®¤ä¸ºæ˜¯é‡å¤
                    if (normalizedNew.length > 20 && normalizedExisting.length > 20) {
                        const similarity = calculateSimilarity(normalizedNew, normalizedExisting);
                        if (similarity > 0.9) { // ç›¸ä¼¼åº¦è¶…è¿‡90%
                            return true;
                        }
                    }
                }
                
                return false;
            }
            
            // è®¡ç®—ä¸¤ä¸ªå­—ç¬¦ä¸²çš„ç›¸ä¼¼åº¦ï¼ˆç®€å•çš„ç¼–è¾‘è·ç¦»ç®—æ³•ï¼‰
            function calculateSimilarity(str1, str2) {
                if (str1 === str2) return 1.0;
                if (str1.length === 0 || str2.length === 0) return 0.0;
                
                const longer = str1.length > str2.length ? str1 : str2;
                const shorter = str1.length > str2.length ? str2 : str1;
                
                // å¦‚æœè¾ƒçŸ­çš„å­—ç¬¦ä¸²æ˜¯è¾ƒé•¿çš„å­—ç¬¦ä¸²çš„å­ä¸²ï¼Œç›¸ä¼¼åº¦è¾ƒé«˜
                if (longer.indexOf(shorter) !== -1) {
                    return shorter.length / longer.length;
                }
                
                // ç®€å•çš„å­—ç¬¦åŒ¹é…ç‡
                let matches = 0;
                const minLength = Math.min(str1.length, str2.length);
                for (let i = 0; i < minLength; i++) {
                    if (str1[i] === str2[i]) {
                        matches++;
                    }
                }
                
                return matches / Math.max(str1.length, str2.length);
            }
            
            // ä½¿ç”¨å¤§æ¨¡å‹APIä»PDFä¸­æå–æ–‡çŒ®ä¿¡æ¯ï¼ˆä¸æ¨¡å—1æœç´¢ç»“æœçš„å­—æ®µç»“æ„ä¸€è‡´ï¼‰
            async function extractLiteratureFromPdfWithAI(pdfText, filename, apiKey) {
                let prompt = '';
                
                if (pdfText && pdfText.trim().length > 0) {
                    // å¦‚æœæœ‰PDFæ–‡æœ¬å†…å®¹ï¼Œä½¿ç”¨æ–‡æœ¬æå–ï¼ˆæ›´å‡†ç¡®ï¼‰
                    // é™åˆ¶æ–‡æœ¬é•¿åº¦ï¼Œé¿å…è¶…å‡ºAPIé™åˆ¶ï¼ˆä¿ç•™å‰10000å­—ç¬¦ï¼‰
                    const limitedText = pdfText.substring(0, 10000);
                    
                    prompt = `You are an academic literature information extraction assistant. Please accurately extract key information from the following PDF document text content.

PDF Filename: ${filename}

PDF Text Content (first 10000 characters):
${limitedText}

Please accurately extract the following information from the text:
1. Title: The complete title of the paper, preferably extracted from the beginning of the text or the title section
2. Authors: All author names, separated by commas, preferably extracted from the author information section
3. Year: The publication year of the paper, find a 4-digit year in the text
4. Source: Journal name, conference name, or publishing institution, find it in the text
5. Abstract: The abstract content of the paper, preferably find the Abstract section, if not available, summarize based on the content (200-300 words)
6. Cited: The number of citations (if available in the text, otherwise use 0)

Important: Please identify the language of the literature. If it is an English paper, output all fields in English. If it is a Chinese paper, output all fields in Chinese. Keep the original language of the content.

Please reply in JSON format with the following fields:
{
  "title": "Paper Title",
  "authors": "Author1, Author2, Author3",
  "year": "2023",
  "source": "Journal/Conference Name",
  "abstract": "Abstract content",
  "cited": 0
}

Only return JSON, no other content. If a field cannot be extracted from the text, use an empty string "".`;
                } else {
                    // å¦‚æœæ²¡æœ‰PDFæ–‡æœ¬å†…å®¹ï¼Œæ ¹æ®æ–‡ä»¶åæ¨æ–­
                    prompt = `You are an academic literature information extraction assistant. Please infer key information about the literature based on the PDF filename.

PDF Filename: ${filename}

Note: Unable to directly read PDF content. Please infer literature information as accurately as possible based on the filename format. Filenames usually contain the paper title or related keywords.

Please infer the following information based on the filename:
1. Title: Infer the complete paper title from the filename (the filename is usually the title or contains title keywords, please format it as a complete paper title)
2. Authors: Infer possible authors from the filename format (if the filename contains author names, extract them; otherwise use empty string)
3. Year: Find a 4-digit year in the filename (such as 2023, 2024, etc.), if not found, use empty string
4. Source: Infer possible journal, conference, or publishing institution from the filename format (if unable to infer, use "PDFå¯¼å…¥")
5. Abstract: Generate a possible abstract description (200-300 words) based on keywords in the filename, describing the research content and direction that the literature may involve

Important: Please identify the language based on the filename. If the filename suggests an English paper, output all fields in English. If it suggests a Chinese paper, output all fields in Chinese.

Please reply in JSON format with the following fields:
{
  "title": "Paper Title",
  "authors": "Author1, Author2, Author3",
  "year": "2023",
  "source": "Journal/Conference Name",
  "abstract": "Abstract content",
  "cited": 0
}

Only return JSON, no other content. If a field cannot be inferred, use an empty string "".`;
                }

                try {
                    const response = await fetch('https://api.deepseek.com/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: "deepseek-chat",
                            messages: [
                                {
                                    "role": "system",
                                    "content": "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å­¦æœ¯æ–‡çŒ®ä¿¡æ¯æå–åŠ©æ‰‹ã€‚è¯·ä»”ç»†åˆ†æPDFæ–‡æœ¬å†…å®¹ï¼Œå‡†ç¡®æå–æ–‡çŒ®çš„æ ‡é¢˜ã€ä½œè€…ã€å¹´ä»½ã€æ¥æºå’Œæ‘˜è¦ä¿¡æ¯ã€‚"
                                },
                                {
                                    "role": "user",
                                    "content": prompt
                                }
                            ],
                            stream: false
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    const content = data.choices[0].message.content;
                    
                    // å°è¯•è§£æJSON
                    try {
                        const jsonMatch = content.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            const result = JSON.parse(jsonMatch[0]);
                            
                            // éªŒè¯å¹¶æ„å»ºæ–‡çŒ®å¯¹è±¡ï¼ˆä¸æ¨¡å—1æœç´¢ç»“æœçš„å­—æ®µç»“æ„ä¸€è‡´ï¼‰
                            const literature = {
                                title: result.title || filename.replace('.pdf', ''),
                                authors: result.authors || (result.title && result.title.match(/[a-zA-Z]/) ? 'Unknown Author' : 'æœªçŸ¥ä½œè€…'),
                                year: result.year || '',
                                source: result.source || 'PDFå¯¼å…¥',
                                abstract: result.abstract || (pdfText ? pdfText.substring(0, 300) + '...' : ''),
                                cited: result.cited || 0,
                                url: '',
                                pdfFileName: filename
                            };
                            
                            return literature;
                        }
                    } catch (e) {
                        console.warn('è§£æAIå›å¤å¤±è´¥:', e, content);
                    }
                    
                    // å¦‚æœè§£æå¤±è´¥ï¼Œä½¿ç”¨æ–‡ä»¶åä½œä¸ºåŸºæœ¬ä¿¡æ¯
                    const title = filename.replace('.pdf', '');
                    const isEnglish = /[a-zA-Z]/.test(title);
                    const fallbackAbstract = pdfText ? pdfText.substring(0, 300) + '...' : 
                        (isEnglish ? `Abstract inferred from filename "${filename}".` : 
                         `æ ¹æ®æ–‡ä»¶å"${filename}"æ¨æ–­çš„æ–‡çŒ®æ‘˜è¦ã€‚`);
                    
                    return {
                        title: title,
                        authors: isEnglish ? 'Unknown Author' : 'æœªçŸ¥ä½œè€…',
                        year: '',
                        source: 'PDFå¯¼å…¥',
                        abstract: fallbackAbstract,
                        cited: 0,
                        url: '',
                        pdfFileName: filename
                    };
                    
                } catch (error) {
                    console.error('AIæå–æ–‡çŒ®ä¿¡æ¯å¤±è´¥:', error);
                    throw error;
                }
            }
            
            // æ›´æ–°å¯¼å…¥è¿›åº¦
            function updateImportProgress(percent, text) {
                importProgressFill.style.width = `${percent}%`;
                importProgressText.textContent = text;
            }
            
            // å¯¼å‡ºExcel(CSV)
            exportExcelBtn.addEventListener('click', function() {
                if (!literatureList || literatureList.length === 0) {
                    showToast('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®', 'error');
                    return;
                }
                
                // å¯¼å‡ºæ‰€æœ‰æ–‡çŒ®æ•°æ®ï¼ŒåŒ…å«æ¨¡å—2çš„é¢å¤–å­—æ®µ
                const headers = ['Title', 'Authors', 'Year', 'Source', 'Cited', 'URL', 'Abstract', 'Selected', 'AI Recommended', 'AI Reason', 'PDF File Name'];
                const rows = literatureList.map(it => {
                    // ç¡®ä¿æ¯ä¸ªå­—æ®µéƒ½æ­£ç¡®å¤„ç†ï¼Œé¿å…æ•°æ®é”™ä½
                    return [
                        safeCsv(it.title || ''),
                        safeCsv(it.authors || ''),
                        safeCsv(it.year || ''),
                        safeCsv(it.source || ''),
                        safeCsv(it.cited || '0'),
                        safeCsv(it.url || ''),
                        safeCsv(it.abstract || ''),
                        safeCsv(it.selected ? 'æ˜¯' : 'å¦'),
                        safeCsv(it.aiRecommended ? 'æ˜¯' : 'å¦'),
                        safeCsv(it.aiReason || ''),
                        safeCsv(it.pdfFileName || '')
                    ];
                });
                
                // æ„å»ºCSVå†…å®¹
                const csvRows = [headers.join(',')];
                rows.forEach(row => {
                    csvRows.push(row.join(','));
                });
                
                // æ·»åŠ UTF-8 BOMä»¥æ”¯æŒExcelæ­£ç¡®æ˜¾ç¤ºä¸­æ–‡
                const BOM = '\uFEFF';
                const csv = BOM + csvRows.join('\n');
                
                downloadText(csv, `literature_organized_${Date.now()}.csv`, 'text/csv;charset=utf-8;');
            });

            function safeCsv(v) {
                if (v === undefined || v === null) {
                    return '';
                }
                
                // è½¬æ¢ä¸ºå­—ç¬¦ä¸²
                let s = String(v);
                
                // æ›¿æ¢æ¢è¡Œç¬¦ä¸ºç©ºæ ¼ï¼Œé¿å…CSVæ ¼å¼é”™è¯¯
                s = s.replace(/\r\n/g, ' ').replace(/\n/g, ' ').replace(/\r/g, ' ');
                
                // å¦‚æœåŒ…å«é€—å·ã€å¼•å·æˆ–æ¢è¡Œç¬¦ï¼Œéœ€è¦ç”¨å¼•å·åŒ…è£¹
                if (/[",\n\r]/.test(s)) {
                    // å°†å†…éƒ¨çš„å¼•å·è½¬ä¹‰ä¸ºåŒå¼•å·
                    s = '"' + s.replace(/"/g, '""') + '"';
                }
                
                return s;
            }

            function downloadText(text, filename, mime) {
                // ä½¿ç”¨Blobå¹¶æŒ‡å®šUTF-8ç¼–ç 
                const blob = new Blob(['\uFEFF' + text], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            
            // å‚æ•°å˜æ›´è‡ªåŠ¨ä¿å­˜
            apiKeyInput.addEventListener('change', autoSaveConfig);
            apiKeyInput.addEventListener('blur', autoSaveConfig);
            
            // åˆå§‹åŒ–ç¼–è¾‘æ¨¡æ€æ¡†äº‹ä»¶ï¼ˆåœ¨å‡½æ•°å®šä¹‰ä¹‹åï¼‰
            const editModal = document.getElementById('edit-literature-modal');
            const editSaveBtn = document.getElementById('edit-save-btn');
            const editCancelBtn = document.getElementById('edit-cancel-btn');
            const editCloseBtn = document.getElementById('edit-modal-close');
            
            if (editSaveBtn) {
                editSaveBtn.addEventListener('click', saveEdit);
            }
            
            if (editCancelBtn) {
                editCancelBtn.addEventListener('click', closeEditModal);
            }
            
            if (editCloseBtn) {
                editCloseBtn.addEventListener('click', closeEditModal);
            }
            
            // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
            if (editModal) {
                editModal.addEventListener('click', function(e) {
                    if (e.target === editModal) {
                        closeEditModal();
                    }
                });
            }
            
            // æŒ‰ESCé”®å…³é—­
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && editModal && editModal.style.display === 'flex') {
                    closeEditModal();
                }
            });
        });
    </script>
</body>
</html>

