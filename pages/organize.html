<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文献整理 - 文献综述生成工具</title>
    <link rel="stylesheet" href="organize.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>文献整理</h1>
            <p>基于AI筛选文献，确定最终选用的文献列表</p>
        </header>
        
        <main>
            <section class="project-section">
                <h3>项目管理</h3>
                <div class="project-controls">
                    <div class="input-group">
                        <div id="current-project-display">当前项目：<span id="current-project-name">未选择</span></div>
                        <button id="save-project-btn">保存到项目</button>
                    </div>
                </div>
            </section>
            
            <section class="api-section">
                <div class="api-key-section">
                    <label for="api-key">DeepSeek API Key:</label>
                    <input type="password" id="api-key" placeholder="请输入您的DeepSeek API Key">
                </div>
            </section>

            <section class="research-section">
                <h3>研究主题</h3>
                <div id="research-topic-display" class="topic-display">（将自动读取主页面研究主题）</div>
            </section>

            <section class="import-section">
                <h3>导入PDF文献（可选）</h3>
                <div class="import-controls">
                    <input type="file" id="pdf-file-input" accept=".pdf" multiple style="display: none;">
                    <button id="select-pdf-btn">选择PDF文件</button>
                    <button id="import-pdf-btn" disabled>导入PDF</button>
                    <div id="import-progress" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="import-progress-fill"></div>
                        </div>
                        <p id="import-progress-text">准备导入...</p>
                    </div>
                </div>
                <div id="selected-files" style="margin-top: 10px; font-size: 14px; color: #4a5568;"></div>
            </section>

            <section class="filter-section">
                <h3>AI筛选文献</h3>
                <div class="input-group">
                    <button id="start-filter-btn">开始AI筛选</button>
                    <div id="filter-progress" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="filter-progress-fill"></div>
                        </div>
                        <p id="filter-progress-text">准备开始筛选...</p>
                    </div>
                </div>
            </section>
            
            <section class="literature-section" id="literature-section" style="display: none;">
                <div class="section-header">
                    <h2>文献列表</h2>
                    <div class="literature-stats">
                        <span>总计: <strong id="total-count">0</strong> 篇</span>
                        <span>已选用: <strong id="selected-count">0</strong> 篇</span>
                        <span>未选用: <strong id="unselected-count">0</strong> 篇</span>
                    </div>
                </div>
                <div class="literature-controls">
                    <button id="select-all-btn">全选</button>
                    <button id="deselect-all-btn">全不选</button>
                    <button id="select-ai-recommended-btn">仅选AI推荐</button>
                    <button id="export-excel-btn">导出Excel</button>
                </div>
                <div class="literature-container" id="literature-container">
                    <div class="empty-state">
                        <p>暂无文献数据</p>
                    </div>
                </div>
            </section>
        </main>
        
        <footer>
            <div class="footer-controls">
                <button id="back-btn">返回主页面</button>
                <button id="confirm-btn" disabled>确认完成</button>
            </div>
        </footer>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM元素
            const currentProjectNameSpan = document.getElementById('current-project-name');
            const saveProjectBtn = document.getElementById('save-project-btn');
            const apiKeyInput = document.getElementById('api-key');
            const researchTopicDisplay = document.getElementById('research-topic-display');
            const startFilterBtn = document.getElementById('start-filter-btn');
            const filterProgress = document.getElementById('filter-progress');
            const filterProgressFill = document.getElementById('filter-progress-fill');
            const filterProgressText = document.getElementById('filter-progress-text');
            const literatureSection = document.getElementById('literature-section');
            const literatureContainer = document.getElementById('literature-container');
            const totalCount = document.getElementById('total-count');
            const selectedCount = document.getElementById('selected-count');
            const unselectedCount = document.getElementById('unselected-count');
            const selectAllBtn = document.getElementById('select-all-btn');
            const deselectAllBtn = document.getElementById('deselect-all-btn');
            const selectAiRecommendedBtn = document.getElementById('select-ai-recommended-btn');
            const exportExcelBtn = document.getElementById('export-excel-btn');
            const confirmBtn = document.getElementById('confirm-btn');
            const backBtn = document.getElementById('back-btn');
            const pdfFileInput = document.getElementById('pdf-file-input');
            const selectPdfBtn = document.getElementById('select-pdf-btn');
            const importPdfBtn = document.getElementById('import-pdf-btn');
            const importProgress = document.getElementById('import-progress');
            const importProgressFill = document.getElementById('import-progress-fill');
            const importProgressText = document.getElementById('import-progress-text');
            const selectedFilesDiv = document.getElementById('selected-files');
            
            // 数据存储
            let currentProject = null;
            let literatureList = []; // 文献列表，每篇包含 { ...literature, selected: boolean, aiRecommended: boolean, aiReason: string }
            let selectedPdfFiles = []; // 选中的PDF文件列表
            
            // 初始化当前项目信息并加载数据
            initCurrentProject();
            async function initCurrentProject() {
                if (!window.electronAPI) return;
                try {
                    const { success, currentProject: cp } = await window.electronAPI.getCurrentProject();
                    if (success && cp) {
                        currentProject = cp;
                        currentProjectNameSpan.textContent = cp;
                        // 加载项目数据
                        const result = await window.electronAPI.loadProjectData(cp);
                        if (result.success && result.data) {
                            loadProjectData(result.data);
                        }
                    } else {
                        alert('未选择项目，请在主页面先新建或打开项目。');
                    }
                } catch (e) {
                    console.error('获取当前项目失败:', e);
                }
            }
            
            // 加载项目数据
            function loadProjectData(data) {
                // 加载研究主题
                if (researchTopicDisplay) {
                    researchTopicDisplay.textContent = data.reviewDescription || data.userNeeds || data.researchTopic || '（未设置研究主题）';
                }
                
                // 加载API Key
                apiKeyInput.value = (data.config && data.config.apiKey) || data.apiKey || '';
                
                // 加载文献列表（模块1的最终结果）
                const finalResults = data.finalResults || data.allLiterature || [];
                if (finalResults.length > 0) {
                    // 如果已有筛选结果，使用筛选结果；否则使用模块1的原始结果
                    const filteredResults = data.module2 && data.module2.filteredResults ? data.module2.filteredResults : null;
                    
                    if (filteredResults && Array.isArray(filteredResults)) {
                        // 已有筛选结果，直接加载
                        literatureList = filteredResults;
                    } else {
                        // 首次进入模块2，初始化文献列表（默认未选用）
                        literatureList = finalResults.map(item => ({
                            ...item,
                            selected: false,
                            aiRecommended: false,
                            aiReason: ''
                        }));
                    }
                    
                    displayLiteratureList();
                    literatureSection.style.display = 'block';
                    updateStatistics();
                    updateConfirmButton();
                }
            }
            
            // 保存项目（合并保存）
            saveProjectBtn.addEventListener('click', async function() {
                const projectName = currentProject;
                if (!projectName) {
                    alert('未绑定项目，请返回主页面选择项目');
                    return;
                }
                
                const projectData = getModule2Patch();
                if (window.electronAPI) {
                    try {
                        await mergeAndSave(projectName, projectData);
                        alert(`项目 "${projectName}" 保存成功`);
                    } catch (error) {
                        console.error('保存项目失败:', error);
                        alert('保存项目失败: ' + error.message);
                    }
                }
            });
            
            // 获取模块2数据
            function getModule2Patch() {
                return {
                    module2: {
                        filteredResults: literatureList,
                        timestamp: new Date().toISOString()
                    },
                    timestamp: new Date().toISOString()
                };
            }

            // 深合并保存
            async function mergeAndSave(projectName, patch) {
                const existing = await window.electronAPI.loadProjectData(projectName);
                const base = (existing && existing.success && existing.data) ? existing.data : {};
                const merged = deepMerge(base, patch || {});
                return await window.electronAPI.saveProjectData(projectName, merged);
            }

            function deepMerge(target, source) {
                if (!source || typeof source !== 'object') return target;
                const out = Array.isArray(target) ? [...target] : { ...target };
                Object.keys(source).forEach(key => {
                    const srcVal = source[key];
                    const tgtVal = out[key];
                    if (srcVal && typeof srcVal === 'object' && !Array.isArray(srcVal)) {
                        out[key] = deepMerge(tgtVal && typeof tgtVal === 'object' ? tgtVal : {}, srcVal);
                    } else {
                        out[key] = srcVal;
                    }
                });
                return out;
            }
            
            // 开始AI筛选
            startFilterBtn.addEventListener('click', async function() {
                const apiKey = apiKeyInput.value.trim();
                if (!apiKey) {
                    alert('请输入DeepSeek API Key');
                    return;
                }
                
                if (literatureList.length === 0) {
                    alert('没有可筛选的文献，请先完成模块1的文献搜索');
                    return;
                }
                
                const researchTopic = researchTopicDisplay.textContent.trim();
                if (!researchTopic || researchTopic === '（将自动读取主页面研究主题）' || researchTopic === '（未设置研究主题）') {
                    alert('请先设置研究主题');
                    return;
                }
                
                // 显示进度条
                filterProgress.style.display = 'block';
                startFilterBtn.disabled = true;
                
                try {
                    // 统计需要筛选的文献数量
                    const needFilterList = literatureList.filter(item => {
                        // 检查是否已经筛选过（有aiReason字段且不为空）
                        return !item.aiReason || item.aiReason.trim() === '';
                    });
                    
                    const totalCount = literatureList.length;
                    const skipCount = totalCount - needFilterList.length;
                    
                    if (needFilterList.length === 0) {
                        alert('所有文献已经筛选完成，无需重新筛选');
                        filterProgress.style.display = 'none';
                        startFilterBtn.disabled = false;
                        return;
                    }
                    
                    let processedCount = 0;
                    let currentSkippedCount = skipCount;
                    
                    // 批量筛选文献（只筛选未筛选过的）
                    for (let i = 0; i < literatureList.length; i++) {
                        const item = literatureList[i];
                        const progress = ((i + 1) / totalCount) * 100;
                        
                        // 检查是否已经筛选过
                        if (item.aiReason && item.aiReason.trim() !== '') {
                            // 已筛选过，跳过
                            updateFilterProgress(progress, `跳过已筛选: ${item.title.substring(0, 30)}... (${i + 1}/${totalCount}, 已跳过 ${currentSkippedCount} 篇)`);
                            // 短暂延迟，让用户看到进度
                            await new Promise(resolve => setTimeout(resolve, 100));
                            continue;
                        }
                        
                        // 未筛选过，进行筛选
                        processedCount++;
                        updateFilterProgress(progress, `正在筛选: ${item.title.substring(0, 30)}... (${processedCount}/${needFilterList.length} 新筛选, 已跳过 ${currentSkippedCount} 篇)`);
                        
                        // 调用AI筛选
                        const filterResult = await filterLiteratureWithAI(item, researchTopic, apiKey);
                        item.aiRecommended = filterResult.recommended;
                        item.aiReason = filterResult.reason;
                        
                        // 如果AI推荐，默认选中
                        if (filterResult.recommended) {
                            item.selected = true;
                        }
                        
                        // 避免请求过于频繁
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                    
                    // 筛选完成
                    const finalSkippedCount = totalCount - processedCount;
                    updateFilterProgress(100, `筛选完成！新筛选 ${processedCount} 篇，跳过 ${finalSkippedCount} 篇已筛选的文献`);
                    setTimeout(() => {
                        filterProgress.style.display = 'none';
                        startFilterBtn.disabled = false;
                    }, 2000);
                    
                    // 更新显示
                    displayLiteratureList();
                    updateStatistics();
                    updateConfirmButton();
                    
                    // 自动保存
                    await autoSaveConfig();
                    
                    // 显示完成提示
                    if (finalSkippedCount > 0) {
                        alert(`筛选完成！\n新筛选: ${processedCount} 篇文献\n跳过: ${finalSkippedCount} 篇已筛选的文献`);
                    } else {
                        alert(`筛选完成！共筛选 ${processedCount} 篇文献`);
                    }
                    
                } catch (error) {
                    console.error('AI筛选失败:', error);
                    filterProgress.style.display = 'none';
                    startFilterBtn.disabled = false;
                    alert('AI筛选失败: ' + error.message);
                }
            });
            
            // 使用DeepSeek API筛选文献
            async function filterLiteratureWithAI(literature, researchTopic, apiKey) {
                const prompt = `你是一个学术研究助手。请根据研究主题，判断以下文献是否应该被选用用于文献综述。

研究主题：${researchTopic}

文献信息：
- 标题：${literature.title || '无'}
- 作者：${literature.authors || '无'}
- 年份：${literature.year || '无'}
- 来源：${literature.source || '无'}
- 摘要：${literature.abstract || '无'}
- 被引次数：${literature.cited || 0}

请判断这篇文献是否应该被选用。请用JSON格式回复，包含两个字段：
1. "recommended": true或false，表示是否推荐选用
2. "reason": 推荐或不推荐的理由（简洁说明，不超过50字）

只返回JSON，不要其他内容。`;

                const response = await fetch('https://api.deepseek.com/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [
                            {
                                "role": "system",
                                "content": "你是一个学术研究助手，专门帮助用户筛选文献。请根据研究主题和文献信息，给出专业的判断。"
                            },
                            {
                                "role": "user",
                                "content": prompt
                            }
                        ],
                        stream: false
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API请求失败: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                const content = data.choices[0].message.content;
                
                // 尝试解析JSON
                try {
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        const result = JSON.parse(jsonMatch[0]);
                        return {
                            recommended: result.recommended === true || result.recommended === 'true',
                            reason: result.reason || (result.recommended ? '推荐选用' : '不推荐选用')
                        };
                    }
                } catch (e) {
                    console.warn('解析AI回复失败:', e, content);
                }
                
                // 如果解析失败，尝试从文本中推断
                const lowerContent = content.toLowerCase();
                const recommended = lowerContent.includes('推荐') || lowerContent.includes('选用') || lowerContent.includes('true');
                return {
                    recommended: recommended,
                    reason: content.substring(0, 50) || (recommended ? 'AI推荐选用' : 'AI不推荐')
                };
            }
            
            // 更新筛选进度
            function updateFilterProgress(percent, text) {
                filterProgressFill.style.width = `${percent}%`;
                filterProgressText.textContent = text;
            }
            
            // 显示文献列表
            function displayLiteratureList() {
                if (literatureList.length === 0) {
                    literatureContainer.innerHTML = `
                        <div class="empty-state">
                            <p>暂无文献数据</p>
                        </div>
                    `;
                    return;
                }
                
                literatureContainer.innerHTML = '';
                
                literatureList.forEach((item, index) => {
                    const literatureItem = document.createElement('div');
                    literatureItem.className = `literature-item ${item.selected ? 'selected' : ''} ${item.aiRecommended ? 'ai-recommended' : ''}`;
                    
                    // 转义HTML
                    const escapeHtml = (text) => {
                        if (!text) return '';
                        const div = document.createElement('div');
                        div.textContent = text;
                        return div.innerHTML;
                    };
                    
                    literatureItem.innerHTML = `
                        <div class="literature-checkbox">
                            <input type="checkbox" id="lit-${index}" ${item.selected ? 'checked' : ''} data-index="${index}">
                            <label for="lit-${index}"></label>
                        </div>
                        <div class="literature-content">
                            <div class="literature-header">
                                <h3>${escapeHtml(item.title)}</h3>
                                ${item.aiRecommended ? '<span class="ai-badge">AI推荐</span>' : ''}
                            </div>
                            <div class="literature-meta">
                                <span class="authors">${escapeHtml(item.authors || '')}</span> | 
                                <span class="year">${escapeHtml(item.year || '')}</span> | 
                                <span class="source">${escapeHtml(item.source || '')}</span> | 
                                ${item.cited ? `<span class="cited">被引 ${item.cited}</span>` : ''}
                            </div>
                            <div class="literature-abstract">
                                <p>${escapeHtml(item.abstract || '')}</p>
                            </div>
                            ${item.aiReason ? `<div class="ai-reason">
                                <strong>AI判断：</strong>${escapeHtml(item.aiReason)}
                            </div>` : ''}
                            ${item.url ? `<div class="literature-url">
                                <a href="${escapeHtml(item.url)}" target="_blank">查看原文</a>
                            </div>` : ''}
                        </div>
                    `;
                    
                    literatureContainer.appendChild(literatureItem);
                });
                
                // 绑定复选框事件
                document.querySelectorAll('input[type="checkbox"][data-index]').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        const index = parseInt(this.getAttribute('data-index'));
                        literatureList[index].selected = this.checked;
                        updateStatistics();
                        updateConfirmButton();
                        // 更新样式
                        const item = this.closest('.literature-item');
                        if (this.checked) {
                            item.classList.add('selected');
                        } else {
                            item.classList.remove('selected');
                        }
                        // 自动保存
                        autoSaveConfig();
                    });
                });
            }
            
            // 更新统计信息
            function updateStatistics() {
                const total = literatureList.length;
                const selected = literatureList.filter(item => item.selected).length;
                const unselected = total - selected;
                
                totalCount.textContent = total;
                selectedCount.textContent = selected;
                unselectedCount.textContent = unselected;
            }
            
            // 全选
            selectAllBtn.addEventListener('click', function() {
                literatureList.forEach(item => item.selected = true);
                displayLiteratureList();
                updateStatistics();
                updateConfirmButton();
                autoSaveConfig();
            });
            
            // 全不选
            deselectAllBtn.addEventListener('click', function() {
                literatureList.forEach(item => item.selected = false);
                displayLiteratureList();
                updateStatistics();
                updateConfirmButton();
                autoSaveConfig();
            });
            
            // 仅选AI推荐
            selectAiRecommendedBtn.addEventListener('click', function() {
                literatureList.forEach(item => {
                    item.selected = item.aiRecommended === true;
                });
                displayLiteratureList();
                updateStatistics();
                updateConfirmButton();
                autoSaveConfig();
            });
            
            // 更新确认按钮状态
            function updateConfirmButton() {
                const hasSelected = literatureList.some(item => item.selected);
                confirmBtn.disabled = !hasSelected;
            }
            
            // 确认完成
            confirmBtn.addEventListener('click', async function() {
                const selectedLiterature = literatureList.filter(item => item.selected);
                if (selectedLiterature.length === 0) {
                    alert('请至少选择一篇文献');
                    return;
                }
                
                try {
                    const projectName = currentProject;
                    if (!projectName) {
                        alert('未绑定项目，无法保存');
                        return;
                    }
                    
                    const data = getModule2Patch();
                    data.status = 'module3';
                    await mergeAndSave(projectName, data);
                    alert(`文献整理完成，已选择 ${selectedLiterature.length} 篇文献，已保存至项目。`);
                    window.location.href = 'index.html';
                } catch (e) {
                    console.error('保存项目失败:', e);
                    alert('保存项目失败: ' + e.message);
                }
            });
            
            // 返回主页面
            backBtn.addEventListener('click', function() {
                if (confirm('确定要返回主页面吗？未保存的更改将会丢失。')) {
                    window.location.href = 'index.html';
                }
            });
            
            // 自动保存配置
            async function autoSaveConfig() {
                if (!currentProject) return;
                const data = getModule2Patch();
                try {
                    await mergeAndSave(currentProject, data);
                } catch (e) {
                    console.error('自动保存失败', e);
                }
            }
            
            // PDF文件选择
            selectPdfBtn.addEventListener('click', function() {
                pdfFileInput.click();
            });
            
            pdfFileInput.addEventListener('change', function(e) {
                const files = Array.from(e.target.files);
                selectedPdfFiles = files;
                
                if (files.length > 0) {
                    const fileNames = files.map(f => f.name).join(', ');
                    selectedFilesDiv.textContent = `已选择 ${files.length} 个文件: ${fileNames}`;
                    importPdfBtn.disabled = false;
                } else {
                    selectedFilesDiv.textContent = '';
                    importPdfBtn.disabled = true;
                }
            });
            
            // 导入PDF
            importPdfBtn.addEventListener('click', async function() {
                if (selectedPdfFiles.length === 0) {
                    alert('请先选择PDF文件');
                    return;
                }
                
                const apiKey = apiKeyInput.value.trim();
                if (!apiKey) {
                    alert('请先输入DeepSeek API Key');
                    return;
                }
                
                const researchTopic = researchTopicDisplay.textContent.trim();
                if (!researchTopic || researchTopic === '（将自动读取主页面研究主题）' || researchTopic === '（未设置研究主题）') {
                    alert('请先设置研究主题');
                    return;
                }
                
                importProgress.style.display = 'block';
                importPdfBtn.disabled = true;
                selectPdfBtn.disabled = true;
                
                try {
                    let successCount = 0;
                    let duplicateCount = 0;
                    let failCount = 0;
                    
                    // 循环处理每个PDF文件（一次只处理一个）
                    for (let i = 0; i < selectedPdfFiles.length; i++) {
                        const file = selectedPdfFiles[i];
                        const progress = ((i + 1) / selectedPdfFiles.length) * 100;
                        updateImportProgress(progress, `正在处理: ${file.name} (${i + 1}/${selectedPdfFiles.length})`);
                        
                        try {
                            // 直接使用大模型API提取文献信息
                            updateImportProgress(progress, `正在使用AI处理PDF: ${file.name} (${i + 1}/${selectedPdfFiles.length})`);
                            
                            // 尝试读取PDF文件内容（用于提取文本，如果可能）
                            let pdfText = '';
                            try {
                                const arrayBuffer = await file.arrayBuffer();
                                
                                // 尝试使用后端解析PDF获取文本（可选，失败不影响）
                                if (window.electronAPI && window.electronAPI.parsePdf) {
                                    const buffer = Buffer.from(arrayBuffer);
                                    const parseResult = await window.electronAPI.parsePdf(buffer, file.name);
                                    if (parseResult.success && parseResult.text) {
                                        pdfText = parseResult.text;
                                    }
                                }
                            } catch (e) {
                                console.warn('PDF文本提取失败，将仅根据文件名推断:', e);
                            }
                            
                            // 使用大模型API提取文献信息
                            const literature = await extractLiteratureFromPdfWithAI(
                                pdfText || null, // 如果有文本内容就传递，否则为null
                                file.name, 
                                researchTopic, 
                                apiKey
                            );
                            
                            if (literature) {
                                // 检查是否已存在重复文献（基于标题去重）
                                const isDuplicate = checkDuplicate(literature);
                                
                                if (isDuplicate) {
                                    console.log(`跳过重复文献: ${literature.title}`);
                                    duplicateCount++;
                                    updateImportProgress(progress, `跳过重复文献: ${file.name} (${i + 1}/${selectedPdfFiles.length})`);
                                } else {
                                    // 添加到文献列表
                                    const newLiterature = {
                                        ...literature,
                                        selected: false,
                                        aiRecommended: false,
                                        aiReason: '',
                                        source: literature.source || 'PDF导入',
                                        url: '',
                                        pdfFileName: file.name
                                    };
                                    literatureList.push(newLiterature);
                                    successCount++;
                                }
                            } else {
                                failCount++;
                            }
                            
                            // 避免请求过于频繁，每个文件处理完后等待
                            if (i < selectedPdfFiles.length - 1) {
                                await new Promise(resolve => setTimeout(resolve, 1000));
                            }
                            
                        } catch (error) {
                            console.error(`处理PDF文件 ${file.name} 失败:`, error);
                            failCount++;
                            // 继续处理下一个文件，不中断整个流程
                        }
                    }
                    
                    // 导入完成
                    updateImportProgress(100, '导入完成');
                    
                    // 更新显示
                    displayLiteratureList();
                    updateStatistics();
                    updateConfirmButton();
                    literatureSection.style.display = 'block';
                    
                    // 自动保存
                    await autoSaveConfig();
                    
                    setTimeout(() => {
                        importProgress.style.display = 'none';
                        importPdfBtn.disabled = false;
                        selectPdfBtn.disabled = false;
                        pdfFileInput.value = '';
                        selectedPdfFiles = [];
                        selectedFilesDiv.textContent = '';
                        
                        let message = `导入完成！\n成功导入: ${successCount} 个文件`;
                        if (duplicateCount > 0) {
                            message += `\n跳过重复: ${duplicateCount} 个文件`;
                        }
                        if (failCount > 0) {
                            message += `\n处理失败: ${failCount} 个文件`;
                        }
                        message += `\n共添加 ${successCount} 篇新文献到列表`;
                        alert(message);
                    }, 1000);
                    
                } catch (error) {
                    console.error('导入PDF失败:', error);
                    importProgress.style.display = 'none';
                    importPdfBtn.disabled = false;
                    selectPdfBtn.disabled = false;
                    alert('导入PDF失败: ' + error.message);
                }
            });
            
            // 检查文献是否重复（基于标题相似度）
            function checkDuplicate(newLiterature) {
                if (!newLiterature || !newLiterature.title) {
                    return false;
                }
                
                const newTitle = newLiterature.title.toLowerCase().trim();
                
                // 遍历现有文献列表，检查是否有相同或相似的标题
                for (const existing of literatureList) {
                    if (!existing || !existing.title) continue;
                    
                    const existingTitle = existing.title.toLowerCase().trim();
                    
                    // 完全匹配
                    if (newTitle === existingTitle) {
                        return true;
                    }
                    
                    // 相似度检查：如果标题相似度很高（去掉标点符号后相似），也认为是重复
                    const normalizeTitle = (title) => {
                        return title.replace(/[^\w\s]/g, '').replace(/\s+/g, ' ').trim();
                    };
                    
                    const normalizedNew = normalizeTitle(newTitle);
                    const normalizedExisting = normalizeTitle(existingTitle);
                    
                    // 如果规范化后的标题相同
                    if (normalizedNew === normalizedExisting && normalizedNew.length > 10) {
                        return true;
                    }
                    
                    // 如果一个是另一个的子串（且长度差异不大），也认为是重复
                    if (normalizedNew.length > 20 && normalizedExisting.length > 20) {
                        const similarity = calculateSimilarity(normalizedNew, normalizedExisting);
                        if (similarity > 0.9) { // 相似度超过90%
                            return true;
                        }
                    }
                }
                
                return false;
            }
            
            // 计算两个字符串的相似度（简单的编辑距离算法）
            function calculateSimilarity(str1, str2) {
                if (str1 === str2) return 1.0;
                if (str1.length === 0 || str2.length === 0) return 0.0;
                
                const longer = str1.length > str2.length ? str1 : str2;
                const shorter = str1.length > str2.length ? str2 : str1;
                
                // 如果较短的字符串是较长的字符串的子串，相似度较高
                if (longer.indexOf(shorter) !== -1) {
                    return shorter.length / longer.length;
                }
                
                // 简单的字符匹配率
                let matches = 0;
                const minLength = Math.min(str1.length, str2.length);
                for (let i = 0; i < minLength; i++) {
                    if (str1[i] === str2[i]) {
                        matches++;
                    }
                }
                
                return matches / Math.max(str1.length, str2.length);
            }
            
            // 使用大模型API从PDF中提取文献信息（与模块1搜索结果的字段结构一致）
            async function extractLiteratureFromPdfWithAI(pdfText, filename, researchTopic, apiKey) {
                let prompt = '';
                
                if (pdfText && pdfText.trim().length > 0) {
                    // 如果有PDF文本内容，使用文本提取（更准确）
                    // 限制文本长度，避免超出API限制（保留前10000字符）
                    const limitedText = pdfText.substring(0, 10000);
                    
                    prompt = `You are an academic literature information extraction assistant. Please accurately extract key information from the following PDF document text content.

Research Topic: ${researchTopic}

PDF Filename: ${filename}

PDF Text Content (first 10000 characters):
${limitedText}

Please accurately extract the following information from the text:
1. Title: The complete title of the paper, preferably extracted from the beginning of the text or the title section
2. Authors: All author names, separated by commas, preferably extracted from the author information section
3. Year: The publication year of the paper, find a 4-digit year in the text
4. Source: Journal name, conference name, or publishing institution, find it in the text
5. Abstract: The abstract content of the paper, preferably find the Abstract section, if not available, summarize based on the content (200-300 words)
6. Cited: The number of citations (if available in the text, otherwise use 0)

Important: Please identify the language of the literature. If it is an English paper, output all fields in English. If it is a Chinese paper, output all fields in Chinese. Keep the original language of the content.

Please reply in JSON format with the following fields:
{
  "title": "Paper Title",
  "authors": "Author1, Author2, Author3",
  "year": "2023",
  "source": "Journal/Conference Name",
  "abstract": "Abstract content",
  "cited": 0
}

Only return JSON, no other content. If a field cannot be extracted from the text, use an empty string "".`;
                } else {
                    // 如果没有PDF文本内容，根据文件名和基本信息推断
                    prompt = `You are an academic literature information extraction assistant. Please infer key information about the literature based on the PDF filename and research topic.

Research Topic: ${researchTopic}

PDF Filename: ${filename}

Note: Unable to directly read PDF content. Please infer literature information as accurately as possible based on the filename format and related research topic. Filenames usually contain the paper title or related keywords.

Please infer the following information based on the filename:
1. Title: Infer the complete paper title from the filename (the filename is usually the title or contains title keywords, please format it as a complete paper title)
2. Authors: Infer possible authors from the filename format or research topic (if the filename contains author names, extract them; otherwise use empty string)
3. Year: Find a 4-digit year in the filename (such as 2023, 2024, etc.), if not found, use empty string
4. Source: Infer possible journal, conference, or publishing institution from the filename format (if unable to infer, use "PDF导入")
5. Abstract: Generate a possible abstract description (200-300 words) based on keywords in the filename and research topic, describing the research content and direction that the literature may involve

Important: Please identify the language based on the filename. If the filename suggests an English paper, output all fields in English. If it suggests a Chinese paper, output all fields in Chinese.

Please reply in JSON format with the following fields:
{
  "title": "Paper Title",
  "authors": "Author1, Author2, Author3",
  "year": "2023",
  "source": "Journal/Conference Name",
  "abstract": "Abstract content",
  "cited": 0
}

Only return JSON, no other content. If a field cannot be inferred, use an empty string "".`;
                }

                try {
                    const response = await fetch('https://api.deepseek.com/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: "deepseek-chat",
                            messages: [
                                {
                                    "role": "system",
                                    "content": "你是一个专业的学术文献信息提取助手。请仔细分析PDF文本内容，准确提取文献的标题、作者、年份、来源和摘要信息。"
                                },
                                {
                                    "role": "user",
                                    "content": prompt
                                }
                            ],
                            stream: false
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API请求失败: ${response.status} ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    const content = data.choices[0].message.content;
                    
                    // 尝试解析JSON
                    try {
                        const jsonMatch = content.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            const result = JSON.parse(jsonMatch[0]);
                            
                            // 验证并构建文献对象（与模块1搜索结果的字段结构一致）
                            const literature = {
                                title: result.title || filename.replace('.pdf', ''),
                                authors: result.authors || (result.title && result.title.match(/[a-zA-Z]/) ? 'Unknown Author' : '未知作者'),
                                year: result.year || '',
                                source: result.source || 'PDF导入',
                                abstract: result.abstract || (pdfText ? pdfText.substring(0, 300) + '...' : ''),
                                cited: result.cited || 0,
                                url: '',
                                pdfFileName: filename
                            };
                            
                            return literature;
                        }
                    } catch (e) {
                        console.warn('解析AI回复失败:', e, content);
                    }
                    
                    // 如果解析失败，使用文件名作为基本信息
                    const title = filename.replace('.pdf', '');
                    const isEnglish = /[a-zA-Z]/.test(title);
                    const fallbackAbstract = pdfText ? pdfText.substring(0, 300) + '...' : 
                        (isEnglish ? `Abstract inferred from filename "${filename}" and research topic "${researchTopic}".` : 
                         `根据文件名"${filename}"和研究主题"${researchTopic}"推断的文献摘要。`);
                    
                    return {
                        title: title,
                        authors: isEnglish ? 'Unknown Author' : '未知作者',
                        year: '',
                        source: 'PDF导入',
                        abstract: fallbackAbstract,
                        cited: 0,
                        url: '',
                        pdfFileName: filename
                    };
                    
                } catch (error) {
                    console.error('AI提取文献信息失败:', error);
                    throw error;
                }
            }
            
            // 更新导入进度
            function updateImportProgress(percent, text) {
                importProgressFill.style.width = `${percent}%`;
                importProgressText.textContent = text;
            }
            
            // 导出Excel(CSV)
            exportExcelBtn.addEventListener('click', function() {
                if (!literatureList || literatureList.length === 0) {
                    alert('没有可导出的数据');
                    return;
                }
                
                // 导出所有文献数据，包含模块2的额外字段
                const headers = ['Title', 'Authors', 'Year', 'Source', 'Cited', 'URL', 'Abstract', 'Selected', 'AI Recommended', 'AI Reason', 'PDF File Name'];
                const rows = literatureList.map(it => {
                    // 确保每个字段都正确处理，避免数据错位
                    return [
                        safeCsv(it.title || ''),
                        safeCsv(it.authors || ''),
                        safeCsv(it.year || ''),
                        safeCsv(it.source || ''),
                        safeCsv(it.cited || '0'),
                        safeCsv(it.url || ''),
                        safeCsv(it.abstract || ''),
                        safeCsv(it.selected ? '是' : '否'),
                        safeCsv(it.aiRecommended ? '是' : '否'),
                        safeCsv(it.aiReason || ''),
                        safeCsv(it.pdfFileName || '')
                    ];
                });
                
                // 构建CSV内容
                const csvRows = [headers.join(',')];
                rows.forEach(row => {
                    csvRows.push(row.join(','));
                });
                
                // 添加UTF-8 BOM以支持Excel正确显示中文
                const BOM = '\uFEFF';
                const csv = BOM + csvRows.join('\n');
                
                downloadText(csv, `literature_organized_${Date.now()}.csv`, 'text/csv;charset=utf-8;');
            });

            function safeCsv(v) {
                if (v === undefined || v === null) {
                    return '';
                }
                
                // 转换为字符串
                let s = String(v);
                
                // 替换换行符为空格，避免CSV格式错误
                s = s.replace(/\r\n/g, ' ').replace(/\n/g, ' ').replace(/\r/g, ' ');
                
                // 如果包含逗号、引号或换行符，需要用引号包裹
                if (/[",\n\r]/.test(s)) {
                    // 将内部的引号转义为双引号
                    s = '"' + s.replace(/"/g, '""') + '"';
                }
                
                return s;
            }

            function downloadText(text, filename, mime) {
                // 使用Blob并指定UTF-8编码
                const blob = new Blob(['\uFEFF' + text], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            
            // 参数变更自动保存
            apiKeyInput.addEventListener('change', autoSaveConfig);
            apiKeyInput.addEventListener('blur', autoSaveConfig);
        });
        
        // Electron IPC API
        window.electronAPI = {
            saveProjectData: (projectName, data) => {
                if (window.require) {
                    const { ipcRenderer } = window.require('electron');
                    return ipcRenderer.invoke('save-project-data', projectName, data);
                }
            },
            loadProjectData: (projectName) => {
                if (window.require) {
                    const { ipcRenderer } = window.require('electron');
                    return ipcRenderer.invoke('load-project-data', projectName);
                }
            },
            getCurrentProject: () => {
                if (window.require) {
                    const { ipcRenderer } = window.require('electron');
                    return ipcRenderer.invoke('get-current-project');
                }
            },
            parsePdf: (buffer, filename) => {
                if (window.require) {
                    const { ipcRenderer } = window.require('electron');
                    return ipcRenderer.invoke('parse-pdf', buffer, filename);
                }
            }
        };
    </script>
</body>
</html>

