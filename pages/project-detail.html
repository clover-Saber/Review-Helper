<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review Helper - é¡¹ç›®è¯¦æƒ…</title>
    <link rel="stylesheet" href="index.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Review Helper - AIé©±åŠ¨çš„æ–‡çŒ®ç»¼è¿°æ™ºèƒ½åŠ©æ‰‹</h1>
            <p>Review Helper ç°å·²å¼€æºï¼Œæ¬¢è¿å¤§å®¶ä½¿ç”¨ï¼GitHubåœ°å€ï¼š<a href="https://github.com/clover-Saber/Review-Helper.git" target="_blank">Review Helper</a></p>
        </header>
        
        <main>
            <!-- é¡¹ç›®è¯¦æƒ…é¡µé¢ -->
            <section class="project-detail-section" id="project-detail-section">
                <div class="project-detail-header">
                    <button id="back-to-list-btn" class="btn-back">â† è¿”å›é¡¹ç›®åˆ—è¡¨</button>
                    <h2 id="project-detail-name">é¡¹ç›®åç§°</h2>
                </div>
                <div class="project-detail-body" id="project-detail-body">
                    <!-- é¡¹ç›®é…ç½®å’Œå­é¡¹ç›®åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </section>
        </main>
        
        <footer>
            <p>Â© 2025 Review Helper - åŠ©åŠ›ç§‘ç ”å·¥ä½œè€…é«˜æ•ˆå®Œæˆæ–‡çŒ®ç»¼è¿°</p>
        </footer>
        
        <!-- Toasté€šçŸ¥ -->
        <div id="toast" class="toast" style="display: none;">
            <div class="toast-content">
                <span class="toast-message" id="toast-message"></span>
            </div>
        </div>
        
        <!-- è¾“å…¥å¯¹è¯æ¡†æ¨¡æ€æ¡† -->
        <div id="input-dialog-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <h3 id="input-dialog-title">è¾“å…¥</h3>
                <label id="input-dialog-label" for="input-dialog-input">è¯·è¾“å…¥:</label>
                <input type="text" id="input-dialog-input" placeholder="è¯·è¾“å…¥..." autofocus>
                <div class="modal-actions">
                    <button id="input-dialog-cancel">å–æ¶ˆ</button>
                    <button id="input-dialog-ok">ç¡®å®š</button>
                </div>
            </div>
        </div>
        
        <!-- ç»Ÿä¸€æ¨¡å—åŠ è½½ -->
        <script src="modules/electron-api.js"></script>
        <script src="modules/api.js"></script>
        <script src="modules/ui-utils.js"></script>
        <script src="modules/data-manager.js"></script>
        <script src="modules/subproject-manager.js"></script>
        
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // ç»‘å®šè¿”å›æŒ‰é’®
                const backBtn = document.getElementById('back-to-list-btn');
                if (backBtn) {
                    backBtn.addEventListener('click', async function() {
                        try {
                            console.log('ç‚¹å‡»è¿”å›é¡¹ç›®åˆ—è¡¨æŒ‰é’®');
                            // æ¸…é™¤å½“å‰é¡¹ç›®çŠ¶æ€ï¼Œé¿å…è‡ªåŠ¨é‡æ–°æ‰“å¼€
                            if (window.electronAPI && window.electronAPI.setCurrentProject) {
                                await window.electronAPI.setCurrentProject(null);
                                console.log('å·²æ¸…é™¤å½“å‰é¡¹ç›®çŠ¶æ€');
                            }
                            // æ¸…é™¤å­é¡¹ç›®ID
                            sessionStorage.removeItem('currentSubprojectId');
                            
                            if (window.electronAPI && window.electronAPI.switchToProjectList) {
                                const result = await window.electronAPI.switchToProjectList();
                                console.log('switchToProjectList è¿”å›ç»“æœ:', result);
                                if (result && !result.success) {
                                    const errorMsg = result?.error || 'æœªçŸ¥é”™è¯¯';
                                    console.error('è¿”å›é¡¹ç›®åˆ—è¡¨å¤±è´¥:', errorMsg);
                                    if (window.UIUtils && window.UIUtils.showToast) {
                                        window.UIUtils.showToast('è¿”å›é¡¹ç›®åˆ—è¡¨å¤±è´¥: ' + errorMsg, 'error');
                                    } else {
                                        alert('è¿”å›é¡¹ç›®åˆ—è¡¨å¤±è´¥: ' + errorMsg);
                                    }
                                }
                            } else {
                                console.error('electronAPI.switchToProjectList ä¸å­˜åœ¨');
                                if (window.UIUtils && window.UIUtils.showToast) {
                                    window.UIUtils.showToast('æ— æ³•è¿”å›é¡¹ç›®åˆ—è¡¨ï¼ˆAPIä¸å­˜åœ¨ï¼‰', 'error');
                                } else {
                                    alert('æ— æ³•è¿”å›é¡¹ç›®åˆ—è¡¨ï¼ˆAPIä¸å­˜åœ¨ï¼‰');
                                }
                            }
                        } catch (error) {
                            console.error('è¿”å›é¡¹ç›®åˆ—è¡¨è¿‡ç¨‹å‡ºé”™:', error);
                            if (window.UIUtils && window.UIUtils.showToast) {
                                window.UIUtils.showToast('è¿”å›é¡¹ç›®åˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
                            } else {
                                alert('è¿”å›é¡¹ç›®åˆ—è¡¨å¤±è´¥: ' + error.message);
                            }
                        }
                    });
                }
                
                // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºé¡¹ç›®è¯¦æƒ…
                loadProjectDetail();
                
                // åŠ è½½é¡¹ç›®è¯¦æƒ…
                async function loadProjectDetail() {
                    if (!window.electronAPI) return;
                    try {
                        const { success, currentProject: cp } = await window.electronAPI.getCurrentProject();
                        if (success && cp) {
                            await showProjectDetail(cp);
                        } else {
                            // æ²¡æœ‰å½“å‰é¡¹ç›®ï¼Œè¿”å›é¡¹ç›®åˆ—è¡¨
                            if (window.electronAPI.switchToProjectList) {
                                await window.electronAPI.switchToProjectList();
                            }
                        }
                    } catch (e) {
                        console.error('åŠ è½½é¡¹ç›®è¯¦æƒ…å¤±è´¥:', e);
                        alert('åŠ è½½é¡¹ç›®è¯¦æƒ…å¤±è´¥: ' + e.message);
                    }
                }
                
                // æ˜¾ç¤ºé¡¹ç›®è¯¦æƒ…é¡µé¢ï¼ˆé¡¹ç›®ä¸»é¡µï¼‰
                async function showProjectDetail(projectName) {
                    if (!window.electronAPI) return;
                    try {
                        const result = await window.electronAPI.loadProjectData(projectName);
                        if (!result.success || !result.data) {
                            alert('åŠ è½½é¡¹ç›®å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                            return;
                        }
                        
                        const data = result.data;
                        // ä»ç‹¬ç«‹æ–‡ä»¶åŠ è½½å­é¡¹ç›®æ•°æ®
                        let literatureSubprojects = [];
                        let reviewSubprojects = [];
                        
                        if (window.SubprojectManager) {
                            try {
                                literatureSubprojects = await window.SubprojectManager.getSubprojectsByType(projectName, 'literatureSearch');
                                reviewSubprojects = await window.SubprojectManager.getSubprojectsByType(projectName, 'reviewWriting');
                            } catch (error) {
                                console.error('åŠ è½½å­é¡¹ç›®åˆ—è¡¨å¤±è´¥:', error);
                                // å¦‚æœåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨ç©ºæ•°ç»„
                                literatureSubprojects = [];
                                reviewSubprojects = [];
                            }
                        }
                        
                        // è·å–é¡¹ç›®é…ç½®ä¿¡æ¯
                        const config = data.config || {};
                        const apiKeys = config.apiKeys || {};
                        const googleScholarVerified = config.googleScholarVerified || false;
                        const lanfanshuVerified = config.lanfanshuVerified || false;
                        const description = data.description || '';
                        const requirementData = data.requirementData || {};
                        const requirement = requirementData.requirement || 'æœªè®¾ç½®';
                        const targetCount = requirementData.targetCount || 50;
                        const outline = requirementData.outline || 'æœªè®¾ç½®';
                        const language = requirementData.language || 'zh';
                        const createdAt = data.createdAt ? new Date(data.createdAt).toLocaleDateString('zh-CN') : 'æœªçŸ¥';
                        const updatedAt = data.updatedAt ? new Date(data.updatedAt).toLocaleDateString('zh-CN') : 'æœªçŸ¥';
                        
                        // æ›´æ–°é¡¹ç›®è¯¦æƒ…é¡µé¢æ ‡é¢˜
                        document.getElementById('project-detail-name').textContent = projectName;
                        
                        // ç”Ÿæˆé¡¹ç›®é…ç½®ä¿¡æ¯HTMLï¼ˆæ”¯æŒç¼–è¾‘ï¼‰
                        const configHtml = `
                            <div class="project-config-section">
                                <div class="config-header">
                                    <h3>é¡¹ç›®é…ç½®</h3>
                                    <button id="edit-config-btn" class="btn-edit">ç¼–è¾‘</button>
                                    <button id="save-config-btn" class="btn-save" style="display: none;">ä¿å­˜</button>
                                    <button id="cancel-config-btn" class="btn-cancel" style="display: none;">å–æ¶ˆ</button>
                                </div>
                                <div class="config-content">
                                    <div class="config-item">
                                        <label>é¡¹ç›®ç®€ä»‹ï¼š</label>
                                        <div class="config-value" id="config-description-display">${escapeHtml(description) || 'æœªè®¾ç½®'}</div>
                                        <textarea id="config-description-edit" class="config-input" style="display: none;" rows="3" placeholder="è¯·è¾“å…¥é¡¹ç›®ç®€ä»‹...">${escapeHtml(description)}</textarea>
                                    </div>
                                    <div class="config-item">
                                        <label>åˆ›å»ºæ—¶é—´ï¼š</label>
                                        <div class="config-value">${createdAt}</div>
                                    </div>
                                    <div class="config-item">
                                        <label>æ›´æ–°æ—¶é—´ï¼š</label>
                                        <div class="config-value">${updatedAt}</div>
                                    </div>
                                </div>
                                
                                <!-- ç½‘ç»œç¯å¢ƒæ£€æŸ¥ -->
                                <div class="config-section-divider"></div>
                                <div class="config-subsection">
                                    <h4>ç½‘ç»œç¯å¢ƒæ£€æŸ¥</h4>
                                    <div class="config-item">
                                        <label>Google Scholarï¼š</label>
                                        <div class="config-value">
                                            <span id="scholar-status" class="status-badge ${googleScholarVerified ? 'status-verified' : 'status-unverified'}">
                                                ${googleScholarVerified ? 'âœ“ å·²éªŒè¯' : 'âœ— æœªéªŒè¯'}
                                            </span>
                                            <button id="verify-scholar-btn" class="btn-verify" style="margin-left: 10px;">${googleScholarVerified ? 'é‡æ–°éªŒè¯' : 'éªŒè¯ç™»å½•'}</button>
                                            <button id="speed-test-scholar-btn" class="btn-verify" style="margin-left: 10px; background: #10b981; color: white;">âš¡ æµ‹é€Ÿ</button>
                                            <span id="scholar-speed-result" style="margin-left: 10px; color: #666; font-size: 12px;"></span>
                                        </div>
                                    </div>
                                    <div class="config-item" style="margin-top: 15px;">
                                        <label>çƒ‚ç•ªè–¯å­¦æœ¯ï¼ˆGoogle Scholarå›½å†…é•œåƒï¼‰ï¼š</label>
                                        <div class="config-value">
                                            <span id="lanfanshu-status" class="status-badge ${lanfanshuVerified ? 'status-verified' : 'status-unverified'}">
                                                ${lanfanshuVerified ? 'âœ“ å·²éªŒè¯' : 'âœ— æœªéªŒè¯'}
                                            </span>
                                            <button id="verify-lanfanshu-btn" class="btn-verify" style="margin-left: 10px;">${lanfanshuVerified ? 'é‡æ–°éªŒè¯' : 'éªŒè¯ç™»å½•'}</button>
                                            <button id="speed-test-lanfanshu-btn" class="btn-verify" style="margin-left: 10px; background: #10b981; color: white;">âš¡ æµ‹é€Ÿ</button>
                                            <span id="lanfanshu-speed-result" style="margin-left: 10px; color: #666; font-size: 12px;"></span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- API Keyç®¡ç† -->
                                <div class="config-section-divider"></div>
                                <div class="config-subsection">
                                    <h4>å¤§æ¨¡å‹API Keyç®¡ç†</h4>
                                    <div class="api-keys-list">
                                        <div class="api-key-item">
                                            <div class="api-key-label-row">
                                                <label>DeepSeek API Keyï¼š</label>
                                                <a href="https://api-docs.deepseek.com/zh-cn/api/deepseek-api/" target="_blank" class="api-docs-link">
                                                    ğŸ”— API ç”³è¯·åœ°å€
                                                </a>
                                            </div>
                                            <div class="api-key-input-wrapper">
                                                <input type="password" id="api-key-deepseek" class="api-key-input" placeholder="è¯·è¾“å…¥DeepSeek API Key" value="${apiKeys.deepseek || ''}">
                                                <button class="btn-save-key" data-provider="deepseek">ä¿å­˜</button>
                                            </div>
                                        </div>
                                        <div class="api-key-item">
                                            <div class="api-key-label-row">
                                                <label>Google Gemini API Keyï¼š</label>
                                                <a href="https://ai.google.dev/" target="_blank" class="api-docs-link">
                                                    ğŸ”— API ç”³è¯·åœ°å€
                                                </a>
                                            </div>
                                            <div class="api-key-input-wrapper">
                                                <input type="password" id="api-key-gemini" class="api-key-input" placeholder="è¯·è¾“å…¥Google Gemini API Key" value="${apiKeys.gemini || ''}">
                                                <button class="btn-save-key" data-provider="gemini">ä¿å­˜</button>
                                            </div>
                                        </div>
                                        <div class="api-key-item">
                                            <div class="api-key-label-row">
                                                <label>ç¡…åŸºæµåŠ¨ API Keyï¼š</label>
                                                <a href="https://siliconflow.cn/" target="_blank" class="api-docs-link">
                                                    ğŸ”— API ç”³è¯·åœ°å€
                                                </a>
                                            </div>
                                            <div class="api-key-input-wrapper">
                                                <input type="password" id="api-key-siliconflow" class="api-key-input" placeholder="è¯·è¾“å…¥ç¡…åŸºæµåŠ¨ API Key" value="${apiKeys.siliconflow || ''}">
                                                <button class="btn-save-key" data-provider="siliconflow">ä¿å­˜</button>
                                            </div>
                                        </div>
                                        <div class="api-key-item">
                                            <div class="api-key-label-row">
                                                <label>Poe API Keyï¼š</label>
                                                <a href="https://poe.com/api_key" target="_blank" class="api-docs-link">
                                                    ğŸ”— API ç”³è¯·åœ°å€
                                                </a>
                                            </div>
                                            <div class="api-key-input-wrapper">
                                                <input type="password" id="api-key-poe" class="api-key-input" placeholder="è¯·è¾“å…¥Poe API Key" value="${apiKeys.poe || ''}">
                                                <button class="btn-save-key" data-provider="poe">ä¿å­˜</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // ç”Ÿæˆå­é¡¹ç›®åˆ—è¡¨HTML
                        const subprojectsHtml = `
                            <div class="subprojects-container">
                                <div class="subprojects-type-section">
                                    <h3 class="subprojects-type-title">ğŸ“š æ–‡çŒ®æŸ¥æ‰¾å­é¡¹ç›®</h3>
                                    <div class="subprojects-list" data-project-name="${projectName}" data-type="literatureSearch">
                                        ${literatureSubprojects.length > 0 ? 
                                            literatureSubprojects.map(sp => {
                                                const spStatus = sp.status || 'pending';
                                                const spStatusText = {
                                                    'pending': 'å¾…å¼€å§‹',
                                                    'active': 'è¿›è¡Œä¸­',
                                                    'completed': 'å·²å®Œæˆ'
                                                }[spStatus] || 'æœªçŸ¥';
                                                const spStatusClass = {
                                                    'pending': 'status-pending',
                                                    'active': 'status-progress',
                                                    'completed': 'status-completed'
                                                }[spStatus] || 'status-pending';
                                                
                                                // è·å–é…ç½®ä¿¡æ¯
                                                const config = sp.config || {};
                                                const literatureSource = config.literatureSource || 'google-scholar';
                                                const language = config.language || 'zh';
                                                
                                                // æ–‡çŒ®åº“æ˜¾ç¤ºåç§°
                                                const sourceName = literatureSource === 'lanfanshu' ? 'çƒ‚ç•ªè–¯å­¦æœ¯' : 'Google Scholar';
                                                
                                                // è¯­è¨€æ˜¾ç¤ºåç§°
                                                const languageName = language === 'en' ? 'è‹±æ–‡' : 'ä¸­æ–‡';
                                                
                                                // è·å–æ‰¾åˆ°çš„æ–‡çŒ®æ•°é‡
                                                let literatureCount = 'æœªå®Œæˆ';
                                                if (sp.node4 && sp.node4.status === 'completed' && sp.node4.selectedLiterature && Array.isArray(sp.node4.selectedLiterature)) {
                                                    literatureCount = `${sp.node4.selectedLiterature.length} ç¯‡`;
                                                } else if (sp.node3 && sp.node3.status === 'completed' && sp.node3.allLiterature && Array.isArray(sp.node3.allLiterature)) {
                                                    literatureCount = `è¡¥å…¨ä¸­ (${sp.node3.allLiterature.length} ç¯‡)`;
                                                } else if (sp.node2 && sp.node2.status === 'completed' && sp.node2.searchResults) {
                                                    const totalCount = Object.values(sp.node2.searchResults).reduce((sum, results) => sum + (Array.isArray(results) ? results.length : 0), 0);
                                                    if (totalCount > 0) {
                                                        literatureCount = `æœç´¢ä¸­ (${totalCount} ç¯‡)`;
                                                    }
                                                }
                                                
                                                return `
                                                    <div class="subproject-item" data-subproject-id="${sp.id}">
                                                        <div class="subproject-info">
                                                            <div class="subproject-main-info">
                                                                <span class="subproject-name">${escapeHtml(sp.name || 'æœªå‘½å')}</span>
                                                                <span class="subproject-status ${spStatusClass}">${spStatusText}</span>
                                                            </div>
                                                            <div class="subproject-details">
                                                                <span class="subproject-detail-item">æ–‡çŒ®åº“: ${sourceName}</span>
                                                                <span class="subproject-detail-item">è¯­è¨€: ${languageName}</span>
                                                                <span class="subproject-detail-item">æ–‡çŒ®æ•°: ${literatureCount}</span>
                                                            </div>
                                                        </div>
                                                        <div class="subproject-actions">
                                                            <button class="subproject-open-btn" data-project-name="${projectName}" data-subproject-id="${sp.id}">è¿›å…¥</button>
                                                            <button class="subproject-delete-btn" data-project-name="${projectName}" data-subproject-id="${sp.id}" title="åˆ é™¤å­é¡¹ç›®">åˆ é™¤</button>
                                                        </div>
                                                    </div>
                                                `;
                                            }).join('') : 
                                            '<div class="empty-subprojects">æš‚æ— æ–‡çŒ®æŸ¥æ‰¾å­é¡¹ç›®</div>'
                                        }
                                        <button class="subproject-create-btn btn-primary" data-project-name="${projectName}" data-type="literatureSearch">+ æ–°å»ºæ–‡çŒ®æŸ¥æ‰¾å­é¡¹ç›®</button>
                                    </div>
                                </div>
                                <div class="subprojects-type-section">
                                    <h3 class="subprojects-type-title">âœï¸ ç»¼è¿°æ’°å†™å­é¡¹ç›®</h3>
                                    <div class="subprojects-list" data-project-name="${projectName}" data-type="reviewWriting">
                                        ${reviewSubprojects.length > 0 ? 
                                            reviewSubprojects.map(sp => {
                                                const spStatus = sp.status || 'pending';
                                                const spStatusText = {
                                                    'pending': 'å¾…å¼€å§‹',
                                                    'active': 'è¿›è¡Œä¸­',
                                                    'completed': 'å·²å®Œæˆ'
                                                }[spStatus] || 'æœªçŸ¥';
                                                const spStatusClass = {
                                                    'pending': 'status-pending',
                                                    'active': 'status-progress',
                                                    'completed': 'status-completed'
                                                }[spStatus] || 'status-pending';
                                                return `
                                                    <div class="subproject-item" data-subproject-id="${sp.id}">
                                                        <div class="subproject-info">
                                                            <span class="subproject-name">${escapeHtml(sp.name || 'æœªå‘½å')}</span>
                                                            <span class="subproject-status ${spStatusClass}">${spStatusText}</span>
                                                        </div>
                                                        <div class="subproject-actions">
                                                            <button class="subproject-open-btn" data-project-name="${projectName}" data-subproject-id="${sp.id}">è¿›å…¥</button>
                                                            <button class="subproject-delete-btn" data-project-name="${projectName}" data-subproject-id="${sp.id}" title="åˆ é™¤å­é¡¹ç›®">åˆ é™¤</button>
                                                        </div>
                                                    </div>
                                                `;
                                            }).join('') : 
                                            '<div class="empty-subprojects">æš‚æ— ç»¼è¿°æ’°å†™å­é¡¹ç›®</div>'
                                        }
                                        <button class="subproject-create-btn btn-primary" data-project-name="${projectName}" data-type="reviewWriting">+ æ–°å»ºç»¼è¿°æ’°å†™å­é¡¹ç›®</button>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // æ›´æ–°é¡¹ç›®è¯¦æƒ…é¡µé¢å†…å®¹
                        document.getElementById('project-detail-body').innerHTML = configHtml + subprojectsHtml;
                        
                        // ç»‘å®šé…ç½®ç¼–è¾‘äº‹ä»¶
                        bindConfigEvents(projectName);
                        
                        // ç»‘å®šå­é¡¹ç›®ç›¸å…³äº‹ä»¶
                        bindSubprojectEvents(projectName);
                        
                    } catch (e) {
                        console.error('æ˜¾ç¤ºé¡¹ç›®è¯¦æƒ…å¤±è´¥:', e);
                        alert('æ˜¾ç¤ºé¡¹ç›®è¯¦æƒ…å¤±è´¥: ' + e.message);
                    }
                }
                
                // ç»‘å®šé…ç½®ç¼–è¾‘äº‹ä»¶
                function bindConfigEvents(projectName) {
                    const editBtn = document.getElementById('edit-config-btn');
                    const saveBtn = document.getElementById('save-config-btn');
                    const cancelBtn = document.getElementById('cancel-config-btn');
                    
                    if (editBtn) {
                        editBtn.addEventListener('click', function() {
                            // åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼
                            const descDisplay = document.getElementById('config-description-display');
                            const descEdit = document.getElementById('config-description-edit');
                            if (descDisplay && descEdit) {
                                descDisplay.style.display = 'none';
                                descEdit.style.display = 'block';
                            }
                            
                            editBtn.style.display = 'none';
                            saveBtn.style.display = 'inline-block';
                            cancelBtn.style.display = 'inline-block';
                        });
                    }
                    
                    if (saveBtn) {
                        saveBtn.addEventListener('click', async function() {
                            await saveProjectConfig(projectName);
                        });
                    }
                    
                    if (cancelBtn) {
                        cancelBtn.addEventListener('click', function() {
                            // å–æ¶ˆç¼–è¾‘ï¼Œé‡æ–°åŠ è½½é¡¹ç›®è¯¦æƒ…
                            showProjectDetail(projectName);
                        });
                    }
                    
                    // ç»‘å®šAPI Keyä¿å­˜æŒ‰é’®
                    document.querySelectorAll('.btn-save-key').forEach(btn => {
                        btn.addEventListener('click', async function() {
                            const provider = this.getAttribute('data-provider');
                            const input = document.getElementById(`api-key-${provider}`);
                            if (input) {
                                await saveApiKey(projectName, provider, input.value);
                            }
                        });
                    });
                    
                    // ç»‘å®šGoogle ScholaréªŒè¯æŒ‰é’®
                    const verifyScholarBtn = document.getElementById('verify-scholar-btn');
                    if (verifyScholarBtn) {
                        verifyScholarBtn.addEventListener('click', async function() {
                            await verifyGoogleScholar(projectName);
                        });
                    }
                    
                    // ç»‘å®šçƒ‚ç•ªè–¯å­¦æœ¯éªŒè¯æŒ‰é’®
                    const verifyLanfanshuBtn = document.getElementById('verify-lanfanshu-btn');
                    if (verifyLanfanshuBtn) {
                        verifyLanfanshuBtn.addEventListener('click', async function() {
                            await verifyLanfanshu(projectName);
                        });
                    }
                    
                    // æµ‹é€ŸåŠŸèƒ½ï¼ˆåå°è¿è¡Œï¼Œä¸æ‰“å¼€çª—å£ï¼‰
                    async function speedTest(source, keyword = 'machine learning', limit = 5) {
                        const resultElementId = {
                            'google-scholar': 'scholar-speed-result',
                            'lanfanshu': 'lanfanshu-speed-result'
                        }[source];
                        
                        const resultElement = document.getElementById(resultElementId);
                        if (!resultElement) return;
                        
                        // æ£€æŸ¥APIæ˜¯å¦å¯ç”¨
                        if (!window.API) {
                            resultElement.textContent = 'âœ— APIæœªåŠ è½½';
                            resultElement.style.color = '#ef4444';
                            return;
                        }
                        
                        // æ˜¾ç¤ºæµ‹è¯•ä¸­
                        resultElement.textContent = 'æµ‹è¯•ä¸­...';
                        resultElement.style.color = '#666';
                        
                        const startTime = Date.now();
                        try {
                            let results = [];
                            
                            // è°ƒç”¨æœç´¢APIï¼ˆåå°è¿è¡Œï¼Œä½¿ç”¨éšè—çª—å£ï¼‰
                            if (source === 'google-scholar') {
                                if (!window.API.searchGoogleScholar) {
                                    throw new Error('searchGoogleScholaræ–¹æ³•ä¸å­˜åœ¨');
                                }
                                results = await window.API.searchGoogleScholar(keyword, limit);
                            } else if (source === 'lanfanshu') {
                                if (!window.API.searchLanfanshu) {
                                    throw new Error('searchLanfanshuæ–¹æ³•ä¸å­˜åœ¨');
                                }
                                // æµ‹é€Ÿæ—¶ä¸æ˜¾ç¤ºéªŒè¯ç çª—å£ï¼Œåå°è¿è¡Œ
                                results = await window.API.searchLanfanshu(keyword, limit, null, false);
                            } else {
                                throw new Error('æœªçŸ¥çš„æœç´¢æ¥æº: ' + source);
                            }
                            
                            const endTime = Date.now();
                            const duration = endTime - startTime;
                            
                            // æ‰“å°åŸå§‹ç»“æœåˆ°consoleï¼ˆç”¨äºè°ƒè¯•ï¼‰
                            console.log(`[æµ‹é€Ÿ ${source}] åŸå§‹ç»“æœ:`, results);
                            console.log(`[æµ‹é€Ÿ ${source}] ç»“æœç±»å‹:`, typeof results);
                            console.log(`[æµ‹é€Ÿ ${source}] æ˜¯å¦ä¸ºæ•°ç»„:`, Array.isArray(results));
                            if (results && Array.isArray(results)) {
                                console.log(`[æµ‹é€Ÿ ${source}] ç»“æœæ•°é‡:`, results.length);
                                if (results.length > 0) {
                                    console.log(`[æµ‹é€Ÿ ${source}] ç¬¬ä¸€ä¸ªç»“æœ:`, results[0]);
                                }
                            }
                            
                            // å¤„ç†ç»“æœ
                            if (results && Array.isArray(results) && results.length > 0) {
                                resultElement.textContent = `âœ“ æˆåŠŸ (${duration}ms, æ‰¾åˆ°${results.length}ç¯‡)`;
                                resultElement.style.color = '#10b981';
                            } else {
                                resultElement.textContent = `âœ— å¤±è´¥ (${duration}ms, æœªæ‰¾åˆ°ç»“æœ)`;
                                resultElement.style.color = '#ef4444';
                            }
                        } catch (error) {
                            const endTime = Date.now();
                            const duration = endTime - startTime;
                            const errorMsg = error.message || 'æœªçŸ¥é”™è¯¯';
                            resultElement.textContent = `âœ— é”™è¯¯ (${duration}ms, ${errorMsg})`;
                            resultElement.style.color = '#ef4444';
                            console.error(`æµ‹é€Ÿå¤±è´¥ (${source}):`, error);
                        }
                    }
                    
                    // ç»‘å®šGoogle Scholaræµ‹é€ŸæŒ‰é’®
                    const speedTestScholarBtn = document.getElementById('speed-test-scholar-btn');
                    if (speedTestScholarBtn) {
                        speedTestScholarBtn.addEventListener('click', async function() {
                            this.disabled = true;
                            this.textContent = 'æµ‹é€Ÿä¸­...';
                            await speedTest('google-scholar');
                            this.disabled = false;
                            this.textContent = 'âš¡ æµ‹é€Ÿ';
                        });
                    }
                    
                    // ç»‘å®šçƒ‚ç•ªè–¯å­¦æœ¯æµ‹é€ŸæŒ‰é’®
                    const speedTestLanfanshuBtn = document.getElementById('speed-test-lanfanshu-btn');
                    if (speedTestLanfanshuBtn) {
                        speedTestLanfanshuBtn.addEventListener('click', async function() {
                            this.disabled = true;
                            this.textContent = 'æµ‹é€Ÿä¸­...';
                            await speedTest('lanfanshu');
                            this.disabled = false;
                            this.textContent = 'âš¡ æµ‹é€Ÿ';
                        });
                    }
                }
                
                // ä¿å­˜é¡¹ç›®é…ç½®
                async function saveProjectConfig(projectName) {
                    if (!window.electronAPI || !window.DataManager) return;
                    
                    try {
                        const descEdit = document.getElementById('config-description-edit');
                        const description = descEdit ? descEdit.value.trim() : '';
                        
                        // è·å–å½“å‰é¡¹ç›®æ•°æ®ä»¥ä¿ç•™configä¸­çš„apiKeyså’ŒgoogleScholarVerified
                        const currentData = await window.electronAPI.loadProjectData(projectName);
                        const currentConfig = (currentData.success && currentData.data && currentData.data.config) || {};
                        const currentApiKeys = currentConfig.apiKeys || {};
                        const currentRequirementData = (currentData.success && currentData.data && currentData.data.requirementData) || {};
                        
                        // ä¿å­˜åˆ°é¡¹ç›®æ•°æ®ï¼ˆä¿ç•™requirementDataï¼Œåªæ›´æ–°descriptionï¼‰
                        await window.DataManager.saveProjectData(projectName, {
                            description: description,
                            requirementData: currentRequirementData, // ä¿ç•™åŸæœ‰çš„requirementData
                            config: {
                                ...currentConfig,
                                apiKeys: currentApiKeys // ä¿ç•™å·²æœ‰çš„API Keys
                            },
                            updatedAt: new Date().toISOString()
                        });
                        
                        showToast('é¡¹ç›®é…ç½®å·²ä¿å­˜', 'success');
                        
                        // é‡æ–°åŠ è½½é¡¹ç›®è¯¦æƒ…
                        await showProjectDetail(projectName);
                    } catch (e) {
                        console.error('ä¿å­˜é¡¹ç›®é…ç½®å¤±è´¥:', e);
                        showToast('ä¿å­˜é¡¹ç›®é…ç½®å¤±è´¥: ' + e.message, 'error');
                    }
                }
                
                // ä¿å­˜å•ä¸ªAPI Key
                async function saveApiKey(projectName, provider, apiKey) {
                    if (!window.electronAPI || !window.DataManager) return;
                    
                    try {
                        // è·å–å½“å‰é¡¹ç›®æ•°æ®
                        const currentData = await window.electronAPI.loadProjectData(projectName);
                        const currentConfig = (currentData.success && currentData.data && currentData.data.config) || {};
                        const currentApiKeys = currentConfig.apiKeys || {};
                        
                        // æ›´æ–°å¯¹åº”providerçš„API Key
                        currentApiKeys[provider] = apiKey.trim();
                        
                        // ä¿å­˜åˆ°é¡¹ç›®æ•°æ®
                        await window.DataManager.saveProjectData(projectName, {
                            config: {
                                ...currentConfig,
                                apiKeys: currentApiKeys
                            },
                            updatedAt: new Date().toISOString()
                        });
                        
                        showToast(`${provider} API Key å·²ä¿å­˜`, 'success');
                    } catch (e) {
                        console.error('ä¿å­˜API Keyå¤±è´¥:', e);
                        showToast('ä¿å­˜API Keyå¤±è´¥: ' + e.message, 'error');
                    }
                }
                
                // éªŒè¯Google Scholar
                async function verifyGoogleScholar(projectName) {
                    if (!window.electronAPI || !window.DataManager) return;
                    
                    try {
                        showToast('æ­£åœ¨æ‰“å¼€Google ScholaréªŒè¯çª—å£...', 'info');
                        
                        // æ‰“å¼€Google Scholarç™»å½•çª—å£ï¼Œå¹¶è‡ªåŠ¨å‘èµ·ä¸€ä¸ªè¾ƒå¤§çš„æœç´¢æ¥è§¦å‘äººæœºäº¤äº’ç•Œé¢
                        // ä½¿ç”¨é€šç”¨çš„å­¦æœ¯å…³é”®è¯å’Œè¾ƒå¤§çš„æœç´¢æ•°é‡
                        const result = await window.electronAPI.openScholarLogin('machine learning', 50);
                        
                        if (result && result.success) {
                            // éªŒè¯æˆåŠŸï¼Œæ›´æ–°é¡¹ç›®é…ç½®
                            const currentData = await window.electronAPI.loadProjectData(projectName);
                            const currentConfig = (currentData.success && currentData.data && currentData.data.config) || {};
                            
                            await window.DataManager.saveProjectData(projectName, {
                                config: {
                                    ...currentConfig,
                                    googleScholarVerified: true
                                },
                                updatedAt: new Date().toISOString()
                            });
                            
                            showToast('Google Scholar éªŒè¯æˆåŠŸ', 'success');
                            
                            // é‡æ–°åŠ è½½é¡¹ç›®è¯¦æƒ…
                            await showProjectDetail(projectName);
                        } else {
                            showToast('Google Scholar éªŒè¯å¤±è´¥: ' + (result?.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                        }
                    } catch (e) {
                        console.error('éªŒè¯Google Scholarå¤±è´¥:', e);
                        showToast('éªŒè¯Google Scholarå¤±è´¥: ' + e.message, 'error');
                    }
                }
                
                // éªŒè¯çƒ‚ç•ªè–¯å­¦æœ¯
                async function verifyLanfanshu(projectName) {
                    if (!window.electronAPI || !window.DataManager) return;
                    
                    try {
                        showToast('æ­£åœ¨æ‰“å¼€çƒ‚ç•ªè–¯å­¦æœ¯éªŒè¯çª—å£...', 'info');
                        
                        // æ‰“å¼€çƒ‚ç•ªè–¯å­¦æœ¯ç™»å½•çª—å£ï¼Œå¹¶è‡ªåŠ¨å‘èµ·ä¸€ä¸ªè¾ƒå¤§çš„æœç´¢æ¥è§¦å‘äººæœºäº¤äº’ç•Œé¢
                        // ä½¿ç”¨é€šç”¨çš„å­¦æœ¯å…³é”®è¯å’Œè¾ƒå¤§çš„æœç´¢æ•°é‡ï¼ˆ50ç¯‡ï¼Œæ›´å¥½åœ°è§¦å‘éªŒè¯ï¼‰
                        const result = await window.electronAPI.openLanfanshuLogin('machine learning', 50);
                        
                        if (result && result.success) {
                            // éªŒè¯æˆåŠŸï¼Œæ›´æ–°é¡¹ç›®é…ç½®
                            const currentData = await window.electronAPI.loadProjectData(projectName);
                            const currentConfig = (currentData.success && currentData.data && currentData.data.config) || {};
                            
                            await window.DataManager.saveProjectData(projectName, {
                                config: {
                                    ...currentConfig,
                                    lanfanshuVerified: true
                                },
                                updatedAt: new Date().toISOString()
                            });
                            
                            showToast('çƒ‚ç•ªè–¯å­¦æœ¯éªŒè¯æˆåŠŸ', 'success');
                            
                            // é‡æ–°åŠ è½½é¡¹ç›®è¯¦æƒ…
                            await showProjectDetail(projectName);
                        } else {
                            showToast('çƒ‚ç•ªè–¯å­¦æœ¯éªŒè¯å¤±è´¥: ' + (result?.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                        }
                    } catch (e) {
                        console.error('éªŒè¯çƒ‚ç•ªè–¯å­¦æœ¯å¤±è´¥:', e);
                        showToast('éªŒè¯çƒ‚ç•ªè–¯å­¦æœ¯å¤±è´¥: ' + e.message, 'error');
                    }
                }
                
                // ç»‘å®šå­é¡¹ç›®ç›¸å…³äº‹ä»¶
                function bindSubprojectEvents(projectName) {
                    // ç»‘å®šæ‰“å¼€å­é¡¹ç›®äº‹ä»¶
                    document.querySelectorAll('.subproject-open-btn').forEach(btn => {
                        btn.addEventListener('click', async function(e) {
                            e.stopPropagation();
                            const subprojectId = this.getAttribute('data-subproject-id');
                            await openSubproject(projectName, subprojectId);
                        });
                    });
                    
                    // ç»‘å®šåˆ é™¤å­é¡¹ç›®äº‹ä»¶
                    document.querySelectorAll('.subproject-delete-btn').forEach(btn => {
                        btn.addEventListener('click', async function(e) {
                            e.stopPropagation();
                            const subprojectId = this.getAttribute('data-subproject-id');
                            await deleteSubproject(projectName, subprojectId);
                        });
                    });
                    
                    // ç»‘å®šåˆ›å»ºå­é¡¹ç›®äº‹ä»¶
                    document.querySelectorAll('.subproject-create-btn').forEach(btn => {
                        btn.addEventListener('click', async function(e) {
                            e.stopPropagation();
                            const type = this.getAttribute('data-type');
                            await createSubproject(projectName, type);
                        });
                    });
                }
                
                // æ‰“å¼€å­é¡¹ç›®ï¼ˆè¿›å…¥å·¥ä½œæµé¡µé¢ï¼‰
                async function openSubproject(projectName, subprojectId) {
                    if (!window.electronAPI) return;
                    try {
                        // è®¾ç½®å½“å‰é¡¹ç›®
                        await window.electronAPI.setCurrentProject(projectName);
                        
                        // ä¿å­˜å­é¡¹ç›®IDåˆ°sessionStorageï¼Œå·¥ä½œæµé¡µé¢ä¼šè¯»å–
                        sessionStorage.setItem('currentSubprojectId', subprojectId);
                        
                        // è·å–å­é¡¹ç›®ç±»å‹ï¼Œæ ¹æ®ç±»å‹åˆ‡æ¢åˆ°ä¸åŒçš„å·¥ä½œæµé¡µé¢
                        const subproject = await window.SubprojectManager.getSubprojectData(projectName, subprojectId);
                        if (subproject && subproject.type === 'literatureSearch') {
                            // æ–‡çŒ®æŸ¥æ‰¾å­é¡¹ç›®ï¼Œåˆ‡æ¢åˆ°ä¸“é—¨çš„æ–‡çŒ®æŸ¥æ‰¾å·¥ä½œæµé¡µé¢
                            if (window.electronAPI.switchToLiteratureSearchWorkflow) {
                                await window.electronAPI.switchToLiteratureSearchWorkflow();
                            } else {
                                alert('æ— æ³•åˆ‡æ¢åˆ°æ–‡çŒ®æŸ¥æ‰¾å·¥ä½œæµç•Œé¢');
                            }
                        } else {
                            // ç»¼è¿°æ’°å†™å­é¡¹ç›®æˆ–å…¶ä»–ï¼Œä½¿ç”¨åŸæ¥çš„å·¥ä½œæµé¡µé¢
                            if (window.electronAPI.switchToWorkflow) {
                                await window.electronAPI.switchToWorkflow();
                            } else {
                                alert('æ— æ³•åˆ‡æ¢åˆ°å·¥ä½œæµç•Œé¢');
                            }
                        }
                    } catch (e) {
                        console.error('æ‰“å¼€å­é¡¹ç›®å¤±è´¥:', e);
                        alert('æ‰“å¼€å­é¡¹ç›®å¤±è´¥: ' + e.message);
                    }
                }
                
                // åˆ›å»ºå­é¡¹ç›®
                async function createSubproject(projectName, type) {
                    if (!window.electronAPI) return;
                    try {
                        const typeName = type === 'literatureSearch' ? 'æ–‡çŒ®æŸ¥æ‰¾' : 'ç»¼è¿°æ’°å†™';
                        
                        // ä½¿ç”¨æ¨¡æ€å¯¹è¯æ¡†è·å–å­é¡¹ç›®åç§°
                        const name = await window.electronAPI.showInputDialog({
                            title: `æ–°å»º${typeName}å­é¡¹ç›®`,
                            message: `è¯·è¾“å…¥${typeName}å­é¡¹ç›®çš„åç§°:`,
                            defaultValue: `${typeName}å­é¡¹ç›®`
                        });
                        if (!name || !name.trim()) {
                            return;
                        }
                        
                        const trimmedName = name.trim();
                        
                        // æ£€æŸ¥åç§°æ˜¯å¦é‡å¤ï¼ˆä»…é’ˆå¯¹æ–‡çŒ®æŸ¥æ‰¾å­é¡¹ç›®ï¼‰
                        if (type === 'literatureSearch' && window.SubprojectManager) {
                            const existingSubprojects = await window.SubprojectManager.getSubprojectsByType(projectName, type);
                            const duplicate = existingSubprojects.find(sp => sp.name === trimmedName);
                            if (duplicate) {
                                alert(`å­é¡¹ç›®åç§°"${trimmedName}"å·²å­˜åœ¨ï¼Œä¸èƒ½é‡å¤ï¼\n\nè¯·ä½¿ç”¨å…¶ä»–åç§°ã€‚`);
                                return;
                            }
                        }
                        
                        // æ–‡çŒ®æŸ¥æ‰¾å­é¡¹ç›®ä¸éœ€è¦æè¿°ï¼Œç»¼è¿°æ’°å†™å­é¡¹ç›®éœ€è¦æè¿°
                        let description = '';
                        if (type === 'reviewWriting') {
                            // ä½¿ç”¨æ¨¡æ€å¯¹è¯æ¡†è·å–å­é¡¹ç›®æè¿°ï¼ˆå¯é€‰ï¼‰
                            const desc = await window.electronAPI.showInputDialog({
                                title: `æ–°å»º${typeName}å­é¡¹ç›®`,
                                message: `è¯·è¾“å…¥${typeName}å­é¡¹ç›®çš„æè¿°ï¼ˆå¯é€‰ï¼Œç›´æ¥ç‚¹å‡»ç¡®å®šè·³è¿‡ï¼‰:`,
                                defaultValue: ''
                            });
                            description = desc ? desc.trim() : '';
                        }
                        
                        // è°ƒç”¨å­é¡¹ç›®ç®¡ç†å™¨åˆ›å»ºå­é¡¹ç›®
                        if (window.SubprojectManager) {
                            const subproject = await window.SubprojectManager.createSubproject(
                                projectName, 
                                type, 
                                trimmedName, 
                                description
                            );
                            
                            showToast(`${typeName}å­é¡¹ç›®"${trimmedName}"åˆ›å»ºæˆåŠŸ`);
                            
                            // åˆ·æ–°é¡¹ç›®è¯¦æƒ…
                            await showProjectDetail(projectName);
                        } else {
                            alert('å­é¡¹ç›®ç®¡ç†å™¨æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                        }
                    } catch (e) {
                        console.error('åˆ›å»ºå­é¡¹ç›®å¤±è´¥:', e);
                        alert('åˆ›å»ºå­é¡¹ç›®å¤±è´¥: ' + e.message);
                    }
                }
                
                // åˆ é™¤å­é¡¹ç›®
                async function deleteSubproject(projectName, subprojectId) {
                    if (!window.electronAPI) return;
                    try {
                        // è·å–å­é¡¹ç›®ä¿¡æ¯
                        let subprojectName = 'è¯¥å­é¡¹ç›®';
                        if (window.SubprojectManager) {
                            const subproject = await window.SubprojectManager.getSubprojectData(projectName, subprojectId);
                            if (subproject) {
                                subprojectName = subproject.name || subprojectName;
                            }
                        }
                        
                        const confirmed = confirm(`ç¡®å®šè¦åˆ é™¤å­é¡¹ç›®"${subprojectName}"å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`);
                        if (!confirmed) {
                            return;
                        }
                        
                        // è°ƒç”¨å­é¡¹ç›®ç®¡ç†å™¨åˆ é™¤å­é¡¹ç›®
                        if (window.SubprojectManager) {
                            await window.SubprojectManager.deleteSubproject(projectName, subprojectId);
                            showToast(`å­é¡¹ç›®"${subprojectName}"å·²åˆ é™¤`);
                            
                            // åˆ·æ–°é¡¹ç›®è¯¦æƒ…
                            await showProjectDetail(projectName);
                        } else {
                            alert('å­é¡¹ç›®ç®¡ç†å™¨æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                        }
                    } catch (e) {
                        console.error('åˆ é™¤å­é¡¹ç›®å¤±è´¥:', e);
                        alert('åˆ é™¤å­é¡¹ç›®å¤±è´¥: ' + e.message);
                    }
                }
                
                // HTMLè½¬ä¹‰
                function escapeHtml(text) {
                    if (!text) return '';
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                }
                
                // ä½¿ç”¨ UIUtils.showToastï¼ˆå·²åœ¨æ¨¡å—ä¸­åŠ è½½ï¼‰
                function showToast(message, type = 'success') {
                    if (window.UIUtils && window.UIUtils.showToast) {
                        window.UIUtils.showToast(message, type);
                    } else {
                        // é™çº§æ–¹æ¡ˆ
                        alert(message);
                    }
                }
            });
        </script>
    </div>
</body>
</html>

