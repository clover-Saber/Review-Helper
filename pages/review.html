<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>综述撰写 - 文献综述生成工具</title>
    <link rel="stylesheet" href="review.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>综述撰写</h1>
            <p>基于选定的文献自动生成文献综述报告</p>
        </header>
        
        <main>
            <section class="project-section">
                <h3>项目管理</h3>
                <div class="project-controls">
                    <div class="input-group">
                        <div id="current-project-display">当前项目：<span id="current-project-name">未选择</span></div>
                        <button id="save-project-btn">保存到项目</button>
                    </div>
                </div>
            </section>
            
            <section class="api-section">
                <div class="api-key-section">
                    <label for="api-key">DeepSeek API Key:</label>
                    <input type="password" id="api-key" placeholder="请输入您的DeepSeek API Key">
                </div>
            </section>

            <section class="research-section">
                <h3>研究主题</h3>
                <div id="research-topic-display" class="topic-display">（将自动读取主页面研究主题）</div>
            </section>

            <section class="literature-info-section">
                <h3>选定文献信息</h3>
                <div id="selected-literature-info">
                    <p>共选定 <strong id="selected-count">0</strong> 篇文献用于生成综述</p>
                    <div id="literature-summary" class="literature-summary"></div>
                </div>
            </section>

            <section class="generate-section">
                <h3>生成文献综述</h3>
                <div class="input-group">
                    <button id="generate-review-btn">开始生成综述</button>
                    <div id="generate-progress" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="generate-progress-fill"></div>
                        </div>
                        <p id="generate-progress-text">准备生成综述...</p>
                    </div>
                </div>
            </section>
            
            <section class="review-section" id="review-section" style="display: none;">
                <div class="section-header">
                    <h2>文献综述</h2>
                    <div class="review-controls">
                        <button id="export-review-btn">导出Word文档</button>
                    </div>
                </div>
                <div class="review-container">
                    <textarea id="review-content" class="review-textarea" placeholder="综述内容将显示在这里..."></textarea>
                </div>
            </section>
        </main>
        
        <footer>
            <div class="footer-controls">
                <button id="back-btn">返回主页面</button>
                <button id="confirm-btn" disabled>确认完成</button>
            </div>
        </footer>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM元素
            const currentProjectNameSpan = document.getElementById('current-project-name');
            const saveProjectBtn = document.getElementById('save-project-btn');
            const apiKeyInput = document.getElementById('api-key');
            const researchTopicDisplay = document.getElementById('research-topic-display');
            const selectedCountSpan = document.getElementById('selected-count');
            const literatureSummary = document.getElementById('literature-summary');
            const generateReviewBtn = document.getElementById('generate-review-btn');
            const generateProgress = document.getElementById('generate-progress');
            const generateProgressFill = document.getElementById('generate-progress-fill');
            const generateProgressText = document.getElementById('generate-progress-text');
            const reviewSection = document.getElementById('review-section');
            const reviewContent = document.getElementById('review-content');
            const exportReviewBtn = document.getElementById('export-review-btn');
            const confirmBtn = document.getElementById('confirm-btn');
            const backBtn = document.getElementById('back-btn');
            
            // 数据存储
            let currentProject = null;
            let selectedLiterature = []; // 模块2选定的文献列表
            let reviewText = ''; // 生成的综述内容
            
            // 初始化当前项目信息并加载数据
            initCurrentProject();
            async function initCurrentProject() {
                if (!window.electronAPI) {
                    console.error('Electron API不可用');
                    alert('Electron API不可用，请确保在Electron环境中运行');
                    return;
                }
                try {
                    const { success, currentProject: cp } = await window.electronAPI.getCurrentProject();
                    console.log('获取当前项目结果:', { success, currentProject: cp });
                    
                    if (success && cp) {
                        currentProject = cp;
                        currentProjectNameSpan.textContent = cp;
                        // 加载项目数据
                        const result = await window.electronAPI.loadProjectData(cp);
                        console.log('加载项目数据结果:', result);
                        
                        if (result.success && result.data) {
                            loadProjectData(result.data);
                        } else {
                            console.error('加载项目数据失败:', result.error || '未知错误');
                            alert('加载项目数据失败: ' + (result.error || '未知错误'));
                        }
                    } else {
                        alert('未选择项目，请在主页面先新建或打开项目。');
                    }
                } catch (e) {
                    console.error('获取当前项目失败:', e);
                    alert('获取当前项目失败: ' + e.message);
                }
            }
            
            // 加载项目数据
            function loadProjectData(data) {
                console.log('开始加载项目数据:', data);
                
                // 加载研究主题
                if (researchTopicDisplay) {
                    const topic = data.reviewDescription || data.userNeeds || data.researchTopic || '（未设置研究主题）';
                    researchTopicDisplay.textContent = topic;
                    console.log('研究主题:', topic);
                }
                
                // 加载API Key
                const apiKey = (data.config && data.config.apiKey) || data.apiKey || '';
                apiKeyInput.value = apiKey;
                console.log('API Key已加载:', apiKey ? '已设置' : '未设置');
                
                // 加载模块2筛选后的文献（只加载selected为true的）
                console.log('检查module2数据:', data.module2);
                const filteredResults = data.module2 && data.module2.filteredResults ? data.module2.filteredResults : [];
                console.log('模块2筛选结果数量:', filteredResults.length);
                
                if (Array.isArray(filteredResults)) {
                    selectedLiterature = filteredResults.filter(item => {
                        // 确保item存在且有selected属性
                        return item && item.selected === true;
                    });
                    console.log('选定的文献数量:', selectedLiterature.length);
                } else {
                    console.warn('filteredResults不是数组:', filteredResults);
                    selectedLiterature = [];
                }
                
                // 如果有已生成的综述，加载它
                if (data.module3 && data.module3.review) {
                    reviewText = data.module3.review;
                    reviewContent.value = reviewText;
                    reviewSection.style.display = 'block';
                    confirmBtn.disabled = false;
                    console.log('已加载之前生成的综述');
                } else {
                    console.log('未找到已生成的综述');
                }
                
                // 更新显示
                updateSelectedLiteratureInfo();
                
                console.log('项目数据加载完成');
            }
            
            // 更新选定文献信息
            function updateSelectedLiteratureInfo() {
                console.log('更新选定文献信息，当前文献数量:', selectedLiterature.length);
                selectedCountSpan.textContent = selectedLiterature.length;
                
                if (selectedLiterature.length === 0) {
                    literatureSummary.innerHTML = '<p class="warning">请先完成模块2的文献筛选，并至少选择一篇文献</p>';
                } else {
                    const summaryList = selectedLiterature.slice(0, 10).map((item, index) => {
                        const title = item && item.title ? item.title : '无标题';
                        return `<div class="literature-item-summary">${index + 1}. ${escapeHtml(title)}</div>`;
                    }).join('');
                    const moreText = selectedLiterature.length > 10 ? `<div class="literature-item-summary">...还有 ${selectedLiterature.length - 10} 篇文献</div>` : '';
                    literatureSummary.innerHTML = summaryList + moreText;
                }
            }
            
            // HTML转义函数
            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // 保存项目（合并保存）
            saveProjectBtn.addEventListener('click', async function() {
                const projectName = currentProject;
                if (!projectName) {
                    alert('未绑定项目，请返回主页面选择项目');
                    return;
                }
                
                const projectData = getModule3Patch();
                if (window.electronAPI) {
                    try {
                        await mergeAndSave(projectName, projectData);
                        alert(`项目 "${projectName}" 保存成功`);
                    } catch (error) {
                        console.error('保存项目失败:', error);
                        alert('保存项目失败: ' + error.message);
                    }
                }
            });
            
            // 获取模块3数据
            function getModule3Patch() {
                return {
                    module3: {
                        review: reviewContent.value,
                        timestamp: new Date().toISOString()
                    },
                    timestamp: new Date().toISOString()
                };
            }

            // 深合并保存
            async function mergeAndSave(projectName, patch) {
                const existing = await window.electronAPI.loadProjectData(projectName);
                const base = (existing && existing.success && existing.data) ? existing.data : {};
                const merged = deepMerge(base, patch || {});
                return await window.electronAPI.saveProjectData(projectName, merged);
            }

            function deepMerge(target, source) {
                if (!source || typeof source !== 'object') return target;
                const out = Array.isArray(target) ? [...target] : { ...target };
                Object.keys(source).forEach(key => {
                    const srcVal = source[key];
                    const tgtVal = out[key];
                    if (srcVal && typeof srcVal === 'object' && !Array.isArray(srcVal)) {
                        out[key] = deepMerge(tgtVal && typeof tgtVal === 'object' ? tgtVal : {}, srcVal);
                    } else {
                        out[key] = srcVal;
                    }
                });
                return out;
            }
            
            // 生成文献综述
            generateReviewBtn.addEventListener('click', async function() {
                const apiKey = apiKeyInput.value.trim();
                if (!apiKey) {
                    alert('请输入DeepSeek API Key');
                    return;
                }
                
                if (selectedLiterature.length === 0) {
                    alert('没有选定的文献，请先完成模块2的文献筛选并选择文献');
                    console.warn('选定的文献为空，无法生成综述');
                    return;
                }
                
                console.log('准备生成综述，选定的文献数量:', selectedLiterature.length);
                
                const researchTopic = researchTopicDisplay.textContent.trim();
                if (!researchTopic || researchTopic === '（将自动读取主页面研究主题）' || researchTopic === '（未设置研究主题）') {
                    alert('请先设置研究主题');
                    return;
                }
                
                console.log('研究主题:', researchTopic);
                
                // 显示进度条
                generateProgress.style.display = 'block';
                generateReviewBtn.disabled = true;
                
                try {
                    updateGenerateProgress(10, '正在准备生成综述...');
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    updateGenerateProgress(30, '正在分析选定文献...');
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    updateGenerateProgress(50, '正在调用AI生成综述...');
                    
                    // 使用大模型生成文献综述
                    const review = await generateReviewWithAI(selectedLiterature, researchTopic, apiKey);
                    
                    updateGenerateProgress(90, '正在保存综述内容...');
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    updateGenerateProgress(100, '综述生成完成！');
                    
                    // 显示综述内容
                    reviewText = review;
                    reviewContent.value = review;
                    reviewSection.style.display = 'block';
                    confirmBtn.disabled = false;
                    
                    // 自动保存
                    await autoSaveConfig();
                    
                    setTimeout(() => {
                        generateProgress.style.display = 'none';
                        generateReviewBtn.disabled = false;
                    }, 2000);
                    
                } catch (error) {
                    console.error('生成综述失败:', error);
                    generateProgress.style.display = 'none';
                    generateReviewBtn.disabled = false;
                    alert('生成综述失败: ' + error.message);
                }
            });
            
            // 使用大模型生成文献综述
            async function generateReviewWithAI(literatureList, researchTopic, apiKey) {
                // 构建文献信息摘要
                const literatureSummary = literatureList.map((item, index) => {
                    return `
文献 ${index + 1}:
- 标题: ${item.title || '无'}
- 作者: ${item.authors || '无'}
- 年份: ${item.year || '无'}
- 来源: ${item.source || '无'}
- 摘要: ${item.abstract || '无'}
- 被引次数: ${item.cited || 0}
`;
                }).join('\n');
                
                const prompt = `你是一个专业的学术文献综述撰写助手。请根据用户提供的研究主题和选定的文献，撰写一篇高质量的文献综述。

研究主题：${researchTopic}

选定的文献信息（共${literatureList.length}篇）：
${literatureSummary}

请根据以上文献，撰写一篇文献综述。满足如下要求：
- 综述内容结构清晰，逻辑严密
- 准确引用所有文献，并在引用位置标记[文献序号]
- 一段一段表述，不要分小点

请直接输出综述内容，不需要额外的说明文字。`;

                const response = await fetch('https://api.deepseek.com/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [
                            {
                                "role": "system",
                                "content": "你是一个专业的学术文献综述撰写助手。请根据用户提供的研究主题和文献信息，撰写高质量、结构化的文献综述。"
                            },
                            {
                                "role": "user",
                                "content": prompt
                            }
                        ],
                        stream: false
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API请求失败: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                const content = data.choices[0].message.content;
                
                return content;
            }
            
            // 更新生成进度
            function updateGenerateProgress(percent, text) {
                generateProgressFill.style.width = `${percent}%`;
                generateProgressText.textContent = text;
            }
            
            // 导出Word文档
            exportReviewBtn.addEventListener('click', function() {
                const content = reviewContent.value;
                if (!content || content.trim() === '') {
                    alert('没有可导出的内容');
                    return;
                }
                
                // 转义HTML特殊字符
                const escapedContent = content
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;')
                    .replace(/\n/g, '<br>');
                
                // 创建HTML格式的内容（Word可以打开HTML）
                const htmlContent = '<!DOCTYPE html>\n' +
                    '<html>\n' +
                    '<head>\n' +
                    '    <meta charset="UTF-8">\n' +
                    '    <title>文献综述</title>\n' +
                    '    <style>\n' +
                    '        body {\n' +
                    '            font-family: "Microsoft YaHei", "SimSun", serif;\n' +
                    '            line-height: 1.8;\n' +
                    '            max-width: 800px;\n' +
                    '            margin: 40px auto;\n' +
                    '            padding: 20px;\n' +
                    '        }\n' +
                    '        h1 {\n' +
                    '            text-align: center;\n' +
                    '            font-size: 24px;\n' +
                    '            margin-bottom: 30px;\n' +
                    '        }\n' +
                    '        h2 {\n' +
                    '            font-size: 20px;\n' +
                    '            margin-top: 30px;\n' +
                    '            margin-bottom: 15px;\n' +
                    '        }\n' +
                    '        p {\n' +
                    '            margin-bottom: 15px;\n' +
                    '            text-align: justify;\n' +
                    '        }\n' +
                    '        .whitespace-pre {\n' +
                    '            white-space: pre-wrap;\n' +
                    '        }\n' +
                    '    </style>\n' +
                    '</head>\n' +
                    '<body>\n' +
                    '    <h1>文献综述</h1>\n' +
                    '    <div class="whitespace-pre">' + escapedContent + '</div>\n' +
                    '</body>\n' +
                    '</html>';
                
                // 下载为HTML文件（可以在Word中打开）
                const filename = 'literature_review_' + Date.now() + '.html';
                downloadText(htmlContent, filename, 'text/html;charset=utf-8;');
            });
            
            function downloadText(text, filename, mime) {
                const blob = new Blob(['\uFEFF' + text], { type: mime });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            
            // 确认完成
            confirmBtn.addEventListener('click', async function() {
                const content = reviewContent.value.trim();
                if (!content) {
                    alert('请先生成或输入综述内容');
                    return;
                }
                
                try {
                    const projectName = currentProject;
                    if (!projectName) {
                        alert('未绑定项目，无法保存');
                        return;
                    }
                    
                    const data = getModule3Patch();
                    data.status = 'completed';
                    await mergeAndSave(projectName, data);
                    alert(`文献综述已完成并保存至项目！`);
                    window.location.href = 'index.html';
                } catch (e) {
                    console.error('保存项目失败:', e);
                    alert('保存项目失败: ' + e.message);
                }
            });
            
            // 返回主页面
            backBtn.addEventListener('click', function() {
                if (confirm('确定要返回主页面吗？未保存的更改将会丢失。')) {
                    window.location.href = 'index.html';
                }
            });
            
            // 自动保存配置（当用户编辑综述内容时）
            reviewContent.addEventListener('input', function() {
                autoSaveConfig();
            });
            
            reviewContent.addEventListener('blur', function() {
                autoSaveConfig();
            });
            
            // 自动保存配置
            async function autoSaveConfig() {
                if (!currentProject) return;
                const data = getModule3Patch();
                try {
                    await mergeAndSave(currentProject, data);
                } catch (e) {
                    console.error('自动保存失败', e);
                }
            }
            
            // 参数变更自动保存
            apiKeyInput.addEventListener('change', autoSaveConfig);
            apiKeyInput.addEventListener('blur', autoSaveConfig);
        });
        
        // Electron IPC API
        window.electronAPI = {
            saveProjectData: (projectName, data) => {
                if (window.require) {
                    const { ipcRenderer } = window.require('electron');
                    return ipcRenderer.invoke('save-project-data', projectName, data);
                }
            },
            loadProjectData: (projectName) => {
                if (window.require) {
                    const { ipcRenderer } = window.require('electron');
                    return ipcRenderer.invoke('load-project-data', projectName);
                }
            },
            getCurrentProject: () => {
                if (window.require) {
                    const { ipcRenderer } = window.require('electron');
                    return ipcRenderer.invoke('get-current-project');
                }
            }
        };
    </script>
</body>
</html>

