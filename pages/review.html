<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>综述撰写 - 文献综述生成工具</title>
    <link rel="stylesheet" href="review.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>综述撰写</h1>
            <p>基于选定的文献自动生成文献综述报告</p>
        </header>
        
        <main>
            <section class="project-section">
                <h3>项目管理</h3>
                <div class="project-controls">
                    <div class="input-group">
                        <div id="current-project-display">当前项目：<span id="current-project-name">未选择</span></div>
                        <button id="save-project-btn">保存到项目</button>
                    </div>
                </div>
            </section>
            
            <section class="api-section">
                <div class="api-key-section">
                    <label for="api-key">DeepSeek API Key:</label>
                    <input type="password" id="api-key" placeholder="请输入您的DeepSeek API Key">
                </div>
            </section>

            <section class="literature-info-section">
                <h3>选定文献信息</h3>
                <div id="selected-literature-info">
                    <p>共选定 <strong id="selected-count">0</strong> 篇文献用于生成综述</p>
                    <div id="literature-summary" class="literature-summary"></div>
                </div>
            </section>

            <section class="generate-section">
                <h3>文献综述要求</h3>
                <div class="input-group">
                    <textarea id="review-requirements" class="requirements-textarea" placeholder="请输入文献综述的要求，例如：综述内容结构清晰，逻辑严密；准确引用所有文献，并在引用位置标记[文献序号]；一段一段表述，不要分小点">
- 内容结构清晰，逻辑严密
- 准确引用所有文献，并在引用位置标记[文献序号]
- 一段一段表述，不要分小点
                    </textarea>
                </div>
                <div class="input-group">
                    <button id="generate-review-btn">开始生成综述</button>
                    <div id="generate-progress" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="generate-progress-fill"></div>
                        </div>
                        <p id="generate-progress-text">准备生成综述...</p>
                    </div>
                </div>
            </section>
            
            <section class="review-section" id="review-section" style="display: none;">
                <div class="section-header">
                    <h2>文献综述</h2>
                    <div class="review-controls">
                        <button id="export-review-btn">导出文档</button>
                    </div>
                </div>
                <div class="review-container">
                    <textarea id="review-content" class="review-textarea" placeholder="综述内容将显示在这里..."></textarea>
                </div>
                <div class="modify-section" style="margin-top: var(--spacing-lg); padding-top: var(--spacing-lg); border-top: 1px solid var(--border-color);">
                    <h3>修改文献综述</h3>
                    <div class="input-group" style="flex-direction: column; align-items: stretch;">
                        <label for="modify-requirements">修改要求：</label>
                        <textarea id="modify-requirements" class="modify-textarea" placeholder="请输入您希望如何修改这篇文献综述，例如：增加某个方面的内容、调整段落顺序、修改某些表述等..."></textarea>
                    </div>
                    <div class="input-group" style="margin-top: var(--spacing-md);">
                        <button id="modify-review-btn">开始修改</button>
                        <div id="modify-progress" style="display: none;">
                            <div class="progress-bar">
                                <div class="progress-fill" id="modify-progress-fill"></div>
                            </div>
                            <p id="modify-progress-text">准备修改综述...</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>
        
        <footer>
            <div class="footer-controls">
                <button id="back-btn">返回主页面</button>
                <button id="confirm-btn" disabled>确认完成</button>
            </div>
        </footer>
        
        <!-- Toast通知 -->
        <div id="toast" class="toast" style="display: none;">
            <div class="toast-content">
                <span class="toast-message" id="toast-message"></span>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM元素
            const currentProjectNameSpan = document.getElementById('current-project-name');
            const saveProjectBtn = document.getElementById('save-project-btn');
            const apiKeyInput = document.getElementById('api-key');
            const selectedCountSpan = document.getElementById('selected-count');
            const literatureSummary = document.getElementById('literature-summary');
            const reviewRequirementsInput = document.getElementById('review-requirements');
            const promptPreview = document.getElementById('prompt-preview');
            const generateReviewBtn = document.getElementById('generate-review-btn');
            const generateProgress = document.getElementById('generate-progress');
            const generateProgressFill = document.getElementById('generate-progress-fill');
            const generateProgressText = document.getElementById('generate-progress-text');
            const reviewSection = document.getElementById('review-section');
            const reviewContent = document.getElementById('review-content');
            const exportReviewBtn = document.getElementById('export-review-btn');
            const modifyRequirementsInput = document.getElementById('modify-requirements');
            const modifyReviewBtn = document.getElementById('modify-review-btn');
            const modifyProgress = document.getElementById('modify-progress');
            const modifyProgressFill = document.getElementById('modify-progress-fill');
            const modifyProgressText = document.getElementById('modify-progress-text');
            const confirmBtn = document.getElementById('confirm-btn');
            const backBtn = document.getElementById('back-btn');
            
            // 数据存储
            let currentProject = null;
            let selectedLiterature = []; // 模块2选定的文献列表
            let reviewText = ''; // 生成的综述内容
            
            // 显示Toast通知
            function showToast(message, type = 'success') {
                const toast = document.getElementById('toast');
                const toastMessage = document.getElementById('toast-message');
                
                if (!toast || !toastMessage) return;
                
                // 设置消息
                toastMessage.textContent = message;
                
                // 根据类型设置样式
                if (type === 'success') {
                    toast.style.background = 'linear-gradient(135deg, var(--success-color) 0%, #059669 100%)';
                } else if (type === 'error') {
                    toast.style.background = 'linear-gradient(135deg, var(--error-color) 0%, #dc2626 100%)';
                }
                
                // 显示toast
                toast.style.display = 'block';
                toast.style.opacity = '0';
                
                // 触发动画
                setTimeout(() => {
                    toast.style.opacity = '1';
                }, 10);
                
                // 3秒后自动隐藏
                setTimeout(() => {
                    toast.style.opacity = '0';
                    setTimeout(() => {
                        toast.style.display = 'none';
                    }, 300);
                }, 3000);
            }
            
            // 初始化当前项目信息并加载数据
            initCurrentProject();
            async function initCurrentProject() {
                if (!window.electronAPI) {
                    console.error('Electron API不可用');
                    showToast('Electron API不可用，请确保在Electron环境中运行', 'error');
                    return;
                }
                try {
                    const { success, currentProject: cp } = await window.electronAPI.getCurrentProject();
                    console.log('获取当前项目结果:', { success, currentProject: cp });
                    
                    if (success && cp) {
                        currentProject = cp;
                        currentProjectNameSpan.textContent = cp;
                        // 加载项目数据
                        const result = await window.electronAPI.loadProjectData(cp);
                        console.log('加载项目数据结果:', result);
                        
                        if (result.success && result.data) {
                            loadProjectData(result.data);
                        } else {
                            console.error('加载项目数据失败:', result.error || '未知错误');
                            showToast('加载项目数据失败: ' + (result.error || '未知错误'), 'error');
                        }
                    } else {
                        showToast('未选择项目，请在主页面先新建或打开项目', 'error');
                    }
                } catch (e) {
                    console.error('获取当前项目失败:', e);
                    showToast('获取当前项目失败: ' + e.message, 'error');
                }
            }
            
            // 加载项目数据
            function loadProjectData(data) {
                console.log('开始加载项目数据:', data);
                
                // 加载API Key
                const apiKey = (data.config && data.config.apiKey) || data.apiKey || '';
                apiKeyInput.value = apiKey;
                console.log('API Key已加载:', apiKey ? '已设置' : '未设置');
                
                // 加载模块2筛选后的文献（只加载selected为true的）
                console.log('检查module2数据:', data.module2);
                const filteredResults = data.module2 && data.module2.filteredResults ? data.module2.filteredResults : [];
                console.log('模块2筛选结果数量:', filteredResults.length);
                
                if (Array.isArray(filteredResults)) {
                    selectedLiterature = filteredResults.filter(item => {
                        // 确保item存在且有selected属性
                        return item && item.selected === true;
                    });
                    console.log('选定的文献数量:', selectedLiterature.length);
                } else {
                    console.warn('filteredResults不是数组:', filteredResults);
                    selectedLiterature = [];
                }
                
                // 如果有已生成的综述，加载它
                if (data.module3 && data.module3.review) {
                    reviewText = data.module3.review;
                    reviewContent.value = reviewText;
                    reviewSection.style.display = 'block';
                    confirmBtn.disabled = false;
                    console.log('已加载之前生成的综述');
                } else {
                    console.log('未找到已生成的综述');
                }
                
                // 更新显示
                updateSelectedLiteratureInfo();
                
                // 如果有保存的要求，加载它
                if (data.module3 && data.module3.requirements) {
                    reviewRequirementsInput.value = data.module3.requirements;
                }
                
                // 更新提示词预览
                updatePromptPreview();
                
                console.log('项目数据加载完成');
            }
            
            // 更新提示词预览
            function updatePromptPreview() {
                if (selectedLiterature.length === 0) {
                    promptPreview.value = '请先确保已从模块2选择文献';
                    return;
                }
                
                // 构建文献信息摘要
                const literatureSummary = selectedLiterature.map((item, index) => {
                    return `
文献 ${index + 1}:
- 标题: ${item.title || '无'}
- 作者: ${item.authors || '无'}
- 年份: ${item.year || '无'}
- 来源: ${item.source || '无'}
- 摘要: ${item.abstract || '无'}
- 被引次数: ${item.cited || 0}
`;
                }).join('\n');
                
                // 获取用户输入的要求，并清理格式
                let requirements = reviewRequirementsInput.value.trim();
                
                // 如果用户输入包含"文献综述要求如下："等前缀，去掉它们
                requirements = requirements.replace(/^文献综述要求如下[：:]\s*/i, '');
                requirements = requirements.replace(/^请根据以上文献[，,]撰写一篇文献综述[。.]满足如下要求[：:]\s*/i, '');
                
                // 如果用户输入为空，使用默认要求
                if (!requirements) {
                    requirements = '内容结构清晰，逻辑严密\n准确引用所有文献，并在引用位置标记[文献序号]\n一段一段表述，不要分小点';
                }
                
                // 构建完整提示词
                const fullPrompt = `你是一个专业的学术文献综述撰写助手。请根据选定的文献，撰写一篇高质量的文献综述。

选定的文献信息（共${selectedLiterature.length}篇）：
${literatureSummary}

请根据以上文献，撰写一篇文献综述。满足如下要求：
${requirements}

请直接输出综述内容，不需要额外的说明文字。`;
                
                promptPreview.value = fullPrompt;
            }
            
            // 监听文献综述要求输入变化
            reviewRequirementsInput.addEventListener('input', function() {
                updatePromptPreview();
            });
            
            // 更新选定文献信息
            function updateSelectedLiteratureInfo() {
                console.log('更新选定文献信息，当前文献数量:', selectedLiterature.length);
                selectedCountSpan.textContent = selectedLiterature.length;
                
                if (selectedLiterature.length === 0) {
                    literatureSummary.innerHTML = '<p class="warning">请先完成模块2的文献筛选，并至少选择一篇文献</p>';
                } else {
                    // 显示所有选定的文献信息
                    const summaryList = selectedLiterature.map((item, index) => {
                        const title = item && item.title ? item.title : '无标题';
                        const authors = item && item.authors ? item.authors : '';
                        const year = item && item.year ? item.year : '';
                        const source = item && item.source ? item.source : '';
                        return `
                            <div class="literature-item-summary">
                                <div class="literature-item-title">${index + 1}. ${escapeHtml(title)}</div>
                                ${authors || year || source ? `
                                <div class="literature-item-meta">
                                    ${authors ? `<span class="meta-authors">作者: ${escapeHtml(authors)}</span>` : ''}
                                    ${year ? `<span class="meta-year">年份: ${escapeHtml(year)}</span>` : ''}
                                    ${source ? `<span class="meta-source">来源: ${escapeHtml(source)}</span>` : ''}
                                </div>` : ''}
                            </div>
                        `;
                    }).join('');
                    literatureSummary.innerHTML = summaryList;
                }
                
                // 更新提示词预览
                updatePromptPreview();
            }
            
            // HTML转义函数
            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // 保存项目（合并保存，避免覆盖旧字段）
            saveProjectBtn.addEventListener('click', async function() {
                const projectName = currentProject;
                if (!projectName) {
                    showToast('未绑定项目，请返回主页面选择项目', 'error');
                    return;
                }
                
                const projectData = getModule3Patch();
                if (window.electronAPI) {
                    try {
                        await mergeAndSave(projectName, projectData);
                        showToast(`项目 "${projectName}" 保存成功`);
                    } catch (error) {
                        console.error('保存项目失败:', error);
                        showToast('保存项目失败: ' + error.message, 'error');
                    }
                }
            });
            
            // 获取模块3数据
            function getModule3Patch() {
                return {
                    module3: {
                        review: reviewContent.value,
                        requirements: reviewRequirementsInput.value.trim(),
                        timestamp: new Date().toISOString()
                    },
                    timestamp: new Date().toISOString()
                };
            }

            // 深合并保存
            async function mergeAndSave(projectName, patch) {
                const existing = await window.electronAPI.loadProjectData(projectName);
                const base = (existing && existing.success && existing.data) ? existing.data : {};
                const merged = deepMerge(base, patch || {});
                return await window.electronAPI.saveProjectData(projectName, merged);
            }

            function deepMerge(target, source) {
                if (!source || typeof source !== 'object') return target;
                const out = Array.isArray(target) ? [...target] : { ...target };
                Object.keys(source).forEach(key => {
                    const srcVal = source[key];
                    const tgtVal = out[key];
                    if (srcVal && typeof srcVal === 'object' && !Array.isArray(srcVal)) {
                        out[key] = deepMerge(tgtVal && typeof tgtVal === 'object' ? tgtVal : {}, srcVal);
                    } else {
                        out[key] = srcVal;
                    }
                });
                return out;
            }
            
            // 生成文献综述
            generateReviewBtn.addEventListener('click', async function() {
                const apiKey = apiKeyInput.value.trim();
                if (!apiKey) {
                    showToast('请输入DeepSeek API Key', 'error');
                    return;
                }
                
                if (selectedLiterature.length === 0) {
                    showToast('没有选定的文献，请先完成模块2的文献筛选并选择文献', 'error');
                    console.warn('选定的文献为空，无法生成综述');
                    return;
                }
                
                console.log('准备生成综述，选定的文献数量:', selectedLiterature.length);
                
                // 显示进度条
                generateProgress.style.display = 'block';
                generateReviewBtn.disabled = true;
                
                try {
                    updateGenerateProgress(10, '正在准备生成综述...');
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    updateGenerateProgress(30, '正在分析选定文献...');
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    updateGenerateProgress(50, '正在调用AI生成综述...');
                    
                    // 使用大模型生成文献综述
                    const review = await generateReviewWithAI(selectedLiterature, apiKey);
                    
                    updateGenerateProgress(90, '正在保存综述内容...');
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    updateGenerateProgress(100, '综述生成完成！');
                    
                    // 显示综述内容
                    reviewText = review;
                    reviewContent.value = review;
                    reviewSection.style.display = 'block';
                    confirmBtn.disabled = false;
                    
                    // 自动保存
                    await autoSaveConfig();
                    
                    setTimeout(() => {
                        generateProgress.style.display = 'none';
                        generateReviewBtn.disabled = false;
                    }, 2000);
                    
                } catch (error) {
                    console.error('生成综述失败:', error);
                    generateProgress.style.display = 'none';
                    generateReviewBtn.disabled = false;
                    showToast('生成综述失败: ' + error.message, 'error');
                }
            });
            
            // 使用大模型生成文献综述
            async function generateReviewWithAI(literatureList, apiKey) {
                // 构建文献信息摘要
                const literatureSummary = literatureList.map((item, index) => {
                    return `
文献 ${index + 1}:
- 标题: ${item.title || '无'}
- 作者: ${item.authors || '无'}
- 年份: ${item.year || '无'}
- 来源: ${item.source || '无'}
- 摘要: ${item.abstract || '无'}
- 被引次数: ${item.cited || 0}
`;
                }).join('\n');
                
                // 获取用户输入的要求，并清理格式
                let requirements = reviewRequirementsInput.value.trim();
                
                // 如果用户输入包含"文献综述要求如下："等前缀，去掉它们
                requirements = requirements.replace(/^文献综述要求如下[：:]\s*/i, '');
                requirements = requirements.replace(/^请根据以上文献[，,]撰写一篇文献综述[。.]满足如下要求[：:]\s*/i, '');
                
                // 如果用户输入为空，使用默认要求
                if (!requirements) {
                    requirements = '内容结构清晰，逻辑严密\n准确引用所有文献，并在引用位置标记[文献序号]\n一段一段表述，不要分小点';
                }
                
                // 构建完整提示词（与预览框中的一致）
                const prompt = `你是一个专业的学术文献综述撰写助手。请根据选定的文献，撰写一篇高质量的文献综述。

选定的文献信息（共${literatureList.length}篇）：
${literatureSummary}

请根据以上文献，撰写一篇文献综述。满足如下要求：
${requirements}

请直接输出综述内容，不需要额外的说明文字。`;

                const response = await fetch('https://api.deepseek.com/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [
                            {
                                "role": "system",
                                "content": "你是一个专业的学术文献综述撰写助手。请根据用户提供的研究主题和文献信息，撰写高质量、结构化的文献综述。"
                            },
                            {
                                "role": "user",
                                "content": prompt
                            }
                        ],
                        stream: false
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API请求失败: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                const content = data.choices[0].message.content;
                
                return content;
            }
            
            // 更新生成进度
            function updateGenerateProgress(percent, text) {
                generateProgressFill.style.width = `${percent}%`;
                generateProgressText.textContent = text;
            }
            
            // 修改文献综述
            modifyReviewBtn.addEventListener('click', async function() {
                const currentReview = reviewContent.value.trim();
                
                if (!currentReview) {
                    showToast('请先生成文献综述', 'error');
                    return;
                }
                
                const modifyRequirements = modifyRequirementsInput.value.trim();
                if (!modifyRequirements) {
                    showToast('请输入修改要求', 'error');
                    return;
                }
                
                const apiKey = apiKeyInput.value.trim();
                if (!apiKey) {
                    showToast('请先输入DeepSeek API Key', 'error');
                    return;
                }
                
                modifyReviewBtn.disabled = true;
                modifyProgress.style.display = 'block';
                
                try {
                    updateModifyProgress(10, '正在准备修改综述...');
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    updateModifyProgress(30, '正在调用AI修改综述...');
                    
                    // 使用大模型修改文献综述
                    const modifiedReview = await modifyReviewWithAI(currentReview, modifyRequirements, apiKey);
                    
                    updateModifyProgress(90, '正在保存修改后的综述...');
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    updateModifyProgress(100, '✅ 综述修改完成！已自动保存');
                    
                    // 显示修改后的综述内容
                    reviewText = modifiedReview;
                    reviewContent.value = modifiedReview;
                    
                    // 自动保存
                    await autoSaveConfig();
                    
                    // 显示成功提示
                    showToast('✅ 综述修改完成！已自动保存', 'success');
                    
                    // 清空修改要求输入框
                    modifyRequirementsInput.value = '';
                    
                    // 进度条保持显示，不自动隐藏
                    modifyReviewBtn.disabled = false;
                    
                } catch (error) {
                    console.error('修改综述失败:', error);
                    modifyProgress.style.display = 'none';
                    modifyReviewBtn.disabled = false;
                    showToast('修改综述失败: ' + error.message, 'error');
                }
            });
            
            // 使用大模型修改文献综述
            async function modifyReviewWithAI(currentReview, modifyRequirements, apiKey) {
                // 构建修改提示词（只发送当前综述和修改要求）
                const prompt = `你是一个专业的学术文献综述修改助手。请根据用户的要求，对以下文献综述进行修改。

当前文献综述内容：
${currentReview}

用户修改要求：
${modifyRequirements}

请根据用户的要求对文献综述进行修改，保持学术风格和引用格式（如[文献序号]）。请直接输出修改后的完整综述内容，不要额外的说明文字。`;

                const response = await fetch('https://api.deepseek.com/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [
                            {
                                "role": "system",
                                "content": "你是一个专业的学术文献综述修改助手。请根据用户的要求，对文献综述进行精准修改，保持学术风格和格式。"
                            },
                            {
                                "role": "user",
                                "content": prompt
                            }
                        ],
                        stream: false
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API请求失败: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                const content = data.choices[0].message.content;
                
                return content.trim();
            }
            
            // 更新修改进度
            function updateModifyProgress(percent, text) {
                modifyProgressFill.style.width = `${percent}%`;
                modifyProgressText.textContent = text;
            }
            
            // 导出Word文档
            exportReviewBtn.addEventListener('click', function() {
                const content = reviewContent.value;
                if (!content || content.trim() === '') {
                    showToast('没有可导出的内容', 'error');
                    return;
                }
                
                // 转义HTML特殊字符
                const escapedContent = content
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;')
                    .replace(/\n/g, '<br>');
                
                // 创建HTML格式的内容（Word可以打开HTML）
                const htmlContent = '<!DOCTYPE html>\n' +
                    '<html>\n' +
                    '<head>\n' +
                    '    <meta charset="UTF-8">\n' +
                    '    <title>文献综述</title>\n' +
                    '    <style>\n' +
                    '        body {\n' +
                    '            font-family: "Microsoft YaHei", "SimSun", serif;\n' +
                    '            line-height: 1.8;\n' +
                    '            max-width: 800px;\n' +
                    '            margin: 40px auto;\n' +
                    '            padding: 20px;\n' +
                    '        }\n' +
                    '        h1 {\n' +
                    '            text-align: center;\n' +
                    '            font-size: 24px;\n' +
                    '            margin-bottom: 30px;\n' +
                    '        }\n' +
                    '        h2 {\n' +
                    '            font-size: 20px;\n' +
                    '            margin-top: 30px;\n' +
                    '            margin-bottom: 15px;\n' +
                    '        }\n' +
                    '        p {\n' +
                    '            margin-bottom: 15px;\n' +
                    '            text-align: justify;\n' +
                    '        }\n' +
                    '        .whitespace-pre {\n' +
                    '            white-space: pre-wrap;\n' +
                    '        }\n' +
                    '    </style>\n' +
                    '</head>\n' +
                    '<body>\n' +
                    '    <h1>文献综述</h1>\n' +
                    '    <div class="whitespace-pre">' + escapedContent + '</div>\n' +
                    '</body>\n' +
                    '</html>';
                
                // 下载为HTML文件（可以在Word中打开）
                const filename = 'literature_review_' + Date.now() + '.html';
                downloadText(htmlContent, filename, 'text/html;charset=utf-8;');
            });
            
            function downloadText(text, filename, mime) {
                const blob = new Blob(['\uFEFF' + text], { type: mime });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            
            // 确认完成
            confirmBtn.addEventListener('click', async function() {
                const content = reviewContent.value.trim();
                if (!content) {
                    showToast('请先生成或输入综述内容', 'error');
                    return;
                }
                
                try {
                    const projectName = currentProject;
                    if (!projectName) {
                        showToast('未绑定项目，无法保存', 'error');
                        return;
                    }
                    
                    const data = getModule3Patch();
                    data.status = 'completed';
                    await mergeAndSave(projectName, data);
                    showToast(`文献综述已完成并保存至项目！`);
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1500);
                } catch (e) {
                    console.error('保存项目失败:', e);
                    showToast('保存项目失败: ' + e.message, 'error');
                }
            });
            
            // 返回主页面
            backBtn.addEventListener('click', function() {
                if (confirm('确定要返回主页面吗？未保存的更改将会丢失。')) {
                    window.location.href = 'index.html';
                }
            });
            
            // 自动保存配置（当用户编辑综述内容时）
            reviewContent.addEventListener('input', function() {
                autoSaveConfig();
            });
            
            reviewContent.addEventListener('blur', function() {
                autoSaveConfig();
            });
            
            // 自动保存配置
            async function autoSaveConfig() {
                if (!currentProject) return;
                const data = getModule3Patch();
                try {
                    await mergeAndSave(currentProject, data);
                } catch (e) {
                    console.error('自动保存失败', e);
                }
            }
            
            // 参数变更自动保存
            apiKeyInput.addEventListener('change', autoSaveConfig);
            apiKeyInput.addEventListener('blur', autoSaveConfig);
        });
        
        // Electron IPC API
        window.electronAPI = {
            saveProjectData: (projectName, data) => {
                if (window.require) {
                    const { ipcRenderer } = window.require('electron');
                    return ipcRenderer.invoke('save-project-data', projectName, data);
                }
            },
            loadProjectData: (projectName) => {
                if (window.require) {
                    const { ipcRenderer } = window.require('electron');
                    return ipcRenderer.invoke('load-project-data', projectName);
                }
            },
            getCurrentProject: () => {
                if (window.require) {
                    const { ipcRenderer } = window.require('electron');
                    return ipcRenderer.invoke('get-current-project');
                }
            }
        };
    </script>
</body>
</html>

